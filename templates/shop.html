{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Hero Section -->
  <section class="hero-section position-relative overflow-hidden" style="min-height: 400px;">
    <div class="hero-background"></div>
    <div class="hero-overlay"></div>
    <div class="container position-relative">
      <div class="row align-items-center" style="min-height: 400px;">
        <div class="col-lg-8 mx-auto text-center text-white" data-aos="fade-up">
          <div class="hero-content">
            <h1 class="display-4 fw-bold mb-4">Shop Home Service Supplies</h1>
            <p class="lead mb-4">Find all the products you need for your home services from nearby verified shops</p>
            
            <!-- Search Bar -->
            <div class="search-container mb-4">
              <div class="row justify-content-center">
                <div class="col-lg-8">
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-0">
                      <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-0 shadow-sm" id="productSearch" placeholder="Search for products (e.g., wires, pipes, tools, paint...)">
                    <button class="btn btn-primary px-4" type="button" id="searchBtn">
                      <i class="fas fa-search me-2"></i>Search
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Shop Category Filters (Shop Registration Categories) -->
            <div class="mb-3">
              <p class="text-white-50 mb-2 small">Browse shops by category:</p>
              <div class="d-flex flex-wrap justify-content-center gap-2">
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter active" data-shop-category="">
                  <i class="fas fa-store me-1"></i>All Shops
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="hardware">
                  <i class="fas fa-tools me-1"></i>Hardware
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="electricals">
                  <i class="fas fa-bolt me-1"></i>Electricals
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="plumbing">
                  <i class="fas fa-wrench me-1"></i>Plumbing
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="paint">
                  <i class="fas fa-paint-brush me-1"></i>Paint & Supplies
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="tools">
                  <i class="fas fa-hammer me-1"></i>Tools
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill shop-category-filter" data-shop-category="general">
                  <i class="fas fa-shopping-bag me-1"></i>General Store
                </button>
              </div>
            </div>
            
            <!-- Product Category Filters (for search) -->
            <div class="mt-3">
              <p class="text-white-50 mb-2 small">Filter products by type:</p>
              <div class="d-flex flex-wrap justify-content-center gap-2">
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter active" data-category="">
                  All Products
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter" data-category="wires">
                  Wires & Cables
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter" data-category="pipes">
                  Pipes & Fittings
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter" data-category="tools">
                  Tools
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter" data-category="paint">
                  Paint & Supplies
                </button>
                <button class="btn btn-outline-light btn-sm rounded-pill category-filter" data-category="hardware">
                  Hardware
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Browse Shops by Category Section -->
  <section class="py-5 bg-white" id="browseShopsSection">
    <div class="container">
      <div class="row mb-4">
        <div class="col-12 text-center">
          <h2 class="text-primary mb-3">Browse Shops by Category</h2>
          <p class="text-muted">Select a shop category to see all available shops in that category</p>
        </div>
      </div>
      
      <!-- Shop Category Cards -->
      <div id="shopCategoriesList" class="row g-4">
        <!-- Shop categories will be loaded here -->
      </div>
      
      <!-- Shops List -->
      <div id="browseShopsList" class="row g-4 mt-4 d-none">
        <!-- Shops will be populated here -->
      </div>
    </div>
  </section>

  <!-- Results Section -->
  <section class="py-5 bg-light d-none" id="searchResultsSection">
    <div class="container">
      <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <h2 class="text-primary mb-0" id="resultsTitle">Search Results</h2>
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-primary" id="cartBtn" data-bs-toggle="modal" data-bs-target="#cartModal">
              <i class="fas fa-shopping-cart me-2"></i>
              Cart <span class="badge bg-primary ms-2" id="cartBadge">0</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="text-center py-5 d-none">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Searching for products...</p>
      </div>

      <!-- No Results -->
      <div id="noResults" class="text-center py-5 d-none">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No shops found</h4>
        <p class="text-muted">Try searching for different products</p>
      </div>

      <!-- Recommendations -->
      <div class="row mb-4 d-none" id="recommendationsWrapper">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary">
                  <i class="fas fa-thumbs-up me-2"></i>Recommended for you
                </h5>
                <small class="text-muted" id="recommendationsHint">Based on your recent browsing</small>
              </div>
              <div id="recommendationsList" class="d-flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Shops with Products -->
      <div id="shopsList" class="row g-4">
        <!-- Shops will be populated here -->
      </div>
    </div>
  </section>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Shopping Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="cartItems">
          <!-- Cart items will be loaded here -->
        </div>
        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
          <h5 class="mb-0">Total: <span id="cartTotal">₹0</span></h5>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
        <button type="button" class="btn btn-primary" id="checkoutBtn" disabled>Proceed to Checkout</button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="checkoutContent">
          <!-- Checkout form will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let userLocation = null;
let currentSearchQuery = '';
let currentCategory = '';
let currentShopCategory = '';
let latestShopResults = [];
const LOCAL_CART_KEY = 'hofixx_cart';
const RECENT_CATEGORIES_KEY = 'hofixx_recent_categories';
let isSyncingLocalCart = false;

function getLocalCart() {
  try {
    if (isSyncingLocalCart) return { items: [] };
    return JSON.parse(localStorage.getItem(LOCAL_CART_KEY)) || { items: [] };
  } catch (error) {
    console.warn('Failed to parse local cart', error);
    return { items: [] };
  }
}

function saveLocalCart(cart) {
  try {
    localStorage.setItem(LOCAL_CART_KEY, JSON.stringify(cart));
  } catch (error) {
    console.warn('Failed to save local cart', error);
  }
}

function clearLocalCart() {
  localStorage.removeItem(LOCAL_CART_KEY);
}

function updateCartBadge(count) {
  const badge = document.getElementById('cartBadge');
  if (badge) {
    badge.textContent = count;
  }
}

function getRecommendationStats() {
  try {
    return JSON.parse(localStorage.getItem(RECENT_CATEGORIES_KEY)) || {};
  } catch (error) {
    return {};
  }
}

function recordRecommendationsFromShops(shops) {
  if (!Array.isArray(shops)) return;
  const stats = getRecommendationStats();
  shops.forEach(shopData => {
    if (!shopData || !shopData.shop) return;
    let categories = shopData.shop.category;
    if (!categories) return;
    if (!Array.isArray(categories)) {
      categories = [categories];
    }
    categories.forEach(cat => {
      if (!cat) return;
      stats[cat] = (stats[cat] || 0) + 1;
    });
  });
  try {
    localStorage.setItem(RECENT_CATEGORIES_KEY, JSON.stringify(stats));
  } catch (error) {
    console.warn('Failed to save recommendations', error);
  }
  renderRecommendations();
}

function getTopRecommendations(limit = 6) {
  const stats = getRecommendationStats();
  return Object.entries(stats)
    .sort((a, b) => b[1] - a[1])
    .slice(0, limit)
    .map(([category, score]) => ({ category, score }));
}

function renderRecommendations() {
  const wrapper = document.getElementById('recommendationsWrapper');
  const list = document.getElementById('recommendationsList');
  if (!wrapper || !list) return;

  const recommendations = getTopRecommendations();
  if (!recommendations.length) {
    wrapper.classList.add('d-none');
    return;
  }

  wrapper.classList.remove('d-none');
  const chips = recommendations.map(({ category, score }) => {
    const info = shopCategories[category] || { icon: 'fas fa-store', label: category, color: 'secondary' };
    return `
      <button class="btn btn-outline-${info.color || 'secondary'} btn-sm rounded-pill" onclick="browseShopsByCategory('${category}')">
        <i class="${info.icon} me-2"></i>${info.label || category} <span class="badge bg-${info.color || 'secondary'} ms-2">${score}</span>
      </button>
    `;
  }).join('');
  list.innerHTML = chips;
}

function findProductDetails(shopId, productId) {
  const shopData = latestShopResults.find(s => s.shop && s.shop.id === shopId);
  if (!shopData) return {};
  const product = (shopData.products || []).find(p => p.id === productId);
  return { shop: shopData.shop, product };
}

function addToLocalCart(product, shop) {
  if (!product || !shop) return;
  const cart = getLocalCart();
  const existing = cart.items.find(item => item.product_id === product.id && item.shop_id === shop.id);
  if (existing) {
    existing.quantity += 1;
  } else {
    cart.items.push({
      product_id: product.id,
      product_name: product.name,
      price: product.price,
      quantity: 1,
      shop_id: shop.id,
      shop_name: shop.name,
      product_image: product.image_url || null,
      shop_image: shop.image_url || null
    });
  }
  saveLocalCart(cart);
  updateCartBadge(cart.items.length);
  renderCart(cart.items, { isLocal: true });
}

function removeLocalCartItem(productId, shopId) {
  const cart = getLocalCart();
  cart.items = cart.items.filter(item => !(item.product_id === productId && item.shop_id === shopId));
  saveLocalCart(cart);
  updateCartBadge(cart.items.length);
  renderCart(cart.items, { isLocal: true });
}

function updateLocalCartItem(productId, shopId, quantity) {
  const cart = getLocalCart();
  const target = cart.items.find(item => item.product_id === productId && item.shop_id === shopId);
  if (!target) return;
  target.quantity = quantity;
  if (target.quantity <= 0) {
    cart.items = cart.items.filter(item => !(item.product_id === productId && item.shop_id === shopId));
  }
  saveLocalCart(cart);
  updateCartBadge(cart.items.length);
  renderCart(cart.items, { isLocal: true });
}

async function syncLocalCartToServer() {
  const token = getAuthToken();
  if (!token) return;
  const localCart = getLocalCart();
  if (!localCart.items.length) return;
  isSyncingLocalCart = true;
  try {
    for (const item of localCart.items) {
      await fetch('/api/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          product_id: item.product_id,
          quantity: item.quantity
        })
      }).catch(() => null);
    }
    clearLocalCart();
  } finally {
    isSyncingLocalCart = false;
  }
}

// Accessibility: blur focused elements before modals hide to avoid aria-hidden conflicts
['cartModal', 'checkoutModal'].forEach(modalId => {
  const modalEl = document.getElementById(modalId);
  if (modalEl) {
    modalEl.addEventListener('hide.bs.modal', () => {
      const activeEl = document.activeElement;
      if (activeEl && modalEl.contains(activeEl) && typeof activeEl.blur === 'function') {
        activeEl.blur();
      }
    });
  }
});

// Shop category icons and labels
const shopCategories = {
  'hardware': { icon: 'fas fa-tools', label: 'Hardware', color: 'primary' },
  'electricals': { icon: 'fas fa-bolt', label: 'Electricals', color: 'warning' },
  'plumbing': { icon: 'fas fa-wrench', label: 'Plumbing', color: 'info' },
  'paint': { icon: 'fas fa-paint-brush', label: 'Paint & Supplies', color: 'success' },
  'tools': { icon: 'fas fa-hammer', label: 'Tools', color: 'danger' },
  'general': { icon: 'fas fa-shopping-bag', label: 'General Store', color: 'secondary' }
};

// Get user location
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      userLocation = {
        lat: position.coords.latitude,
        lon: position.coords.longitude
      };
      console.log('User location:', userLocation);
      console.log('User coordinates:', `(${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)})`);
      loadShopCategories();
    },
    (error) => {
      console.error('Error getting location:', error);
      // Default to Delhi if location not available
      userLocation = { lat: 28.6139, lon: 77.2090 };
      loadShopCategories();
    }
  );
} else {
  userLocation = { lat: 28.6139, lon: 77.2090 };
  loadShopCategories();
}

// Load shop categories on page load
function loadShopCategories() {
  const params = new URLSearchParams();
  if (userLocation) {
    params.append('lat', userLocation.lat);
    params.append('lon', userLocation.lon);
  }
  
  // Load all shops to get category counts
  fetch(`/api/shop/browse?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
      renderShopCategories(data);
    })
    .catch(error => {
      console.error('Error loading shop categories:', error);
    });
}

// Render shop category cards
function renderShopCategories(data) {
  const categoriesList = document.getElementById('shopCategoriesList');
  
  // Count shops by category
  const categoryCounts = {};
  if (data.shops) {
    data.shops.forEach(shop => {
      // Handle category as array (multiple categories) or string (single category for backward compatibility)
      const categories = Array.isArray(shop.category) ? shop.category : [shop.category || 'general'];
      categories.forEach(cat => {
        if (cat && cat.trim()) {
          categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
        }
      });
    });
  }
  
  // Create category cards
  const categoriesHtml = Object.keys(shopCategories).map(cat => {
    const catInfo = shopCategories[cat];
    const count = categoryCounts[cat] || 0;
    return `
      <div class="col-md-4 col-lg-3 mb-4">
        <a href="/shop/category/${cat}" class="text-decoration-none">
          <div class="card h-100 shadow-sm hover-lift cursor-pointer">
            <div class="card-body text-center p-4">
              <div class="mb-3">
                <i class="${catInfo.icon} fa-3x text-${catInfo.color}"></i>
              </div>
              <h5 class="card-title text-dark">${catInfo.label}</h5>
              <p class="text-muted mb-0">${count} shop${count !== 1 ? 's' : ''} available</p>
            </div>
          </div>
        </a>
      </div>
    `;
  }).join('');
  
  categoriesList.innerHTML = categoriesHtml;
}

// Browse shops by category
function browseShopsByCategory(shopCategory) {
  currentShopCategory = shopCategory;
  
  // Hide search results, show browse results
  document.getElementById('searchResultsSection').classList.add('d-none');
  document.getElementById('browseShopsList').classList.remove('d-none');
  
  const params = new URLSearchParams({
    shop_category: shopCategory
  });
  
  if (userLocation) {
    params.append('lat', userLocation.lat);
    params.append('lon', userLocation.lon);
  }
  
  fetch(`/api/shop/browse?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
      if (data.shops && data.shops.length > 0) {
        renderBrowseShops(data.shops, shopCategory);
      } else {
        document.getElementById('browseShopsList').innerHTML = `
          <div class="col-12 text-center py-5">
            <p class="text-muted">No shops found in this category</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error browsing shops:', error);
    });
}

// Render shops for browsing
function renderBrowseShops(shops, category) {
  const shopsList = document.getElementById('browseShopsList');
  const catInfo = shopCategories[category] || { label: category, icon: 'fas fa-store' };
  
  shopsList.innerHTML = `
    <div class="col-12 mb-3">
      <h4 class="text-primary">
        <i class="${catInfo.icon} me-2"></i>${catInfo.label} Shops (${shops.length})
      </h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="showAllCategories()">
        <i class="fas fa-arrow-left me-1"></i>Back to Categories
      </button>
    </div>
  `;
  
  shops.forEach(shop => {
    const shopCard = document.createElement('div');
    shopCard.className = 'col-md-6 col-lg-4';
    shopCard.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-start mb-3">
            ${shop.image_url ? `<img src="${shop.image_url}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">` : '<div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;"><i class="fas fa-store fa-2x text-muted"></i></div>'}
            <div class="flex-grow-1">
              <h5 class="card-title mb-1">
                ${shop.name}
                ${shop.is_verified ? '<i class="fas fa-check-circle text-success ms-1" title="Verified"></i>' : ''}
              </h5>
              <p class="text-muted small mb-1">
                <i class="fas fa-map-marker-alt me-1"></i>${shop.address}
              </p>
              ${shop.distance ? `<p class="text-primary small mb-2"><i class="fas fa-route me-1"></i>${shop.distance} km away</p>` : ''}
              <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-star me-1"></i>${shop.rating.toFixed(1)}
                </span>
                <span class="badge bg-info">
                  <i class="fas fa-box me-1"></i>${shop.products_count} products
                </span>
              </div>
            </div>
          </div>
          ${shop.description ? `<p class="text-muted small mb-3">${shop.description}</p>` : ''}
          <button class="btn btn-primary btn-sm w-100" onclick="viewShopProducts('${shop.id}', '${shop.name}')">
            <i class="fas fa-eye me-1"></i>View Products
          </button>
        </div>
      </div>
    `;
    shopsList.appendChild(shopCard);
  });
}

// Show all categories again
function showAllCategories() {
  document.getElementById('browseShopsList').classList.add('d-none');
  document.getElementById('browseShopsList').innerHTML = '';
  currentShopCategory = '';
}

// View shop products
function viewShopProducts(shopId, shopName) {
  // Scroll to search section and trigger a search that will show this shop's products
  document.getElementById('searchResultsSection').classList.remove('d-none');
  document.getElementById('productSearch').value = shopName;
  document.getElementById('productSearch').focus();
  document.getElementById('searchResultsSection').scrollIntoView({ behavior: 'smooth' });
}

function searchProducts(query, category = '') {
  if (!query || query.trim() === '') {
    document.getElementById('shopsList').innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">Please enter a search term</p></div>';
    return;
  }

  currentSearchQuery = query;
  currentCategory = category;

  // Show search results section, hide browse section
  document.getElementById('searchResultsSection').classList.remove('d-none');
  document.getElementById('browseShopsSection').classList.add('d-none');

  document.getElementById('loadingState').classList.remove('d-none');
  document.getElementById('noResults').classList.add('d-none');
  document.getElementById('shopsList').innerHTML = '';

  const params = new URLSearchParams({
    q: query,
    category: category
  });

  if (userLocation) {
    params.append('lat', userLocation.lat);
    params.append('lon', userLocation.lon);
    console.log('Searching products with user location:', `(${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)})`);
  } else {
    console.log('Searching products without user location');
  }

  fetch(`/api/shop/search?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('loadingState').classList.add('d-none');
      latestShopResults = Array.isArray(data.shops) ? data.shops : [];

      if (latestShopResults.length > 0) {
        recordRecommendationsFromShops(latestShopResults);
        renderRecommendations();
        document.getElementById('resultsTitle').textContent = `Found ${data.total_shops || latestShopResults.length} shop(s) with matching products`;
        renderShops(latestShopResults);
      } else {
        document.getElementById('noResults').classList.remove('d-none');
        document.getElementById('resultsTitle').textContent = 'No shops found';
      }
    })
    .catch(error => {
      console.error('Search error:', error);
      document.getElementById('loadingState').classList.add('d-none');
      document.getElementById('noResults').classList.remove('d-none');
    });
}

// Render shops with products
function renderShops(shops) {
  latestShopResults = Array.isArray(shops) ? shops : [];
  const shopsList = document.getElementById('shopsList');
  shopsList.innerHTML = '';

  latestShopResults.forEach(shopData => {
    const shop = shopData.shop;
    const products = Array.isArray(shopData.products) ? shopData.products : [];
    
    const shopCard = document.createElement('div');
    shopCard.className = 'col-md-6 col-lg-4';
    shopCard.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-start mb-3">
            ${shop.image_url ? `<img src="${shop.image_url}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">` : ''}
            <div class="flex-grow-1">
              <h5 class="card-title mb-1">
                ${shop.name}
                ${shop.is_verified ? '<i class="fas fa-check-circle text-success ms-1" title="Verified"></i>' : ''}
              </h5>
              <p class="text-muted small mb-1">
                <i class="fas fa-map-marker-alt me-1"></i>${shop.address}
              </p>
              ${shopData.distance ? `<p class="text-primary small mb-0"><i class="fas fa-route me-1"></i>${shopData.distance} km away</p>` : ''}
              ${shop.location_lat && shop.location_lon ? `<p class="text-muted small mb-0" style="font-size: 0.7rem;"><i class="fas fa-crosshairs me-1"></i>Coords: ${shop.location_lat.toFixed(6)}, ${shop.location_lon.toFixed(6)}</p>` : ''}
              <div class="mt-2">
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-star me-1"></i>${shop.rating.toFixed(1)}
                </span>
              </div>
            </div>
          </div>
          
          <hr>
          
          <h6 class="fw-bold mb-3">Available Products:</h6>
          <div class="products-list">
            ${products.length ? products.map(product => `
              <div class="product-item border rounded p-3 mb-3">
                <div class="d-flex align-items-start">
                  ${product.image_url ? `<img src="${product.image_url}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">` : '<div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="fas fa-box text-muted"></i></div>'}
                  <div class="flex-grow-1">
                    <h6 class="mb-1">${product.name}</h6>
                    <p class="text-muted small mb-2">${product.description || 'No description'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-bold text-primary">₹${product.price}</span>
                        <span class="text-muted small ms-2">Stock: ${product.stock_quantity}</span>
                      </div>
                      <button class="btn btn-sm btn-primary" onclick="addToCart('${product.id}', '${shop.id}')">
                        <i class="fas fa-cart-plus me-1"></i>Add to Cart
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `).join('') : '<p class="text-muted small">No products listed yet.</p>'}
          </div>
        </div>
      </div>
    `;
    
    shopsList.appendChild(shopCard);
  });
}

// Add to cart
function addToCart(productId, shopId) {
  const { shop, product } = findProductDetails(shopId, productId);
  if (!product || !shop) {
    showNotification('Unable to locate product details. Please try again.', 'error');
    return;
  }

  const token = getAuthToken();
  if (!token) {
    addToLocalCart(product, shop);
    showNotification('Product saved to your cart. Login to checkout.', 'info');
    return;
  }

  fetch('/api/cart/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      product_id: productId,
      quantity: 1
    })
  })
  .then(async res => {
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.message || 'Failed to add to cart');
    }
      showNotification('Product added to cart!', 'success');
      loadCart();
  })
  .catch(error => {
    console.error('Add to cart error:', error);
    showNotification(error.message || 'Failed to add to cart', 'error');
  });
}

async function loadCart() {
  const token = getAuthToken();
  const localCart = getLocalCart();

  if (!token) {
    updateCartBadge(localCart.items.length);
    renderCart(localCart.items, { isLocal: true });
    return;
  }

  if (localCart.items.length) {
    await syncLocalCartToServer();
  }

  fetch('/api/cart', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(async res => {
    if (!res.ok) {
      throw new Error('Failed to load cart');
    }
    return res.json();
  })
  .then(data => {
    const items = Array.isArray(data.items) ? data.items : [];
    updateCartBadge(items.length);
    renderCart(items, { totalAmount: data.total_amount || 0 });
  })
  .catch(error => {
    console.error('Load cart error:', error);
    updateCartBadge(0);
    renderCart([], { isLocal: !!localCart.items.length });
  });
}

// Render cart
function renderCart(items = [], options = {}) {
  const cartItems = document.getElementById('cartItems');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const token = getAuthToken();

  const normalizedItems = (items || []).map(item => ({
    product_id: item.product_id,
    product_name: item.product_name || item.name || 'Product',
    price: Number(item.price || 0),
    quantity: Number(item.quantity || 1),
    total_price: Number(item.total_price || (item.price || 0) * (item.quantity || 1)),
    shop_id: item.shop_id,
    shop_name: item.shop_name || (item.shop && item.shop.name) || 'Shop',
    product_image: item.product_image || item.image_url || null
  })).filter(item => item.quantity > 0);

  if (!normalizedItems.length) {
    cartItems.innerHTML = `
      <div class="text-center py-5 text-muted">
        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
        <p>Your cart is empty. Start exploring products!</p>
      </div>
    `;
    checkoutBtn.disabled = true;
    document.getElementById('cartTotal').textContent = '₹0.00';
    return;
  }

  checkoutBtn.disabled = !token;

  const shopGroups = normalizedItems.reduce((acc, item) => {
    if (!acc[item.shop_id]) {
      acc[item.shop_id] = { shop_name: item.shop_name, items: [] };
    }
    acc[item.shop_id].items.push(item);
    return acc;
  }, {});

  let totalAmount = options.totalAmount || 0;
  if (!totalAmount) {
    totalAmount = normalizedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  }

  let html = '';
  Object.entries(shopGroups).forEach(([shopId, group]) => {
    html += `
      <div class="mb-4">
        <h6 class="fw-bold mb-3">
          <i class="fas fa-store me-2"></i>${group.shop_name}
        </h6>
        ${group.items.map(item => `
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1">${item.product_name}</h6>
                  <p class="text-muted small mb-2">₹${item.price} each</p>
                  <div class="d-flex align-items-center gap-2">
                    <label class="small">Qty:</label>
                    <input type="number" class="form-control form-control-sm" style="width: 80px;" 
                           value="${item.quantity}" min="1" 
                           onchange="updateCartItem('${item.product_id}', '${shopId}', this.value)">
                  </div>
                </div>
                <div class="text-end">
                  <p class="fw-bold text-primary mb-2">₹${(item.price * item.quantity).toFixed(2)}</p>
                  <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.product_id}', '${shopId}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  });

  cartItems.innerHTML = html;
  document.getElementById('cartTotal').textContent = `₹${totalAmount.toFixed(2)}`;

  if (!token) {
    checkoutBtn.disabled = true;
    checkoutBtn.title = 'Login to proceed to checkout';
  } else {
    checkoutBtn.title = '';
  }
}

// Update cart item
function updateCartItem(productId, shopId, quantity) {
  const token = getAuthToken();
  const newQuantity = parseInt(quantity, 10);
  if (!token) {
    updateLocalCartItem(productId, shopId, newQuantity);
    return;
  }

  fetch(`/api/cart/item/${productId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ quantity: newQuantity })
  })
  .then(async res => {
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.message || 'Failed to update cart');
    }
      loadCart();
  })
  .catch(error => {
    console.error('Update cart error:', error);
    showNotification(error.message || 'Failed to update cart', 'error');
  });
}

// Remove from cart
function removeFromCart(productId, shopId) {
  const token = getAuthToken();
  if (!token) {
    removeLocalCartItem(productId, shopId);
    showNotification('Item removed from cart', 'success');
    return;
  }

  fetch(`/api/cart/item/${productId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(async res => {
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(data.message || 'Failed to remove item');
    }
      showNotification('Item removed from cart', 'success');
      loadCart();
  })
  .catch(error => {
    console.error('Remove from cart error:', error);
    showNotification(error.message || 'Failed to remove item', 'error');
  });
}

// Checkout
document.getElementById('checkoutBtn').addEventListener('click', function() {
  const token = getAuthToken();
  if (!token) {
    alert('Please login to checkout');
    window.location.href = '/login';
    return;
  }

  // Load cart first to get shop groups
  fetch('/api/cart', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.items || data.items.length === 0) {
      alert('Cart is empty');
      return;
    }

    // Group by shop
    const shopGroups = {};
    data.items.forEach(item => {
      const shopId = item.shop_id;
      if (!shopGroups[shopId]) {
        shopGroups[shopId] = {
          shop_id: shopId,
          shop_name: item.shop_name,
          items: []
        };
      }
      shopGroups[shopId].items.push(item);
    });

    // Show checkout form
    renderCheckoutForm(Object.values(shopGroups));
  });
});

function renderCheckoutForm(shopGroups) {
  const checkoutContent = document.getElementById('checkoutContent');
  
  checkoutContent.innerHTML = `
    <div class="row">
      <div class="col-md-7">
        <h6 class="fw-bold mb-3">Delivery Address</h6>
        <div class="mb-3">
          <label class="form-label">Address</label>
          <textarea class="form-control" id="deliveryAddress" rows="3" required></textarea>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Latitude</label>
            <input type="number" class="form-control" id="deliveryLat" step="any" 
                   value="${userLocation ? userLocation.lat : ''}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Longitude</label>
            <input type="number" class="form-control" id="deliveryLon" step="any" 
                   value="${userLocation ? userLocation.lon : ''}" required>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Contact Phone</label>
          <input type="tel" class="form-control" id="contactPhone" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Payment Method</label>
          <select class="form-select" id="paymentMethod">
            <option value="Razorpay">Online Payment (Razorpay)</option>
            <option value="Cash">Cash on Delivery</option>
          </select>
        </div>
      </div>
      <div class="col-md-5">
        <h6 class="fw-bold mb-3">Order Summary</h6>
        ${shopGroups.map(group => `
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="fw-bold">${group.shop_name}</h6>
              ${group.items.map(item => `
                <div class="d-flex justify-content-between mb-2">
                  <span>${item.product_name} x ${item.quantity}</span>
                  <span>₹${item.total_price}</span>
                </div>
              `).join('')}
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span>₹${group.items.reduce((sum, item) => sum + item.total_price, 0).toFixed(2)}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="text-end mt-4">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="placeOrders()">Place Orders</button>
    </div>
  `;

  const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
  checkoutModal.show();
}

async function placeOrders() {
  const token = getAuthToken();
  if (!token) {
    alert('Please login to proceed with checkout');
    window.location.href = '/login';
    return;
  }

  const deliveryAddress = document.getElementById('deliveryAddress').value;
  const deliveryLat = parseFloat(document.getElementById('deliveryLat').value);
  const deliveryLon = parseFloat(document.getElementById('deliveryLon').value);
  const contactPhone = document.getElementById('contactPhone').value;
  const paymentMethod = document.getElementById('paymentMethod').value;

  if (!deliveryAddress || !deliveryLat || !deliveryLon || !contactPhone) {
    alert('Please fill all required fields');
    return;
  }

  // Check if Razorpay SDK is loaded when Razorpay payment is selected
  if (paymentMethod === 'Razorpay') {
    // Wait for Razorpay SDK to load with a timeout
    let attempts = 0;
    const maxAttempts = 10;
    while (typeof Razorpay === 'undefined' && attempts < maxAttempts) {
      await new Promise(resolve => setTimeout(resolve, 100));
      attempts++;
    }
    
    if (typeof Razorpay === 'undefined') {
      alert('Payment gateway is taking too long to load. Please refresh the page and try again.');
      console.error('Razorpay SDK not loaded after waiting');
      return;
    }
    console.log('Razorpay SDK is loaded and ready');
  }

  // Get cart to group by shops
  fetch('/api/cart', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    const shopGroups = {};
    data.items.forEach(item => {
      const shopId = item.shop_id;
      if (!shopGroups[shopId]) {
        shopGroups[shopId] = {
          shop_id: shopId,
          shop_name: item.shop_name,
          items: []
        };
      }
      shopGroups[shopId].items.push(item);
    });

    // Place orders for each shop
    const orderPromises = Object.values(shopGroups).map(group => {
      return fetch('/api/orders/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          shop_id: group.shop_id,
          delivery_address: deliveryAddress,
          delivery_lat: deliveryLat,
          delivery_lon: deliveryLon,
          contact_phone: contactPhone,
          payment_method: paymentMethod
        })
      }).then(res => res.json());
    });

    Promise.all(orderPromises)
      .then(async results => {
        const successfulOrders = results.filter(r => r.order_id);
        const successCount = successfulOrders.length;
        
        if (successCount > 0) {
          // If Razorpay payment, process payment for each order sequentially
          if (paymentMethod === 'Razorpay') {
            try {
              // Process payments sequentially (one at a time) since Razorpay can only handle one modal
              let paymentSuccessCount = 0;
              let paymentErrors = [];
              
              for (const result of successfulOrders) {
                try {
                  const orderId = result.order_id;
                  const totalAmount = result.total_amount || 0;
                  
                  // Validate minimum amount (Razorpay requires at least ₹1 = 100 paise)
                  if (totalAmount < 1) {
                    throw new Error('Order amount must be at least ₹1');
                  }
                  
                  console.log(`Processing payment for order ${orderId}, amount: ₹${totalAmount} (${Math.round(totalAmount * 100)} paise)`);
                  
                  // Create Razorpay order
                  const paymentResponse = await fetch('/payments/razorpay/create-order-shop', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                      amount: Math.round(totalAmount * 100), // Convert to paise
                      currency: 'INR',
                      order_id: orderId
                    })
                  });
                  
                  if (!paymentResponse.ok) {
                    let errorMessage = 'Failed to create payment order';
                    let errorCode = null;
                    try {
                      const errorData = await paymentResponse.json();
                      errorMessage = errorData.message || errorMessage;
                      errorCode = errorData.error || null;
                      
                      // Check for specific error codes
                      if (errorCode === 'invalid_key_config' || errorCode === 'invalid_credentials') {
                        errorMessage = 'Razorpay payment gateway is not properly configured. Please contact support or use Cash on Delivery.';
                      }
                    } catch (e) {
                      if (paymentResponse.status === 401) {
                        errorMessage = 'Payment gateway authentication failed. Please contact support or use Cash on Delivery.';
                      } else {
                        errorMessage = `Server error: ${paymentResponse.status} ${paymentResponse.statusText}`;
                      }
                    }
                    throw new Error(errorMessage);
                  }
                  
                  const paymentOrderData = await paymentResponse.json();
                  console.log('Razorpay order created:', paymentOrderData);
                  
                  // Double-check if Razorpay SDK is loaded
                  if (typeof Razorpay === 'undefined') {
                    throw new Error('Razorpay SDK not loaded. Please refresh the page and try again.');
                  }
                  
                  // Validate payment order data
                  if (!paymentOrderData.id || !paymentOrderData.key_id) {
                    throw new Error('Invalid payment order data received from server');
                  }
                  
                  console.log('Opening Razorpay checkout...');
                  
                  // Process payment for this order
                  await new Promise((resolve, reject) => {
                    const options = {
                      key: paymentOrderData.key_id,
                      amount: paymentOrderData.amount,
                      currency: paymentOrderData.currency,
                      name: 'Hofix Shop',
                      description: `Payment for order from ${result.shop_name || 'Shop'}`,
                      order_id: paymentOrderData.id,
                      handler: async function(razorpayResponse) {
                        try {
                          // Verify payment
                          const verifyResponse = await fetch('/payments/razorpay/verify-shop', {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                              razorpay_payment_id: razorpayResponse.razorpay_payment_id,
                              razorpay_order_id: razorpayResponse.razorpay_order_id,
                              razorpay_signature: razorpayResponse.razorpay_signature,
                              order_id: orderId
                            })
                          });
                          
                          const verifyData = await verifyResponse.json();
                          console.log('Payment verification response:', verifyData);
                          
                          if (verifyResponse.ok) {
                            // Check if payment status is Success
                            if (verifyData.status === 'Success' || verifyData.status === 'success') {
                              paymentSuccessCount++;
                              console.log(`Payment successful for order ${orderId}`);
                              resolve({ success: true, orderId });
                            } else {
                              // Payment was processed but status is not Success
                              const errorMsg = verifyData.message || `Payment status: ${verifyData.status || 'unknown'}`;
                              console.error('Payment verification failed - status:', verifyData.status);
                              reject(new Error(errorMsg));
                            }
                          } else {
                            // HTTP error response
                            const errorMsg = verifyData.message || `Payment verification failed: ${verifyResponse.status}`;
                            console.error('Payment verification HTTP error:', verifyResponse.status, verifyData);
                            reject(new Error(errorMsg));
                          }
                        } catch (error) {
                          console.error('Payment verification error:', error);
                          reject(new Error(error.message || 'Payment verification failed'));
                        }
                      },
                      prefill: {
                        contact: contactPhone || ''
                      },
                      theme: {
                        color: '#0d6efd'
                      },
                      modal: {
                        ondismiss: function() {
                          reject(new Error('Payment cancelled by user'));
                        }
                      }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.on('payment.failed', function(response) {
                      console.error('Razorpay payment failed:', response);
                      const errorMsg = response.error?.description || response.error?.reason || 'Payment failed';
                      reject(new Error(errorMsg));
                    });
                    rzp.on('payment.authorized', function(response) {
                      // This is called before handler, but handler still processes it
                      console.log('Payment authorized:', response);
                    });
                    rzp.open();
                  });
                  
                } catch (error) {
                  console.error(`Payment error for order ${result.order_id}:`, error);
                  paymentErrors.push({
                    shop: result.shop_name || 'Shop',
                    error: error.message
                  });
                  // Continue with next order even if this one fails
                }
              }
              
              // Show results
              if (paymentSuccessCount > 0) {
                bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
                loadCart();
                
                if (paymentErrors.length > 0) {
                  showNotification(`Payment successful for ${paymentSuccessCount} order(s). ${paymentErrors.length} order(s) failed - you can retry payment from Orders page.`, 'warning');
                } else {
                  showNotification(`Payment successful! ${paymentSuccessCount} order(s) placed.`, 'success');
                }
                
                // Redirect to orders page
                setTimeout(() => {
                  window.location.href = '/orders';
                }, 2000);
              } else {
                // All payments failed
                const errorMsg = paymentErrors.length > 0 
                  ? paymentErrors.map(e => `${e.shop}: ${e.error}`).join('; ')
                  : 'All payments failed';
                showNotification(`Payment failed: ${errorMsg}. Orders are created but unpaid. You can retry payment from Orders page.`, 'error');
              }
            } catch (error) {
              console.error('Payment error:', error);
              showNotification(`Payment failed: ${error.message || 'Unknown error'}. Orders are created but unpaid. You can retry payment from Orders page.`, 'error');
            }
          } else {
            // Cash payment - orders already created
            showNotification(`Successfully placed ${successCount} order(s)!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
            loadCart();
            
            // Redirect to orders page
            setTimeout(() => {
              window.location.href = '/orders';
            }, 1500);
          }
        } else {
          showNotification('Failed to place orders', 'error');
        }
      })
      .catch(error => {
        console.error('Place order error:', error);
        showNotification('Failed to place orders', 'error');
      });
  });
}

// Event listeners
document.getElementById('searchBtn').addEventListener('click', function() {
  const query = document.getElementById('productSearch').value.trim();
  if (query) {
    document.getElementById('searchResultsSection').classList.remove('d-none');
    document.getElementById('browseShopsSection').classList.add('d-none');
    searchProducts(query, currentCategory);
  }
});

document.getElementById('productSearch').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    const query = this.value.trim();
    if (query) {
      document.getElementById('searchResultsSection').classList.remove('d-none');
      document.getElementById('browseShopsSection').classList.add('d-none');
      searchProducts(query, currentCategory);
    }
  }
});

// Product category filters (for search)
document.querySelectorAll('.category-filter').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentCategory = this.dataset.category;
    if (currentSearchQuery) {
      searchProducts(currentSearchQuery, currentCategory);
    }
  });
});

// Shop category filters (for browsing)
document.querySelectorAll('.shop-category-filter').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.shop-category-filter').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const shopCategory = this.dataset.shopCategory;
    if (shopCategory) {
      browseShopsByCategory(shopCategory);
    } else {
      showAllCategories();
    }
  });
});

// Load cart on page load
document.addEventListener('DOMContentLoaded', function() {
  loadCart();
  renderRecommendations();
});

// Helper functions
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

function getAuthToken(){
  const cookieTok = getCookie('access_token_cookie');
  if (cookieTok) return cookieTok;
  const localTok = localStorage.getItem('token');
  return localTok || null;
}

function showNotification(message, type = 'info') {
  // Simple notification - you can enhance this
  const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-info';
  const alert = document.createElement('div');
  alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
  alert.style.zIndex = '9999';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

// Global error handler for unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', event.reason);
  // Prevent default browser error handling (which shows alert)
  event.preventDefault();
  // Show user-friendly notification instead
  if (event.reason && event.reason.message) {
    showNotification(`Error: ${event.reason.message}`, 'error');
  } else if (typeof event.reason === 'string') {
    showNotification(`Error: ${event.reason}`, 'error');
  } else {
    showNotification('An error occurred. Please try again.', 'error');
  }
});
</script>

<style>
.hero-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.hero-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=1920') center/cover;
  opacity: 0.3;
}

.hero-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
}

.product-item {
  transition: transform 0.2s;
}

.product-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

