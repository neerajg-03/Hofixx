<script>
// Admin authentication check - must be included in all admin pages
(function() {
    const token = localStorage.getItem('token');
    const currentUrl = window.location.href;
    
    // If we're already being redirected or no token, handle accordingly
    if (currentUrl.includes('/login')) {
        return; // Already on login page
    }
    
    if (!token) {
        // No token, redirect to login with return URL
        const returnUrl = encodeURIComponent(currentUrl);
        window.location.href = `/login?next=${returnUrl}`;
        return;
    }
    
    // Decode token to check role
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const role = payload.role || (payload.sub && typeof payload.sub === 'object' && payload.sub.role) || '';
        
        if (role !== 'admin') {
            // Not an admin, redirect to appropriate dashboard
            if (role === 'provider') {
                window.location.href = '/dashboard-provider';
            } else {
                window.location.href = '/dashboard/user/new';
            }
            return;
        }
        
        // Update all admin links to include token - CRITICAL for navigation
        function updateAdminLinks() {
            const links = document.querySelectorAll('a[href^="/admin"]');
            console.log(`DEBUG: Found ${links.length} admin links to update`);
            links.forEach(link => {
                const originalHref = link.getAttribute('href');
                if (originalHref && !originalHref.includes('token=')) {
                    const separator = originalHref.includes('?') ? '&' : '?';
                    const newHref = originalHref + separator + 'token=' + encodeURIComponent(token);
                    link.setAttribute('href', newHref);
                    console.log(`DEBUG: Updated link from ${originalHref} to ${newHref.substring(0, 80)}...`);
                }
            });
        }
        
        // Update links immediately and after DOM loads
        updateAdminLinks();
        
        // ALSO intercept clicks to ensure token is always added
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a[href^="/admin"]');
            if (link) {
                const href = link.getAttribute('href');
                if (href && !href.includes('token=')) {
                    const separator = href.includes('?') ? '&' : '?';
                    e.preventDefault();
                    const newHref = href + separator + 'token=' + encodeURIComponent(token);
                    window.location.href = newHref;
                }
            }
        }, true); // Use capture phase to catch early
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // Update again after DOM loads
                setTimeout(updateAdminLinks, 100);
            });
        }
        
        // Set token in cookie for Flask-JWT-Extended (always update to ensure it's current)
        const cookieName = 'access_token_cookie';
        const expires = new Date();
        expires.setTime(expires.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days
        document.cookie = `${cookieName}=${token}; expires=${expires.toUTCString()}; path=/; SameSite=Lax`;
        
        // Also try to refresh the page cookie by making a quick request to sync cookies
        // This ensures the cookie is properly set for server-side reading
        
    } catch (error) {
        console.error('Error decoding token:', error);
        localStorage.removeItem('token');
        const returnUrl = encodeURIComponent(currentUrl);
        window.location.href = `/login?next=${returnUrl}`;
    }
})();
</script>

