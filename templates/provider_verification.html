{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">
            <i class="fas fa-user-check me-2"></i>Provider Verification
          </h3>
          <p class="mb-0 mt-2 small">Complete all steps to get verified and start accepting jobs</p>
        </div>
        <div class="card-body">
          <!-- Progress Indicator -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="step-indicator active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Basic Info</div>
              </div>
              <div class="step-line"></div>
              <div class="step-indicator" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Documents</div>
              </div>
              <div class="step-line"></div>
              <div class="step-indicator" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Selfie</div>
              </div>
              <div class="step-line"></div>
              <div class="step-indicator" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Location</div>
              </div>
              <div class="step-line"></div>
              <div class="step-indicator" data-step="5">
                <div class="step-number">5</div>
                <div class="step-label">Submit</div>
              </div>
            </div>
          </div>

          <!-- Status Alert -->
          <div id="statusAlert" class="alert d-none"></div>

          <!-- Step 1: Basic Information -->
          <div id="step1" class="verification-step">
            <h5 class="mb-4">Step 1: Basic Information</h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-control" id="providerName" readonly>
                <small class="text-muted">This is from your profile</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="providerEmail" readonly>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone Number *</label>
                <input type="tel" class="form-control" id="providerPhone" readonly>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-primary" onclick="nextStep(2)">Next: Upload Documents <i class="fas fa-arrow-right ms-2"></i></button>
            </div>
          </div>

          <!-- Step 2: Document Upload -->
          <div id="step2" class="verification-step d-none">
            <h5 class="mb-4">Step 2: Upload Documents</h5>
            <p class="text-muted mb-4">Please upload clear, legible images of your documents</p>
            
            <div class="row">
              <!-- Aadhaar Front -->
              <div class="col-md-6 mb-4">
                <label class="form-label">Aadhaar Card (Front) *</label>
                <div class="upload-area" id="aadhaarFrontArea">
                  <input type="file" id="aadhaarFront" accept="image/*,.pdf" class="d-none" onchange="handleFileUpload(this, 'aadhaarFront')">
                  <div class="upload-preview" id="aadhaarFrontPreview"></div>
                  <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('aadhaarFront').click()">
                    <i class="fas fa-upload me-2"></i>Upload Front
                  </button>
                </div>
              </div>
              
              <!-- Aadhaar Back -->
              <div class="col-md-6 mb-4">
                <label class="form-label">Aadhaar Card (Back) *</label>
                <div class="upload-area" id="aadhaarBackArea">
                  <input type="file" id="aadhaarBack" accept="image/*,.pdf" class="d-none" onchange="handleFileUpload(this, 'aadhaarBack')">
                  <div class="upload-preview" id="aadhaarBackPreview"></div>
                  <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('aadhaarBack').click()">
                    <i class="fas fa-upload me-2"></i>Upload Back
                  </button>
                </div>
              </div>
              
              <!-- PAN Card -->
              <div class="col-md-6 mb-4">
                <label class="form-label">PAN Card *</label>
                <div class="upload-area" id="panArea">
                  <input type="file" id="pan" accept="image/*,.pdf" class="d-none" onchange="handleFileUpload(this, 'pan')">
                  <div class="upload-preview" id="panPreview"></div>
                  <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('pan').click()">
                    <i class="fas fa-upload me-2"></i>Upload PAN
                  </button>
                </div>
              </div>
              
              <!-- Skill Certificate (Optional) -->
              <div class="col-md-6 mb-4">
                <label class="form-label">Skill Certificate (Optional)</label>
                <div class="upload-area" id="skillCertArea">
                  <input type="file" id="skillCert" accept="image/*,.pdf" class="d-none" onchange="handleFileUpload(this, 'skillCert')">
                  <div class="upload-preview" id="skillCertPreview"></div>
                  <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('skillCert').click()">
                    <i class="fas fa-upload me-2"></i>Upload Certificate
                  </button>
                </div>
              </div>
              
              <!-- Police Verification (Optional) -->
              <div class="col-md-6 mb-4">
                <label class="form-label">Police Verification (Optional)</label>
                <div class="upload-area" id="policeVerificationArea">
                  <input type="file" id="policeVerification" accept="image/*,.pdf" class="d-none" onchange="handleFileUpload(this, 'policeVerification')">
                  <div class="upload-preview" id="policeVerificationPreview"></div>
                  <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('policeVerification').click()">
                    <i class="fas fa-upload me-2"></i>Upload Document
                  </button>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <button class="btn btn-outline-secondary" onclick="prevStep(1)"><i class="fas fa-arrow-left me-2"></i>Previous</button>
              <button class="btn btn-primary" onclick="saveStep(2)">Save & Continue <i class="fas fa-arrow-right ms-2"></i></button>
            </div>
          </div>

          <!-- Step 3: Selfie Capture -->
          <div id="step3" class="verification-step d-none">
            <h5 class="mb-4">Step 3: Live Selfie Verification</h5>
            <p class="text-muted mb-4">Please take a clear selfie for face verification</p>
            
            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="camera-container mb-4">
                  <video id="video" autoplay playsinline class="w-100 rounded" style="max-height: 400px; background: #000;"></video>
                  <canvas id="canvas" class="d-none"></canvas>
                </div>
                
                <div class="d-flex justify-content-center gap-3 mb-4">
                  <button class="btn btn-primary" id="startCameraBtn" onclick="startCamera()">
                    <i class="fas fa-camera me-2"></i>Start Camera
                  </button>
                  <button class="btn btn-success d-none" id="captureBtn" onclick="captureSelfie()">
                    <i class="fas fa-camera-retro me-2"></i>Capture Selfie
                  </button>
                  <button class="btn btn-warning d-none" id="retakeBtn" onclick="retakeSelfie()">
                    <i class="fas fa-redo me-2"></i>Retake
                  </button>
                </div>
                
                <div id="selfiePreview" class="text-center d-none">
                  <img id="selfieImage" src="" alt="Selfie Preview" class="img-fluid rounded mb-3" style="max-height: 300px;">
                  <p class="text-success"><i class="fas fa-check-circle me-2"></i>Selfie captured successfully!</p>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <button class="btn btn-outline-secondary" onclick="prevStep(2)"><i class="fas fa-arrow-left me-2"></i>Previous</button>
              <button class="btn btn-primary" id="saveSelfieBtn" onclick="saveSelfie()" disabled>Save & Continue <i class="fas fa-arrow-right ms-2"></i></button>
            </div>
          </div>

          <!-- Step 4: GPS Location -->
          <div id="step4" class="verification-step d-none">
            <h5 class="mb-4">Step 4: Address Verification</h5>
            <p class="text-muted mb-4">Please allow location access to verify your address</p>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              We need your current location to verify your address. This helps us ensure you're providing accurate information.
            </div>
            
            <div class="mb-3">
              <label class="form-label">Current Address *</label>
              <textarea class="form-control" id="verificationAddress" rows="3" placeholder="Enter your current address"></textarea>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Latitude</label>
                <input type="text" class="form-control" id="gpsLat" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Longitude</label>
                <input type="text" class="form-control" id="gpsLon" readonly>
              </div>
            </div>
            
            <div class="mb-4">
              <button class="btn btn-primary" onclick="getCurrentLocation()">
                <i class="fas fa-map-marker-alt me-2"></i>Get Current Location
              </button>
              <span id="locationStatus" class="ms-3"></span>
            </div>
            
            <div id="mapPreview" class="mb-4" style="height: 300px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <p class="text-muted">Location will be shown here</p>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <button class="btn btn-outline-secondary" onclick="prevStep(3)"><i class="fas fa-arrow-left me-2"></i>Previous</button>
              <button class="btn btn-primary" onclick="saveLocation()">Save & Continue <i class="fas fa-arrow-right ms-2"></i></button>
            </div>
          </div>

          <!-- Step 5: Submit -->
          <div id="step5" class="verification-step d-none">
            <h5 class="mb-4">Step 5: Review & Submit</h5>
            <p class="text-muted mb-4">Please review all your information before submitting</p>
            
            <div class="card mb-4">
              <div class="card-body">
                <h6 class="card-title">Verification Summary</h6>
                <ul class="list-unstyled">
                  <li class="mb-2">
                    <i class="fas fa-check-circle text-success me-2" id="summaryBasic"></i>
                    Basic Information
                  </li>
                  <li class="mb-2">
                    <i class="fas fa-check-circle text-success me-2" id="summaryDocuments"></i>
                    Documents Uploaded
                  </li>
                  <li class="mb-2">
                    <i class="fas fa-check-circle text-success me-2" id="summarySelfie"></i>
                    Selfie Captured
                  </li>
                  <li class="mb-2">
                    <i class="fas fa-check-circle text-success me-2" id="summaryLocation"></i>
                    Location Verified
                  </li>
                </ul>
              </div>
            </div>
            
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Important:</strong> Once submitted, your verification request will be reviewed by our admin team. 
              You will be notified once your verification is approved or if any additional documents are required.
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <button class="btn btn-outline-secondary" onclick="prevStep(4)"><i class="fas fa-arrow-left me-2"></i>Previous</button>
              <button class="btn btn-success btn-lg" onclick="submitVerification()">
                <i class="fas fa-paper-plane me-2"></i>Submit Verification Request
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.step-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  position: relative;
}

.step-number {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #e9ecef;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 8px;
  transition: all 0.3s;
}

.step-indicator.active .step-number {
  background: #0d6efd;
  color: white;
}

.step-indicator.completed .step-number {
  background: #198754;
  color: white;
}

.step-label {
  font-size: 0.875rem;
  color: #6c757d;
  text-align: center;
}

.step-indicator.active .step-label {
  color: #0d6efd;
  font-weight: 600;
}

.step-line {
  flex: 1;
  height: 2px;
  background: #e9ecef;
  margin: 0 10px;
  margin-top: -30px;
}

.verification-step {
  min-height: 400px;
}

.upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
}

.upload-area:hover {
  border-color: #0d6efd;
  background: #f8f9fa;
}

.upload-preview {
  margin-bottom: 10px;
}

.upload-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 4px;
}

.camera-container {
  position: relative;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}
</style>

<script>
let currentStep = 1;
let stream = null;
let verificationData = {
  aadhaarFront: null,
  aadhaarBack: null,
  pan: null,
  skillCert: null,
  policeVerification: null,
  selfie: null,
  gpsLocation: null,
  address: null
};

function toSnakeCase(str) {
  return str ? str.replace(/([A-Z])/g, '_$1').toLowerCase() : '';
}

function getCurrentVerificationSnapshot() {
  return {
    aadhaar_front_url: verificationData.aadhaarFront,
    aadhaar_back_url: verificationData.aadhaarBack,
    pan_url: verificationData.pan,
    selfie_url: verificationData.selfie,
    verification_gps_lat: verificationData.gpsLocation ? 1 : null,
    verification_gps_lon: verificationData.gpsLocation ? 1 : null,
    verification_address: verificationData.address
  };
}

function getAuthToken() {
  const cookieTok = document.cookie.split('; ').find(row => row.startsWith('access_token_cookie='))?.split('=')[1];
  if (cookieTok) return cookieTok;
  return localStorage.getItem('token');
}

// Load user info on page load
document.addEventListener('DOMContentLoaded', function() {
  loadUserInfo();
  loadVerificationStatus();
});

function loadUserInfo() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  fetch('/api/user/profile', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('providerName').value = data.name || '';
    document.getElementById('providerEmail').value = data.email || '';
    document.getElementById('providerPhone').value = data.phone || '';
  })
  .catch(error => {
    console.error('Error loading user info:', error);
  });
}

function loadVerificationStatus() {
  const token = getAuthToken();
  fetch('/api/verification/provider/status', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(async res => {
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      console.error('Error loading verification status:', data.message || res.statusText);
      return;
    }

    const status = data.verification_status || 'not_started';

    if (status === 'verified') {
      showStatusAlert('success', 'Your verification has been approved! You can now accept jobs.');
      disableAllSteps(true);
    } else if (status === 'pending') {
      showStatusAlert('info', 'Your verification request is pending admin approval. You can still update your documents or location if needed.');
      disableAllSteps(false);
    } else if (status === 'rejected') {
      showStatusAlert('danger', `Your verification was rejected. ${data.admin_remarks || ''}`);
      disableAllSteps(false);
    } else {
      showStatusAlert('info', 'Please complete your verification to start accepting jobs.');
      disableAllSteps(false);
    }
    
    // Load existing data
    if (data.aadhaar_front_url) {
      displayPreview('aadhaarFront', data.aadhaar_front_url);
      verificationData.aadhaarFront = true;
    }
    if (data.aadhaar_back_url) {
      displayPreview('aadhaarBack', data.aadhaar_back_url);
      verificationData.aadhaarBack = true;
    }
    if (data.pan_url) {
      displayPreview('pan', data.pan_url);
      verificationData.pan = true;
    }
    if (data.skill_cert_url) {
      displayPreview('skillCert', data.skill_cert_url);
      verificationData.skillCert = true;
    }
    if (data.police_verification_url) {
      displayPreview('policeVerification', data.police_verification_url);
      verificationData.policeVerification = true;
    }
    if (data.selfie_url) {
      document.getElementById('selfieImage').src = data.selfie_url;
      document.getElementById('selfiePreview').classList.remove('d-none');
      verificationData.selfie = true;
    }
    if (data.verification_gps_lat && data.verification_gps_lon) {
      document.getElementById('gpsLat').value = data.verification_gps_lat;
      document.getElementById('gpsLon').value = data.verification_gps_lon;
      document.getElementById('verificationAddress').value = data.verification_address || '';
      verificationData.gpsLocation = true;
      verificationData.address = data.verification_address;
    }

    highlightMissingData(data, data.missing_fields || []);
    updateSummary();
  })
  .catch(error => {
    console.log('No existing verification data', error);
  });
}

function showStatusAlert(type, message) {
  const alert = document.getElementById('statusAlert');
  alert.className = `alert alert-${type}`;
  alert.textContent = message;
  alert.classList.remove('d-none');
}

function disableAllSteps(disable = true) {
  document.querySelectorAll('.verification-step button').forEach(btn => btn.disabled = disable);
  document.querySelectorAll('.verification-step input:not([readonly]), .verification-step textarea').forEach(el => {
    el.disabled = disable;
  });
}

function highlightMissingData(data = {}, serverMissing = []) {
  const missingDocs = Array.isArray(serverMissing) && serverMissing.length > 0
    ? serverMissing
    : (() => {
        const list = [];
        if (!data.aadhaar_front_url) list.push('Aadhaar front document');
        if (!data.aadhaar_back_url) list.push('Aadhaar back document');
        if (!data.pan_url) list.push('PAN card');
        if (!data.selfie_url) list.push('Selfie verification');
        if (!(data.verification_gps_lat && data.verification_gps_lon && data.verification_address)) {
          list.push('GPS coordinates / address');
        }
        return list;
      })();

  if (missingDocs.length > 0) {
    showNotification(`Pending items: ${missingDocs.join(', ')}. Please upload the remaining information so the admin can verify your profile.`, 'warning');
    const needsDocuments = !data.aadhaar_front_url || !data.aadhaar_back_url || !data.pan_url;
    const firstMissingStep = needsDocuments ? 2 : (!data.selfie_url ? 3 : 4);
    currentStep = firstMissingStep;
    updateProgress();
    showStep(firstMissingStep);
  }
}

function nextStep(step) {
  if (step > currentStep) {
    currentStep = step;
    updateProgress();
    showStep(step);
  }
}

function prevStep(step) {
  if (step < currentStep) {
    currentStep = step;
    updateProgress();
    showStep(step);
  }
}

function showStep(step) {
  document.querySelectorAll('.verification-step').forEach(el => el.classList.add('d-none'));
  document.getElementById(`step${step}`).classList.remove('d-none');
}

function updateProgress() {
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNum = index + 1;
    indicator.classList.remove('active', 'completed');
    if (stepNum < currentStep) {
      indicator.classList.add('completed');
    } else if (stepNum === currentStep) {
      indicator.classList.add('active');
    }
  });
}

function handleFileUpload(input, type) {
  const file = input.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) { // 5MB limit
    alert('File size should be less than 5MB');
    return;
  }
  
  uploadVerificationFile(type, file, (data) => {
    const fieldKey = toSnakeCase(type);
    const uploadedUrl = data?.uploaded_url || data?.url || data?.[`${fieldKey}_url`] || data?.[fieldKey] || null;
    displayPreview(type, uploadedUrl || file);
    if (type in verificationData) {
      verificationData[type] = true;
    }
    highlightMissingData(getCurrentVerificationSnapshot(), data?.missing_fields || []);
    updateSummary();
  });
}

function uploadVerificationFile(fieldName, file, onSuccess) {
  const formData = new FormData();
  formData.append(fieldName, file);

  const token = getAuthToken();
  fetch('/api/verification/provider/submit', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(async res => {
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || 'Upload failed');
    }
    return res.json();
  })
  .then(data => {
    if (typeof onSuccess === 'function') {
      onSuccess(data);
    }
    showNotification('File uploaded successfully', 'success');
  })
  .catch(error => {
    console.error('Upload error:', error);
    showNotification(error.message || 'Error uploading file', 'error');
  });
}

function displayPreview(type, source) {
  const preview = document.getElementById(`${type}Preview`);
  if (!preview || !source) {
    return;
  }

  let imageSrc = source;

  if (source instanceof Blob) {
    imageSrc = URL.createObjectURL(source);
  }

  if (typeof imageSrc !== 'string') {
    console.warn('Unsupported preview source for', type, source);
    return;
  }

  preview.innerHTML = `<img src="${imageSrc}" alt="${type}" class="img-fluid rounded">`;
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(mediaStream => {
      stream = mediaStream;
      const video = document.getElementById('video');
      video.srcObject = stream;
      document.getElementById('startCameraBtn').classList.add('d-none');
      document.getElementById('captureBtn').classList.remove('d-none');
    })
    .catch(error => {
      console.error('Camera error:', error);
      alert('Unable to access camera. Please check permissions.');
    });
}

function captureSelfie() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  
  canvas.toBlob(blob => {
    verificationData.selfie = blob;
    document.getElementById('selfieImage').src = URL.createObjectURL(blob);
    document.getElementById('selfiePreview').classList.remove('d-none');
    document.getElementById('captureBtn').classList.add('d-none');
    document.getElementById('retakeBtn').classList.remove('d-none');
    document.getElementById('saveSelfieBtn').disabled = false;
    
    // Stop camera
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }, 'image/jpeg', 0.9);
}

function retakeSelfie() {
  document.getElementById('selfiePreview').classList.add('d-none');
  document.getElementById('captureBtn').classList.remove('d-none');
  document.getElementById('retakeBtn').classList.add('d-none');
  document.getElementById('saveSelfieBtn').disabled = true;
  startCamera();
}

function saveSelfie() {
  if (!verificationData.selfie) return;

  uploadVerificationFile('selfie', verificationData.selfie, (data) => {
    verificationData.selfie = true;
    showNotification('Selfie saved successfully', 'success');
    highlightMissingData(getCurrentVerificationSnapshot(), data?.missing_fields || []);
    updateSummary();
    nextStep(4);
  });
}

function getCurrentLocation() {
  const status = document.getElementById('locationStatus');
  status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
  
  if (!navigator.geolocation) {
    status.innerHTML = '<span class="text-danger">Geolocation not supported</span>';
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      
      document.getElementById('gpsLat').value = lat;
      document.getElementById('gpsLon').value = lon;
      verificationData.gpsLocation = { lat, lon };
      
      status.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Location captured</span>';
      
      // Show on map (simple display)
      document.getElementById('mapPreview').innerHTML = `
        <div class="p-3">
          <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
          <p><strong>Longitude:</strong> ${lon.toFixed(6)}</p>
          <small class="text-muted">Address verification enabled</small>
        </div>
      `;
    },
    error => {
      status.innerHTML = '<span class="text-danger">Error getting location: ' + error.message + '</span>';
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function saveLocation() {
  const address = document.getElementById('verificationAddress').value;
  const lat = document.getElementById('gpsLat').value;
  const lon = document.getElementById('gpsLon').value;
  
  if (!address || !lat || !lon) {
    alert('Please enter address and capture location');
    return;
  }
  
  verificationData.address = address;
  
  const formData = new FormData();
  formData.append('gps_lat', lat);
  formData.append('gps_lon', lon);
  formData.append('verification_address', address);
  
  const token = getAuthToken();
  fetch('/api/verification/provider/submit', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(async res => {
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      showNotification(data.message || 'Error saving location', 'error');
      highlightMissingData(getCurrentVerificationSnapshot(), data.missing_fields || []);
      return;
    }
    verificationData.gpsLocation = true;
    verificationData.address = address;
    showNotification('Location saved successfully', 'success');
    highlightMissingData(getCurrentVerificationSnapshot(), data.missing_fields || []);
    nextStep(5);
    updateSummary();
  })
  .catch(error => {
    console.error('Error saving location:', error);
    showNotification('Error saving location', 'error');
  });
}

function updateSummary() {
  document.getElementById('summaryBasic').className = 'fas fa-check-circle text-success me-2';
  document.getElementById('summaryDocuments').className = 
    (verificationData.aadhaarFront && verificationData.aadhaarBack && verificationData.pan) 
      ? 'fas fa-check-circle text-success me-2' 
      : 'fas fa-times-circle text-danger me-2';
  document.getElementById('summarySelfie').className = 
    verificationData.selfie 
      ? 'fas fa-check-circle text-success me-2' 
      : 'fas fa-times-circle text-danger me-2';
  document.getElementById('summaryLocation').className = 
    verificationData.gpsLocation 
      ? 'fas fa-check-circle text-success me-2' 
      : 'fas fa-times-circle text-danger me-2';
}

function submitVerification() {
  if (!confirm('Are you sure you want to submit your verification request? This cannot be undone.')) {
    return;
  }
  
  const formData = new FormData();
  formData.append('action', 'submit');
  
  const token = getAuthToken();
  fetch('/api/verification/provider/submit', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(async res => {
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      showNotification(data.message || 'Error submitting verification', 'error');
      highlightMissingData(getCurrentVerificationSnapshot(), data.missing_fields || []);
      return;
    }

    if ((data.verification_status || '').toLowerCase() === 'pending') {
      showStatusAlert('success', 'Verification request submitted successfully! You will be notified once it\'s reviewed.');
      disableAllSteps(true);
    } else {
      showNotification(data.message || 'Verification submitted', 'success');
    }
    highlightMissingData(getCurrentVerificationSnapshot(), data.missing_fields || []);
  })
  .catch(error => {
    console.error('Error submitting verification:', error);
    showNotification('Error submitting verification', 'error');
  });
}

function saveStep(step) {
  // Save current step data
  if (step === 2) {
    // Documents are saved on upload
    nextStep(3);
  }
}

function showNotification(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 3000);
}

updateProgress();
</script>
{% endblock %}



