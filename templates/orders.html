{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-shopping-bag me-2"></i>Your Orders
      </h2>
      
      <!-- Loading State -->
      <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your orders...</p>
      </div>
      
      <!-- No Orders -->
      <div id="noOrders" class="text-center py-5 d-none">
        <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No orders yet</h4>
        <p class="text-muted">Start shopping to see your orders here</p>
        <a href="/shop" class="btn btn-primary mt-3">
          <i class="fas fa-store me-2"></i>Start Shopping
        </a>
      </div>
      
      <!-- Orders List -->
      <div id="ordersList" class="d-none">
        <!-- Orders will be populated here -->
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
        <!-- Order details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Order Tracking Modal -->
<div class="modal fade" id="trackOrderModal" tabindex="-1" aria-labelledby="trackOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="trackOrderModalLabel">
          <i class="fas fa-truck me-2"></i>Track Your Order
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="trackOrderContent">
        <!-- Order tracking info will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
function getAuthToken() {
  const cookieTok = getCookie('access_token_cookie');
  if (cookieTok) return cookieTok;
  const localTok = localStorage.getItem('token');
  return localTok || null;
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

function showNotification(message, type = 'info') {
  const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-info';
  const alert = document.createElement('div');
  alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 3000);
}

function getStatusBadgeClass(status) {
  const statusMap = {
    'pending': 'bg-secondary',
    'confirmed': 'bg-info',
    'preparing': 'bg-warning',
    'ready': 'bg-primary',
    'assigned': 'bg-primary',
    'out_for_delivery': 'bg-info',
    'delivered': 'bg-success',
    'cancelled': 'bg-danger'
  };
  return statusMap[status] || 'bg-secondary';
}

function getStatusLabel(status) {
  const labelMap = {
    'pending': 'Pending',
    'confirmed': 'Confirmed',
    'preparing': 'Preparing',
    'ready': 'Ready',
    'assigned': 'Assigned to Delivery',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled'
  };
  return labelMap[status] || status;
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-IN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function loadOrders() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  fetch('/api/orders', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('loadingState').classList.add('d-none');
    
    if (!data || data.length === 0) {
      document.getElementById('noOrders').classList.remove('d-none');
      return;
    }
    
    document.getElementById('ordersList').classList.remove('d-none');
    renderOrders(data);
  })
  .catch(error => {
    console.error('Error loading orders:', error);
    document.getElementById('loadingState').classList.add('d-none');
    showNotification('Failed to load orders', 'error');
  });
}

function renderOrders(orders) {
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '';
  
  orders.forEach(order => {
    const orderCard = document.createElement('div');
    orderCard.className = 'card mb-4 shadow-sm';
    orderCard.innerHTML = `
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 class="mb-1">Order #${order.id.substring(0, 8)}</h5>
                <p class="text-muted mb-1">
                  <i class="fas fa-store me-2"></i>${order.shop_name || 'Shop'}
                </p>
                <p class="text-muted small mb-0">
                  <i class="fas fa-calendar me-1"></i>${formatDate(order.created_at)}
                </p>
              </div>
              <div class="text-end">
                <span class="badge ${getStatusBadgeClass(order.status)} mb-2">
                  ${getStatusLabel(order.status)}
                </span>
                <div>
                  <span class="badge ${order.payment_status === 'paid' ? 'bg-success' : order.payment_status === 'failed' ? 'bg-danger' : 'bg-warning'}">
                    ${order.payment_status === 'paid' ? 'Paid' : order.payment_status === 'failed' ? 'Payment Failed' : 'Pending Payment'}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <h6 class="mb-2">Items:</h6>
              <div class="ms-3">
                ${order.items.map(item => `
                  <div class="mb-1">
                    <span class="fw-bold">${item.product_name || 'Product'}</span>
                    <span class="text-muted"> × ${item.quantity}</span>
                    <span class="text-primary ms-2">₹${item.total_price || (item.price * item.quantity)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="mt-3">
              <p class="mb-1">
                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                <strong>Delivery Address:</strong> ${order.delivery_address}
              </p>
              <p class="mb-0">
                <i class="fas fa-rupee-sign me-2 text-success"></i>
                <strong>Total:</strong> ₹${order.total_amount.toFixed(2)}
              </p>
            </div>
          </div>
          
          <div class="col-md-4 text-end">
            <button class="btn btn-primary btn-sm mb-2" onclick="viewOrderDetails('${order.id}')">
              <i class="fas fa-eye me-1"></i>View Details
            </button>
            ${order.payment_status === 'paid' || (order.delivery_partner && order.delivery_partner.name) ? `
              <button class="btn btn-info btn-sm mb-2" onclick="trackOrder('${order.id}')">
                <i class="fas fa-truck me-1"></i>Track Order
              </button>
            ` : ''}
            ${order.payment_status === 'pending' && order.payment_method === 'Razorpay' ? `
              <button class="btn btn-success btn-sm" onclick="retryPayment('${order.id}', ${order.total_amount})">
                <i class="fas fa-credit-card me-1"></i>Pay Now
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
    ordersList.appendChild(orderCard);
  });
}

function viewOrderDetails(orderId) {
  const token = getAuthToken();
  if (!token) {
    showNotification('Please login', 'error');
    return;
  }
  
  fetch(`/api/orders/${orderId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => {
    if (res.ok) {
      return res.json().then(data => {
        renderOrderDetails(data);
        const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
        modal.show();
      });
    } else {
      return res.json().then(data => {
        showNotification(data.message || 'Failed to load order details', 'error');
      });
    }
  })
  .catch(error => {
    console.error('Error loading order details:', error);
    showNotification('Failed to load order details', 'error');
  });
}

function renderOrderDetails(order) {
  const content = document.getElementById('orderDetailsContent');
  content.innerHTML = `
    <div class="row">
      <div class="col-md-6 mb-3">
        <h6 class="fw-bold">Order Information</h6>
        <p><strong>Order ID:</strong> ${order.id.substring(0, 8)}</p>
        <p><strong>Shop:</strong> ${order.shop_name || 'N/A'}</p>
        <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(order.status)}">${getStatusLabel(order.status)}</span></p>
        <p><strong>Payment Status:</strong> <span class="badge ${order.payment_status === 'paid' ? 'bg-success' : 'bg-warning'}">${order.payment_status}</span></p>
        <p><strong>Payment Method:</strong> ${order.payment_method || 'N/A'}</p>
        <p><strong>Order Date:</strong> ${formatDate(order.created_at)}</p>
        ${order.confirmed_at ? `<p><strong>Confirmed:</strong> ${formatDate(order.confirmed_at)}</p>` : ''}
        ${order.delivered_at ? `<p><strong>Delivered:</strong> ${formatDate(order.delivered_at)}</p>` : ''}
      </div>
      
      <div class="col-md-6 mb-3">
        <h6 class="fw-bold">Delivery Information</h6>
        <p><strong>Address:</strong> ${order.delivery_address}</p>
        <p><strong>Contact:</strong> ${order.contact_phone}</p>
        ${order.delivery_partner ? `
          <div class="mt-3 p-3 bg-light rounded">
            <h6 class="fw-bold">Delivery Partner</h6>
            <p class="mb-1"><strong>Name:</strong> ${order.delivery_partner.name || 'N/A'}</p>
            <p class="mb-1"><strong>Phone:</strong> ${order.delivery_partner.phone || 'N/A'}</p>
            <p class="mb-1"><strong>Vehicle:</strong> ${order.delivery_partner.vehicle_type || 'N/A'} - ${order.delivery_partner.vehicle_number || 'N/A'}</p>
            <p class="mb-0"><strong>Rating:</strong> ${order.delivery_partner.rating || 'N/A'}</p>
          </div>
        ` : '<p class="text-muted">Delivery partner not assigned yet</p>'}
      </div>
    </div>
    
    <div class="row mt-3">
      <div class="col-12">
        <h6 class="fw-bold">Order Items</h6>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${order.items.map(item => `
              <tr>
                <td>${item.product_name || 'Product'}</td>
                <td>${item.quantity}</td>
                <td>₹${item.price}</td>
                <td>₹${item.total_price || (item.price * item.quantity)}</td>
              </tr>
            `).join('')}
            <tr class="table-primary">
              <td colspan="3" class="text-end fw-bold">Total:</td>
              <td class="fw-bold">₹${order.total_amount.toFixed(2)}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function retryPayment(orderId, amount) {
  const token = getAuthToken();
  if (!token) {
    showNotification('Please login', 'error');
    return;
  }
  
  // Create Razorpay order
  fetch('/payments/razorpay/create-order-shop', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      amount: Math.round(amount * 100), // Convert to paise
      currency: 'INR',
      order_id: orderId
    })
  })
  .then(async res => {
    const responseData = await res.json().catch(() => ({ message: 'Failed to parse response' }));
    
    if (!res.ok) {
      // Check if it's a configuration error
      if (responseData.error === 'invalid_key_config' || responseData.error === 'invalid_credentials') {
        throw new Error('Payment gateway is not properly configured. Please contact support or use Cash on Delivery.');
      }
      throw new Error(responseData.message || `Server error: ${res.status}`);
    }
    
    // Validate response data before proceeding
    if (!responseData.key_id) {
      console.error('Missing key_id in payment order response:', responseData);
      throw new Error('Payment gateway configuration error. Missing API key.');
    }
    
    if (!responseData.id) {
      console.error('Missing order_id in payment order response:', responseData);
      throw new Error('Failed to create payment order. Missing order ID.');
    }
    
    // Check if key_id is a placeholder
    if (responseData.key_id.includes('your_live_key_id_here') || responseData.key_id.includes('placeholder')) {
      throw new Error('Payment gateway is not properly configured. Please contact support or use Cash on Delivery.');
    }
    
    return responseData;
  })
  .then(paymentOrderData => {
    console.log('Payment order data:', paymentOrderData);
    
    if (typeof Razorpay === 'undefined') {
      showNotification('Razorpay SDK not loaded. Please refresh the page.', 'error');
      return;
    }
    
    const options = {
      key: paymentOrderData.key_id,
      amount: paymentOrderData.amount,
      currency: paymentOrderData.currency || 'INR',
      name: 'Hofix Shop',
      description: `Payment for order ${orderId.substring(0, 8)}`,
      order_id: paymentOrderData.id,
      handler: async function(razorpayResponse) {
        try {
          const verifyResponse = await fetch('/payments/razorpay/verify-shop', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              razorpay_payment_id: razorpayResponse.razorpay_payment_id,
              razorpay_order_id: razorpayResponse.razorpay_order_id,
              razorpay_signature: razorpayResponse.razorpay_signature,
              order_id: orderId
            })
          });
          
          const verifyData = await verifyResponse.json();
          if (verifyResponse.ok && verifyData.status === 'Success') {
            showNotification('Payment successful!', 'success');
            setTimeout(() => {
              loadOrders();
            }, 1000);
          } else {
            showNotification(verifyData.message || 'Payment verification failed', 'error');
          }
        } catch (error) {
          console.error('Payment verification error:', error);
          showNotification('Payment verification failed', 'error');
        }
      },
      theme: {
        color: '#0d6efd'
      },
      modal: {
        ondismiss: function() {
          showNotification('Payment cancelled', 'warning');
        }
      }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
  })
  .catch(error => {
    console.error('Payment error:', error);
    let errorMessage = 'Failed to initiate payment';
    
    // Handle specific error cases
    if (error.message) {
      errorMessage = error.message;
      // Check for configuration errors
      if (error.message.includes('configuration') || error.message.includes('configured')) {
        errorMessage = 'Payment gateway is not properly configured. Please contact support or use Cash on Delivery.';
      }
    }
    
    showNotification(errorMessage, 'error');
  });
}

function trackOrder(orderId) {
  const token = getAuthToken();
  if (!token) {
    showNotification('Please login', 'error');
    return;
  }
  
  fetch(`/api/orders/${orderId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => {
    if (res.ok) {
      return res.json().then(data => {
        renderTrackOrder(data);
        const modal = new bootstrap.Modal(document.getElementById('trackOrderModal'));
        modal.show();
      });
    } else {
      return res.json().then(data => {
        showNotification(data.message || 'Failed to load order tracking', 'error');
      });
    }
  })
  .catch(error => {
    console.error('Error loading order tracking:', error);
    showNotification('Failed to load order tracking', 'error');
  });
}

function renderTrackOrder(order) {
  const content = document.getElementById('trackOrderContent');
  
  // Order status timeline
  const statusSteps = [
    { key: 'pending', label: 'Order Placed', icon: 'fa-shopping-cart' },
    { key: 'confirmed', label: 'Order Confirmed', icon: 'fa-check-circle' },
    { key: 'preparing', label: 'Preparing', icon: 'fa-box' },
    { key: 'ready', label: 'Ready for Pickup', icon: 'fa-box-open' },
    { key: 'assigned', label: 'Assigned to Delivery', icon: 'fa-user-tie' },
    { key: 'out_for_delivery', label: 'Out for Delivery', icon: 'fa-truck' },
    { key: 'delivered', label: 'Delivered', icon: 'fa-check-double' }
  ];
  
  const currentStatusIndex = statusSteps.findIndex(step => step.key === order.status);
  
  const statusTimeline = statusSteps.map((step, index) => {
    const isActive = index <= currentStatusIndex;
    const isCurrent = index === currentStatusIndex;
    return `
      <div class="d-flex align-items-center mb-3 ${isActive ? 'text-primary' : 'text-muted'}">
        <div class="me-3">
          <i class="fas ${step.icon} fa-2x ${isActive ? '' : 'opacity-50'}"></i>
        </div>
        <div class="flex-grow-1">
          <h6 class="mb-0 ${isActive ? 'fw-bold' : ''}">${step.label}</h6>
          ${isCurrent ? '<small class="text-success">Current Status</small>' : ''}
        </div>
        ${isActive ? '<i class="fas fa-check-circle text-success fa-lg"></i>' : ''}
      </div>
      ${index < statusSteps.length - 1 ? `<div class="ms-4 mb-3 ${isActive ? 'border-start border-primary border-2' : 'border-start border-secondary border-2'} ps-3" style="height: 30px;"></div>` : ''}
    `;
  }).join('');
  
  content.innerHTML = `
    <div class="row">
      <div class="col-md-6 mb-4">
        <h6 class="fw-bold mb-3">Order Information</h6>
        <p><strong>Order ID:</strong> #${order.id.substring(0, 8)}</p>
        <p><strong>Shop:</strong> ${order.shop_name || 'N/A'}</p>
        <p><strong>Total Amount:</strong> ₹${order.total_amount.toFixed(2)}</p>
        <p><strong>Order Date:</strong> ${formatDate(order.created_at)}</p>
        ${order.confirmed_at ? `<p><strong>Confirmed:</strong> ${formatDate(order.confirmed_at)}</p>` : ''}
        ${order.delivered_at ? `<p><strong>Delivered:</strong> ${formatDate(order.delivered_at)}</p>` : ''}
      </div>
      
      <div class="col-md-6 mb-4">
        <h6 class="fw-bold mb-3">Delivery Information</h6>
        <p><strong>Address:</strong> ${order.delivery_address}</p>
        <p><strong>Contact:</strong> ${order.contact_phone}</p>
      </div>
    </div>
    
    <hr>
    
    <div class="mb-4">
      <h6 class="fw-bold mb-3">Order Status</h6>
      <div class="status-timeline">
        ${statusTimeline}
      </div>
    </div>
    
    ${order.delivery_partner ? `
      <hr>
      <div class="bg-light p-4 rounded">
        <h6 class="fw-bold mb-3">
          <i class="fas fa-user-tie me-2"></i>Delivery Partner
        </h6>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-2"><strong>Name:</strong> ${order.delivery_partner.name || 'N/A'}</p>
            <p class="mb-2"><strong>Phone:</strong> 
              <a href="tel:${order.delivery_partner.phone || ''}" class="text-decoration-none">
                ${order.delivery_partner.phone || 'N/A'}
              </a>
            </p>
          </div>
          <div class="col-md-6">
            <p class="mb-2"><strong>Vehicle:</strong> ${order.delivery_partner.vehicle_type || 'N/A'} - ${order.delivery_partner.vehicle_number || 'N/A'}</p>
            <p class="mb-0">
              <strong>Rating:</strong> 
              ${Array(5).fill(0).map((_, i) => 
                i < Math.floor(order.delivery_partner.rating || 0) 
                  ? '<i class="fas fa-star text-warning"></i>' 
                  : '<i class="far fa-star text-warning"></i>'
              ).join('')}
              <span class="ms-2">${(order.delivery_partner.rating || 0).toFixed(1)}</span>
            </p>
          </div>
        </div>
        ${order.status === 'out_for_delivery' ? `
          <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Your order is on the way! The delivery partner will contact you soon.
          </div>
        ` : ''}
      </div>
    ` : `
      <div class="alert alert-warning">
        <i class="fas fa-clock me-2"></i>
        Delivery partner will be assigned shortly. Please wait...
      </div>
    `}
    
    <div class="mt-4">
      <h6 class="fw-bold mb-3">Order Items</h6>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${order.items.map(item => `
            <tr>
              <td>${item.product_name || 'Product'}</td>
              <td>${item.quantity}</td>
              <td>₹${item.price}</td>
              <td>₹${item.total_price || (item.price * item.quantity)}</td>
            </tr>
          `).join('')}
          <tr class="table-primary">
            <td colspan="3" class="text-end fw-bold">Total:</td>
            <td class="fw-bold">₹${order.total_amount.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

// Load orders on page load
document.addEventListener('DOMContentLoaded', function() {
  loadOrders();
});
</script>

<style>
.card {
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}

