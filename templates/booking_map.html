{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Header Section -->
  <section class="py-4 bg-white border-bottom">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-2">
            <a href="/" class="btn btn-outline-secondary btn-sm me-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
            <h2 class="mb-0 fw-bold text-primary">Choose Your Service Provider</h2>
          </div>
          <p class="text-muted mb-0">Select from verified professionals in your area</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="booking-summary-card p-3 rounded-4 bg-light border">
            <div class="d-flex align-items-center mb-2">
              <div class="service-icon-small me-3">
                <i id="serviceIcon" class="fas fa-tools text-primary"></i>
              </div>
              <div>
                <h6 class="mb-0 fw-bold" id="serviceName">Service</h6>
                <small class="text-muted" id="serviceCategory">Category</small>
              </div>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Starting from:</span>
              <span class="fw-bold text-primary" id="servicePrice">â‚¹0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Map and Provider Selection -->
  <section class="py-4">
    <div class="container-fluid">
      <div class="row g-0">
        <!-- Map Section -->
        <div class="col-lg-8">
          <div class="map-container position-relative">
            <div id="map" style="height: 70vh; border-radius: 0.75rem; overflow: hidden;"></div>
            <div class="map-controls position-absolute top-0 end-0 m-3">
              <button id="locateBtn" class="btn btn-light shadow-sm rounded-pill" title="Use my location">
                <i class="fas fa-crosshairs"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Provider List Section -->
        <div class="col-lg-4">
          <div class="provider-panel h-100 bg-white border-start">
            <div class="p-4 border-bottom">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0 fw-bold">Available Providers</h5>
                <span class="badge bg-primary" id="providerCount">0</span>
              </div>
              <div class="search-box mb-3">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input type="text" class="form-control border-start-0" id="providerSearch" placeholder="Search providers...">
                </div>
              </div>
              <div class="service-filter">
                <select class="form-select form-select-sm" id="serviceFilter">
                  <option value="">All Services</option>
                </select>
              </div>
            </div>
            
            <div class="provider-list p-4" style="max-height: calc(70vh - 140px); overflow-y: auto;">
              <div id="providerList" class="vstack gap-3">
                <!-- Providers will be loaded here -->
              </div>
              
              <div id="noProviders" class="text-center py-5 d-none">
                <div class="mb-3">
                  <i class="fas fa-map-marker-alt text-muted" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-muted">No providers found</h6>
                <p class="text-muted small">Try adjusting your location or check back later</p>
              </div>
              
              <div id="loadingProviders" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted small mt-2">Finding providers...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Booking Form Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Confirm Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="provider-info-card p-3 rounded-3 bg-light">
                <div class="d-flex align-items-center mb-3">
                  <div class="provider-avatar me-3">
                    <img id="modalProviderAvatar" src="" alt="Provider" class="rounded-circle" width="50">
                  </div>
                  <div>
                    <h6 class="mb-0 fw-bold" id="modalProviderName">Provider Name</h6>
                    <div class="rating mb-1">
                      <i class="fas fa-star text-warning"></i>
                      <span id="modalProviderRating" class="ms-1">4.9</span>
                      <span class="text-muted ms-2" id="modalProviderJobs">(50 jobs)</span>
                    </div>
                  </div>
                </div>
                <div class="skills">
                  <small class="text-muted">Skills:</small>
                  <div id="modalProviderSkills" class="mt-1"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <form id="bookingForm">
                <input type="hidden" id="bookingTypeInput" value="hourly">
                <div class="mb-3">
                  <label class="form-label fw-semibold">When do you need this service?</label>
                  <select class="form-select" id="urgencySelect" required>
                    <option value="">Select urgency</option>
                    <option value="emergency">ðŸš¨ Emergency (ASAP)</option>
                    <option value="today">ðŸ“… Today</option>
                    <option value="tomorrow">ðŸ“… Tomorrow</option>
                    <option value="this-week">ðŸ“… This Week</option>
                  </select>
                </div>
                <div class="mb-3" id="durationSection">
                  <label class="form-label fw-semibold">Estimated Duration</label>
                  <select class="form-select" id="durationSelect">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="4" selected>4 hours</option>
                    <option value="8">Full day</option>
                  </select>
                </div>
                <div class="mb-3 d-none" id="dailyBookingInfo">
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Daily Booking:</strong> This booking is for a full day.
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Special Instructions</label>
                  <textarea class="form-control" id="bookingNotes" rows="3" placeholder="Any specific requirements or notes..."></textarea>
                </div>
                <div class="price-summary p-3 rounded-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Estimated Total:</span>
                    <span class="h5 mb-0 text-primary fw-bold" id="estimatedTotal">â‚¹0</span>
                  </div>
                  <small class="text-muted">Final price may vary based on job complexity</small>
                </div>
              </form>
            </div>
          </div>
        </div>
                <div class="modal-footer border-0 pt-0">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-outline-success" id="trackProviderBtn" style="display: none;">
                    <i class="fas fa-map-marker-alt me-2"></i>Track Provider
                  </button>
                  <button type="button" class="btn btn-primary btn-lg px-4" id="confirmBookingBtn">
                    <i class="fas fa-calendar-check me-2"></i>Confirm Booking
                  </button>
                </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Service icons mapping
const serviceIcons = {
  'Electrician': 'fas fa-bolt',
  'Plumber': 'fas fa-wrench',
  'Carpenter': 'fas fa-hammer',
  'Cleaner': 'fas fa-broom',
  'Painter': 'fas fa-paint-brush',
  'AC Repair': 'fas fa-snowflake'
};

// Global variables
let map;
let userLocation = null;
let providers = [];
let selectedProvider = null;
let serviceData = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', async function() {
  // Get service data from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const serviceId = urlParams.get('service_id');
  const serviceType = urlParams.get('service_type');
  const urgency = urlParams.get('urgency');
  const location = urlParams.get('location');
  const lat = urlParams.get('lat');
  const lon = urlParams.get('lon');
  const preferredDate = urlParams.get('preferred_date');
  const preferredTime = urlParams.get('preferred_time');
  const bookingType = urlParams.get('booking_type') || 'hourly'; // 'hourly' or 'daily'
  
  // Store booking preferences
  window.bookingPreferences = {
    urgency: urgency,
    location: location,
    lat: lat ? parseFloat(lat) : null,
    lon: lon ? parseFloat(lon) : null,
    preferredDate: preferredDate,
    preferredTime: preferredTime
  };
  
  if (serviceId) {
    await loadServiceData(serviceId);
  } else if (serviceType) {
    // Create mock service data for direct booking from home
    serviceData = {
      id: serviceType,
      name: serviceType.charAt(0).toUpperCase() + serviceType.slice(1),
      category: getServiceCategory(serviceType),
      base_price: getServicePrice(serviceType)
    };
  }
  
  // Set booking type from URL
  if (bookingType === 'daily') {
    document.getElementById('bookingTypeInput').value = 'daily';
    document.getElementById('durationSection').classList.add('d-none');
    document.getElementById('dailyBookingInfo').classList.remove('d-none');
  }
  
  updateServiceSummary();
  initializeMap();
  await loadAvailableServices();
  
  // Show booking preferences if available
  if (urgency || location) {
    showBookingPreferences();
  }
  
  // Don't load providers here - let the map initialization handle it
});

// Show booking preferences
function showBookingPreferences() {
  const preferences = window.bookingPreferences;
  if (!preferences) return;
  
  // Create preferences display
  const preferencesHtml = `
    <div class="booking-preferences-card p-3 rounded-4 bg-light border mb-4">
      <h6 class="fw-bold mb-3">ðŸ“‹ Your Booking Preferences</h6>
      <div class="row g-2">
        <div class="col-md-4">
          <small class="text-muted">Service Urgency:</small>
          <div class="fw-semibold">${getUrgencyDisplay(preferences.urgency)}</div>
        </div>
        <div class="col-md-4">
          <small class="text-muted">Location:</small>
          <div class="fw-semibold">${preferences.location || 'Not specified'}</div>
        </div>
        ${preferences.preferredDate ? `
        <div class="col-md-4">
          <small class="text-muted">Scheduled:</small>
          <div class="fw-semibold">${formatDate(preferences.preferredDate)} ${getTimeDisplay(preferences.preferredTime)}</div>
        </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Insert before the map section
  const mapSection = document.querySelector('.map-container');
  if (mapSection) {
    mapSection.insertAdjacentHTML('beforebegin', preferencesHtml);
  }
}

// Helper functions for display
function getUrgencyDisplay(urgency) {
  const urgencyMap = {
    'emergency': 'ðŸš¨ Emergency (ASAP)',
    'today': 'ðŸ“… Today',
    'tomorrow': 'ðŸ“… Tomorrow',
    'scheduled': 'ðŸ“… Scheduled'
  };
  return urgencyMap[urgency] || urgency;
}

function getTimeDisplay(time) {
  const timeMap = {
    'morning': 'ðŸŒ… Morning (8 AM - 12 PM)',
    'afternoon': 'â˜€ï¸ Afternoon (12 PM - 5 PM)',
    'evening': 'ðŸŒ† Evening (5 PM - 8 PM)'
  };
  return timeMap[time] || time;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-IN', { 
    weekday: 'short', 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}

// Load service data
async function loadServiceData(serviceId) {
  try {
    console.log('Loading service data for ID:', serviceId);
    const response = await fetch('/api/services');
    const services = await response.json();
    console.log('Available services:', services);
    serviceData = services.find(s => s.id === serviceId);
    console.log('Found service data:', serviceData);
    
    if (!serviceData) {
      console.error('Service not found for ID:', serviceId);
      alert('Service not found. Please try again.');
      return;
    }
  } catch (error) {
    console.error('Error loading service data:', error);
    alert('Error loading service information. Please try again.');
  }
}

// Get service category and price
function getServiceCategory(serviceType) {
  const categories = {
    'electrician': 'Electrical',
    'plumber': 'Plumbing',
    'carpenter': 'Woodwork',
    'cleaner': 'Cleaning',
    'painter': 'Painting',
    'ac': 'AC Repair'
  };
  return categories[serviceType] || 'Professional Service';
}

function getServicePrice(serviceType) {
  const prices = {
    'electrician': 500,
    'plumber': 450,
    'carpenter': 600,
    'cleaner': 300,
    'painter': 400,
    'ac': 800
  };
  return prices[serviceType] || 500;
}

// Update service summary
function updateServiceSummary() {
  if (!serviceData) return;
  
  const icon = serviceIcons[serviceData.name] || 'fas fa-tools';
  document.getElementById('serviceIcon').className = icon;
  document.getElementById('serviceName').textContent = serviceData.name;
  document.getElementById('serviceCategory').textContent = serviceData.category || '';
  document.getElementById('servicePrice').textContent = `â‚¹${serviceData.base_price}`;
}

// Initialize map
function initializeMap() {
  // Load Google Maps API if not already loaded
  if (typeof google === 'undefined') {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAG0GnKSwNcd_HtC1x1xVdzf-aWtzTIGBs&callback=initGoogleMap`;
    script.async = true;
    script.defer = true;
    script.onerror = function() {
      console.error('Failed to load Google Maps API');
      showMapError('Failed to load Google Maps API. Please check your internet connection.');
    };
    document.head.appendChild(script);
    window.initGoogleMap = () => {
      try {
        createGoogleMap();
      } catch (error) {
        console.error('Error creating Google Map:', error);
        showMapError('Error creating map: ' + error.message);
      }
    };
  } else {
    try {
      createGoogleMap();
    } catch (error) {
      console.error('Error creating Google Map:', error);
      showMapError('Error creating map: ' + error.message);
    }
  }
}

function showMapError(message = 'Map Loading Error') {
  const mapDiv = document.getElementById('map');
  mapDiv.innerHTML = `
    <div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">
      <div class="text-center">
        <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">${message}</h5>
        <p class="text-muted small">Please check the browser console for technical details</p>
        <div class="alert alert-warning mt-3">
          <strong>Google Maps API Issue:</strong><br>
          â€¢ Check if billing is enabled in Google Cloud Console<br>
          â€¢ Ensure Maps JavaScript API is enabled<br>
          â€¢ Verify API key restrictions allow your domain<br>
          â€¢ Check browser console for specific error details
        </div>
        <button class="btn btn-primary btn-sm" onclick="initializeMap()">Retry</button>
      </div>
    </div>
  `;
}

function createGoogleMap() {
  // Check if Google Maps is loaded
  if (typeof google === 'undefined' || !google.maps) {
    throw new Error('Google Maps API not loaded');
  }

  const mapOptions = {
    center: { lat: 28.6139, lng: 77.2090 },
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById('map'), mapOptions);
  
  // Map is now initialized
  
  // Add event listeners to restore markers when map changes
  map.addListener('idle', () => {
    console.log('Map idle event - checking markers');
    setTimeout(checkAndRestoreMarkers, 100);
  });
  
  // Start periodic marker check to restore disappeared markers
  setInterval(checkAndRestoreMarkers, 2000); // Check every 2 seconds
  
  // Start automatic location tracking
  startLocationTracking();
  
  // Add user location button
  document.getElementById('locateBtn').addEventListener('click', () => {
    getCurrentLocation();
  });
}

// Start location tracking (one-time only)
function startLocationTracking() {
  // Get initial location only, but don't update it automatically
  getCurrentLocation();
}

// Get current location and update map
function getCurrentLocation() {
  // Check if we have coordinates from booking preferences
  const preferences = window.bookingPreferences;
  if (preferences && preferences.lat && preferences.lon) {
    console.log('Using coordinates from booking preferences:', preferences.lat, preferences.lon);
    const lat = preferences.lat;
    const lon = preferences.lon;
    
    userLocation = { lat, lon };
    
    // Only center map if it's the first time or if user location hasn't been set
    if (!window.userLocationSet) {
      map.setCenter({ lat: lat, lng: lon });
      map.setZoom(15);
      window.userLocationSet = true;
    }
    
    // Clear existing user location marker
    if (window.userLocationMarker) {
      window.userLocationMarker.setMap(null);
    }
    
    // Add new user location marker
    window.userLocationMarker = new google.maps.Circle({
      center: { lat: lat, lng: lon },
      radius: 50, // 50 meters radius
      strokeColor: '#0d6efd',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#0d6efd',
      fillOpacity: 0.3,
      map: map
    });
    
    // Add info window for user location
    const infoWindow = new google.maps.InfoWindow({
      content: preferences.location || 'Selected location'
    });
    
    // Add click listener to show info window
    window.userLocationMarker.addListener('click', () => {
      infoWindow.open(map, window.userLocationMarker);
    });
    
        // Load providers within 15km (with longer delay to ensure map is stable)
        setTimeout(() => {
          console.log('Loading providers for booking preferences location:', lat, lon);
          if (!window.providersLoaded) {
            loadProviders(lat, lon);
            window.providersLoaded = true;
          }
        }, 1000);

    // Update location display
    updateLocationDisplay(lat, lon);
    return;
  }
  
  // Fallback to browser geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        // Only center map on first location, don't re-center on subsequent updates
        if (!userLocation && !window.userLocationSet) {
          map.setCenter({ lat: lat, lng: lon });
          map.setZoom(15);
          window.userLocationSet = true;
        }
        
        userLocation = { lat, lon };
        
        // Clear existing user location marker
        if (window.userLocationMarker) {
          window.userLocationMarker.setMap(null);
        }
        
        // Add new user location marker
        window.userLocationMarker = new google.maps.Circle({
          center: { lat: lat, lng: lon },
          radius: 50, // 50 meters radius
          strokeColor: '#0d6efd',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#0d6efd',
          fillOpacity: 0.3,
          map: map
        });
        
        // Add info window for user location
        const infoWindow = new google.maps.InfoWindow({
          content: 'Your location'
        });
        
        // Add click listener to show info window
        window.userLocationMarker.addListener('click', () => {
          infoWindow.open(map, window.userLocationMarker);
        });
        
        // Load providers within 15km (with longer delay to ensure map is stable)
        setTimeout(() => {
          console.log('Loading providers for geolocation:', lat, lon);
          if (!window.providersLoaded) {
        loadProviders(lat, lon);
            window.providersLoaded = true;
          }
        }, 1000);
        
        // Update location display
        updateLocationDisplay(lat, lon);
      },
      error => {
        console.log('Location access denied or error:', error);
        // Fallback to default location
        const defaultLat = 28.6139;
        const defaultLon = 77.2090;
        userLocation = { lat: defaultLat, lon: defaultLon };
        if (!window.userLocationSet) {
          map.setCenter({ lat: defaultLat, lng: defaultLon });
          map.setZoom(15);
          window.userLocationSet = true;
        }
        setTimeout(() => {
          console.log('Loading providers for default location:', defaultLat, defaultLon);
          if (!window.providersLoaded) {
        loadProviders(defaultLat, defaultLon);
            window.providersLoaded = true;
          }
        }, 1000);
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 1000
      }
    );
  } else {
    console.log('Geolocation not supported');
    // Fallback to default location
    const defaultLat = 28.6139;
    const defaultLon = 77.2090;
    userLocation = { lat: defaultLat, lon: defaultLon };
    if (!window.userLocationSet) {
      map.setCenter({ lat: defaultLat, lng: defaultLon });
      map.setZoom(15);
      window.userLocationSet = true;
    }
    setTimeout(() => {
      console.log('Loading providers for default location (no geolocation):', defaultLat, defaultLon);
      if (!window.providersLoaded) {
        loadProviders(defaultLat, defaultLon);
        window.providersLoaded = true;
      }
    }, 1000);
  }
}

// Update location display
function updateLocationDisplay(lat, lon) {
  // You can add a location display element if needed
  console.log(`Location updated: ${lat}, ${lon}`);
}

// Debounce function to prevent rapid API calls
let loadProvidersTimeout;
function debounceLoadProviders(lat, lon, serviceType = null) {
  // Clear existing timeout
  if (loadProvidersTimeout) {
    clearTimeout(loadProvidersTimeout);
  }
  
  // Set new timeout
  loadProvidersTimeout = setTimeout(() => {
    console.log('Debounced loadProviders called with:', { lat, lon, serviceType });
    loadProviders(lat, lon, serviceType);
  }, 500); // Wait 500ms before loading
}

// Function to check and restore markers if they disappear
function checkAndRestoreMarkers() {
  if (window.allProviders && window.allProviders.length > 0) {
    const visibleMarkers = window.providerMarkers ? window.providerMarkers.filter(marker => marker.getMap()) : [];
    console.log(`Checking markers: ${visibleMarkers.length} visible out of ${window.allProviders.length} expected`);
    
    if (visibleMarkers.length < window.allProviders.length) {
      console.log('Some markers disappeared, re-rendering...');
      providers = window.allProviders;
      renderProviders();
    }
  }
}

// Load available services for filter
async function loadAvailableServices() {
  try {
    const response = await fetch('/api/services');
    const services = await response.json();
    
    const select = document.getElementById('serviceFilter');
    select.innerHTML = '<option value="">All Services</option>';
    
    services.forEach(service => {
      const option = document.createElement('option');
      option.value = service.name.toLowerCase();
      option.textContent = service.name;
      select.appendChild(option);
    });
    
    // Set default service if coming from home page
    if (serviceData) {
      select.value = serviceData.name.toLowerCase();
      select.dispatchEvent(new Event('change'));
    }
  } catch (error) {
    console.error('Error loading available services:', error);
  }
}

// Load providers within 15km range
async function loadProviders(lat = null, lon = null, serviceType = null) {
  try {
    console.log('loadProviders called with:', { lat, lon, serviceType });
    
    // Prevent loading if already loading
    if (window.isLoadingProviders) {
      console.log('Providers already loading, skipping...');
      return;
    }
    
    window.isLoadingProviders = true;
    document.getElementById('loadingProviders').classList.remove('d-none');
    document.getElementById('noProviders').classList.add('d-none');
    
    const params = new URLSearchParams();
    if (lat && lon) {
      params.append('lat', lat);
      params.append('lon', lon);
      params.append('radius', '15'); // 15km radius to include more providers
    }
    if (serviceType) {
      params.append('service_type', serviceType);
    }
    
    console.log(`Loading providers with params: ${params.toString()}`);
    const response = await fetch(`/providers/nearby?${params.toString()}`);
    console.log(`API Response status: ${response.status}`);
    const data = await response.json();
    console.log(`API Response data:`, data);
    providers = data.providers || data || [];
    
    // Filter providers within 15km using Haversine formula
    if (lat && lon) {
      providers = providers.filter(provider => {
        if (!provider.lat || !provider.lon) return false;
        const distance = calculateDistance(lat, lon, provider.lat, provider.lon);
        return distance <= 15; // 15km
      });
    }
    
    console.log(`Loaded ${providers.length} providers within 15km:`, providers);
    
    renderProviders();
    updateProviderCount();
    
    document.getElementById('loadingProviders').classList.add('d-none');
    if (providers.length === 0) {
      document.getElementById('noProviders').classList.remove('d-none');
      console.log('No providers found within 15km - showing empty state');
    }
  } catch (error) {
    console.error('Error loading providers:', error);
    document.getElementById('loadingProviders').classList.add('d-none');
    document.getElementById('noProviders').classList.remove('d-none');
  } finally {
    // Reset loading flag
    window.isLoadingProviders = false;
  }
}

// Calculate distance between two coordinates using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // Distance in kilometers
}

// Render providers on map and list
function renderProviders() {
  console.log('Rendering providers:', providers.length, 'providers');
  
  // Check if map is initialized
  if (!map) {
    console.log('Map not initialized yet, skipping provider rendering');
    return;
  }
  
  // Clear existing markers
  if (window.providerMarkers) {
    console.log('Clearing existing markers:', window.providerMarkers.length);
    window.providerMarkers.forEach(marker => marker.setMap(null));
  }
  window.providerMarkers = [];
  
  // Store providers globally for re-rendering
  window.allProviders = providers;
  
  const providerList = document.getElementById('providerList');
  providerList.innerHTML = '';
  
  providers.forEach((provider, index) => {
    console.log(`Rendering provider ${index + 1}:`, provider.name, 'at', provider.lat, provider.lon);
    // Add marker to map with persistent settings
    const marker = new google.maps.Marker({
      position: { lat: provider.lat, lng: provider.lon },
      map: map,
      title: provider.name,
      animation: google.maps.Animation.DROP,
      optimized: false, // Prevents marker from being optimized away
      zIndex: 1000 + index // Higher z-index to keep markers on top
    });
    
    // Add a unique ID to the marker for tracking
    marker.providerId = provider.id;
    
    const popupContent = `
      <div class="provider-popup">
        <div class="d-flex align-items-center mb-2">
          <img src="${provider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + provider.name}" 
               class="rounded-circle me-2" width="40" alt="${provider.name}">
          <div>
            <h6 class="mb-0 fw-bold">${provider.name}</h6>
            <div class="rating">
              <i class="fas fa-star text-warning"></i>
              <span class="ms-1">${provider.rating}</span>
              <span class="text-muted ms-2">(${provider.jobs_count} jobs)</span>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Skills:</small>
          <div class="skills mt-1">
            ${provider.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold text-primary">â‚¹${provider.hourly_rate || serviceData.base_price}/hr</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="selectProvider('${provider.id}')">
            Select
          </button>
        </div>
      </div>
    `;
    
    const infoWindow = new google.maps.InfoWindow({
      content: popupContent
    });
    
    marker.addListener('click', () => {
      infoWindow.open(map, marker);
    });
    
    window.providerMarkers.push(marker);
    
    // Add to provider list
    const providerCard = document.createElement('div');
    providerCard.className = 'provider-card p-3 rounded-3 border hover-lift';
    providerCard.innerHTML = `
      <div class="d-flex align-items-center mb-3">
        <img src="${provider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + provider.name}" 
             class="rounded-circle me-3" width="50" alt="${provider.name}">
        <div class="flex-grow-1">
          <h6 class="mb-0 fw-bold">${provider.name}</h6>
          <div class="rating mb-1">
            <i class="fas fa-star text-warning"></i>
            <span class="ms-1">${provider.rating}</span>
            <span class="text-muted ms-2">(${provider.jobs_count} jobs)</span>
          </div>
          <div class="text-muted small">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${provider.distance_km ? provider.distance_km.toFixed(1) + ' km away' : 'Distance unknown'}
          </div>
        </div>
        <div class="text-end">
          <div class="fw-bold text-primary mb-1">â‚¹${provider.hourly_rate || serviceData.base_price}/hr</div>
          <button class="btn btn-outline-primary btn-sm" onclick="selectProvider('${provider.id}')">
            Select
          </button>
        </div>
      </div>
      <div class="skills">
        <small class="text-muted">Skills:</small>
        <div class="mt-1">
          ${provider.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
        </div>
      </div>
    `;
    
    providerList.appendChild(providerCard);
    
    // Add click handler to center map on provider
    providerCard.addEventListener('click', () => {
      map.setCenter({ lat: provider.lat, lng: provider.lon });
      map.setZoom(15);
      infoWindow.open(map, marker);
    });
  });
}

// Update provider count
function updateProviderCount() {
  document.getElementById('providerCount').textContent = providers.length;
}

// Select provider
function selectProvider(providerId) {
  console.log('Selecting provider:', providerId);
  console.log('Available providers:', providers);
  selectedProvider = providers.find(p => p.id === providerId);
  console.log('Selected provider:', selectedProvider);
  
  if (!selectedProvider) {
    console.error('Provider not found:', providerId);
    alert('Provider not found. Please try again.');
    return;
  }
  
  // Update modal with provider info
  document.getElementById('modalProviderAvatar').src = selectedProvider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + selectedProvider.name;
  document.getElementById('modalProviderName').textContent = selectedProvider.name;
  document.getElementById('modalProviderRating').textContent = selectedProvider.rating;
  document.getElementById('modalProviderJobs').textContent = `(${selectedProvider.jobs_count} jobs)`;
  
  const skillsContainer = document.getElementById('modalProviderSkills');
  skillsContainer.innerHTML = selectedProvider.skills.map(skill => 
    `<span class="badge bg-light text-dark me-1">${skill}</span>`
  ).join('');
  
          updateEstimatedPrice();
          
          // Show track provider button if provider is selected
          const trackBtn = document.getElementById('trackProviderBtn');
          trackBtn.style.display = 'inline-block';
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
          modal.show();
}

// Update estimated price
function updateEstimatedPrice() {
  const bookingType = document.getElementById('bookingTypeInput').value;
  
  if (bookingType === 'daily') {
    // Calculate daily rate estimate (8 hours)
    const hourlyRate = selectedProvider.hourly_rate || serviceData.base_price || 0;
    const dailyRate = hourlyRate * 8;
    document.getElementById('estimatedTotal').textContent = `â‚¹${dailyRate}`;
  } else {
    // Use hourly rate calculation
    const duration = parseInt(document.getElementById('durationSelect').value);
    const hourlyRate = selectedProvider.hourly_rate || serviceData.base_price;
    const estimatedTotal = hourlyRate * duration;
    document.getElementById('estimatedTotal').textContent = `â‚¹${estimatedTotal}`;
  }
}

// Track provider button
document.getElementById('trackProviderBtn').addEventListener('click', function() {
  if (selectedProvider) {
    window.location.href = `/track-provider?provider_id=${selectedProvider.id}`;
  }
});

// Confirm booking
document.getElementById('confirmBookingBtn').addEventListener('click', async function() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  if (!selectedProvider) {
    alert('Please select a provider');
    return;
  }
  
  const bookingType = document.getElementById('bookingTypeInput').value;
  let price = 0;
  
  if (bookingType === 'daily') {
    // Calculate price for daily booking (8 hours)
    const hourlyRate = selectedProvider.hourly_rate || serviceData.base_price || 0;
    price = hourlyRate * 8;
  } else {
    // Calculate price for hourly booking
    const duration = parseInt(document.getElementById('durationSelect').value);
    price = (selectedProvider?.hourly_rate || serviceData?.base_price || 0) * duration;
  }
  
  // Validate user location before creating booking
  if (!userLocation || !userLocation.lat || !userLocation.lon) {
    alert('âš ï¸ Location is required for booking. Please allow location access or select a location on the map.');
    
    // Try to get location one more time
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };
          console.log('Got location after retry:', userLocation);
          // Retry booking creation
          document.getElementById('confirmBookingBtn').click();
        },
        error => {
          console.error('Location still not available:', error);
          alert('Please enable location permissions or contact support.');
        }
      );
    }
    return;
  }
  
  const bookingData = {
    service_id: serviceData?.id,
    provider_id: selectedProvider?.id,
    urgency: document.getElementById('urgencySelect').value,
    duration: bookingType === 'daily' ? 1 : parseInt(document.getElementById('durationSelect').value),
    notes: document.getElementById('bookingNotes').value,
    location_lat: userLocation.lat,
    location_lon: userLocation.lon,
    price: price,
    booking_type: bookingType
  };
  
  console.log('User location being sent:', userLocation);
  console.log('Booking data with location:', { location_lat: bookingData.location_lat, location_lon: bookingData.location_lon });
  
  console.log('Sending booking data:', bookingData);
  console.log('Selected provider:', selectedProvider);
  console.log('Service data:', serviceData);
  
  // Validate required data
  if (!bookingData.service_id) {
    console.error('Missing service_id');
    alert('Service information is missing. Please try again.');
    return;
  }
  
  if (!bookingData.provider_id) {
    console.error('Missing provider_id');
    alert('Provider information is missing. Please select a provider.');
    return;
  }
  
  try {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';
    
    const response = await fetch('/bookings/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(bookingData)
    });
    
    const result = await response.json();
    console.log('Booking response:', result);
    console.log('Response status:', response.status);
    
    if (response.ok) {
      // Show success message
      alert('Booking confirmed! Your provider will be notified.');
      console.log('Booking created successfully, redirecting to dashboard');
      window.location.href = '/dashboard/user/new';
    } else {
      console.error('Booking failed:', result);
      console.error('Response status:', response.status);
      console.error('Response headers:', response.headers);
      
      let errorMessage = 'Booking failed. Please try again.';
      if (result.message) {
        errorMessage = result.message;
      } else if (response.status === 401) {
        errorMessage = 'Please login to continue';
        window.location.href = '/login';
        return;
      } else if (response.status === 400) {
        errorMessage = 'Invalid booking data. Please check your information.';
      }
      
      alert(errorMessage);
    }
  } catch (error) {
    console.error('Error creating booking:', error);
    alert('An error occurred. Please try again.');
  } finally {
    this.disabled = false;
    this.innerHTML = '<i class="fas fa-calendar-check me-2"></i>Confirm Booking';
  }
});

// Update price when duration changes
document.getElementById('durationSelect').addEventListener('change', updateEstimatedPrice);

// Search providers
document.getElementById('providerSearch').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const providerCards = document.querySelectorAll('.provider-card');
  
  providerCards.forEach(card => {
    const name = card.querySelector('h6').textContent.toLowerCase();
    const skills = card.textContent.toLowerCase();
    
    if (name.includes(searchTerm) || skills.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
});

// Service filter change
document.getElementById('serviceFilter').addEventListener('change', function() {
  const selectedService = this.value;
  const currentLocation = userLocation;
  
  if (currentLocation) {
    debounceLoadProviders(currentLocation.lat, currentLocation.lon, selectedService);
  } else {
    debounceLoadProviders(null, null, selectedService);
  }
});
</script>

<style>
.provider-card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.provider-card:hover {
  border-color: #0d6efd !important;
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.service-icon-small {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.provider-avatar img {
  width: 50px;
  height: 50px;
  object-fit: cover;
}

.booking-summary-card {
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.map-controls .btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.provider-panel {
  border-left: 1px solid rgba(0, 0, 0, 0.1);
}

.search-box .input-group-text {
  border-color: #dee2e6;
}

.price-summary {
  border: 1px solid rgba(0, 0, 0, 0.1);
}

@media (max-width: 992px) {
  .provider-panel {
    border-left: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  #map {
    height: 50vh !important;
  }
  
  .provider-list {
    max-height: 40vh !important;
  }
}
</style>
{% endblock %}
