{% extends 'base.html' %}
{% block content %}
<div class="provider-navigation-container">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-border text-primary mb-4" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading navigation...</p>
    </div>
  </div>

  <!-- Modern Header -->
  <header class="navigation-header">
    <div class="header-content">
      <div class="header-left">
        <a href="/dashboard/provider" class="btn-back">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        <div class="header-title">
          <h2>Navigate to Customer</h2>
          <p id="customerNameDisplay">Customer Name</p>
        </div>
      </div>
      <div id="routeInfo" class="route-info d-none">
        <div class="route-stat">
          <div class="stat-label">Distance</div>
          <div class="stat-value" id="routeDistance">--</div>
        </div>
        <div class="route-stat">
          <div class="stat-label">Duration</div>
          <div class="stat-value" id="routeDuration">--</div>
        </div>
      </div>
    </div>
  </header>

  <div class="navigation-layout">
    <div class="row g-0 flex-nowrap">
    <!-- Map Section -->
    <div class="col-lg-8 col-md-8">
      <div id="map" style="height: calc(100vh - 76px);"></div>
    </div>

    <!-- Modern Sidebar -->
    <aside class="col-lg-4 col-md-4 info-sidebar">
      <div class="sidebar-content">
        <!-- Customer Card -->
        <div class="info-card">
          <div class="card-header-modern">
            <i class="fas fa-user"></i>
            <h3>Customer</h3>
          </div>
          <div class="card-body-modern">
            <div class="info-item">
              <strong id="customerName">--</strong>
            </div>
            <a id="customerPhoneDisplay" href="#" class="phone-link">
              <i class="fas fa-phone"></i>
              <span>Call Customer</span>
            </a>
          </div>
        </div>

        <!-- Booking Details Card -->
        <div class="info-card">
          <div class="card-header-modern">
            <i class="fas fa-briefcase"></i>
            <h3>Booking Details</h3>
          </div>
          <div class="card-body-modern">
            <div class="detail-row">
              <span class="detail-label">Service</span>
              <span class="detail-value" id="serviceName">--</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Price</span>
              <span class="detail-value price-value" id="bookingPrice">₹--</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status</span>
              <span class="status-badge" id="bookingStatus">--</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Scheduled</span>
              <span class="detail-value" id="scheduledTimeDisplay">--</span>
            </div>
          </div>
        </div>

        <!-- Directions Card -->
        <div class="info-card directions-card">
          <div class="card-header-modern">
            <i class="fas fa-route"></i>
            <h3>Directions</h3>
          </div>
          <div class="card-body-modern scrollable">
            <div id="directionsList" class="directions-list">
              <div class="loading-directions">
                <i class="fas fa-route spin-animation"></i>
                <p>Calculating route...</p>
              </div>
            </div>
          </div>
        </div>

               <!-- Action Buttons -->
               <div class="action-buttons">
                 <button id="startNavigationBtn" class="btn-primary-action" onclick="startNavigation()">
                   <i class="fas fa-route"></i>
                   <span>Start Navigation</span>
                 </button>
                 <button id="chatCustomerBtn" class="btn-chat-action" onclick="openChatModal()">
                   <i class="fas fa-comments"></i>
                   <span>Chat with Customer</span>
                 </button>
                 <button id="callCustomerBtn" class="btn-secondary-action" onclick="callCustomer()">
                   <i class="fas fa-phone"></i>
                   <span>Call Customer</span>
                 </button>
                 <button id="markArrivedBtn" class="btn-success-action d-none" onclick="markArrived()">
                   <i class="fas fa-check-circle"></i>
                   <span>Mark as Arrived</span>
                 </button>
                 <button id="startServiceBtn" class="btn-info-action d-none" onclick="startService()">
                   <i class="fas fa-play"></i>
                   <span>Start Service</span>
                 </button>
               </div>
      </div>
    </aside>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content chat-modal">
      <div class="modal-header chat-header">
        <div class="d-flex align-items-center">
          <div class="chat-avatar me-3">
            <img id="chatCustomerAvatar" src="" alt="Customer" class="rounded-circle">
            <div class="online-indicator"></div>
          </div>
          <div>
            <h5 class="modal-title mb-0" id="chatCustomerName">Customer Name</h5>
            <small class="opacity-75" id="chatCustomerService">Service</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body chat-body p-0">
        <div class="chat-messages" id="providerChatMessages">
          <!-- Messages will be loaded here -->
        </div>
        <div class="chat-typing-indicator d-none" id="providerTypingIndicator">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="typing-text">Customer is typing...</span>
        </div>
      </div>
      <div class="modal-footer chat-footer">
        <div class="w-100">
          <div class="input-group mb-2">
            <input type="text" class="form-control chat-input" id="providerMessageInput" 
                   placeholder="Type your message..." maxlength="500">
            <button class="btn btn-primary" type="button" id="providerSendBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="chat-actions">
            <button class="btn btn-outline-secondary btn-sm" id="providerAttachBtn">
              <i class="fas fa-paperclip me-1"></i>Attach
            </button>
            <button class="btn btn-outline-info btn-sm" id="providerLocationBtn">
              <i class="fas fa-map-marker-alt me-1"></i>Location
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.provider-navigation-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-content {
  text-align: center;
}

.loading-content .spinner-border {
  width: 4rem;
  height: 4rem;
}

/* Modern Header */
.navigation-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.25rem 2rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.btn-back {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-back:hover {
  background: rgba(255, 255, 255, 0.3);
  color: white;
  transform: translateX(-2px);
}

.header-title h2 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
}

.header-title p {
  margin: 0;
  opacity: 0.9;
  font-size: 0.875rem;
}

.route-info {
  display: flex;
  gap: 2rem;
  background: rgba(255, 255, 255, 0.15);
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  backdrop-filter: blur(10px);
}

.route-stat {
  text-align: center;
}

.stat-label {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 600;
}

/* Sidebar Styles */
.info-sidebar {
  background: #f8f9fa;
  border-left: 1px solid #e9ecef;
  padding: 0;
  overflow-y: auto;
  height: calc(100vh - 76px);
  display: block;
  position: relative;
}

.sidebar-content {
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Info Cards */
.info-card {
  background: white;
  border-radius: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  transition: all 0.3s ease;
}

.info-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.card-header-modern {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 1rem 1.25rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  border-bottom: 2px solid #e9ecef;
}

.card-header-modern i {
  font-size: 1.25rem;
  color: #667eea;
}

.card-header-modern h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #212529;
}

.card-body-modern {
  padding: 1.25rem;
}

.info-item {
  margin-bottom: 1rem;
  font-size: 1.125rem;
}

.phone-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #198754;
  text-decoration: none;
  padding: 0.5rem 1rem;
  background: #d1e7dd;
  border-radius: 0.5rem;
  transition: all 0.2s ease;
  font-weight: 500;
}

.phone-link:hover {
  background: #badbcc;
  color: #0f5132;
  transform: translateY(-1px);
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #f0f0f0;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  font-size: 0.875rem;
  color: #6c757d;
  font-weight: 500;
}

.detail-value {
  font-size: 0.95rem;
  font-weight: 600;
  color: #212529;
}

.price-value {
  color: #198754;
  font-size: 1.125rem;
}

.status-badge {
  padding: 0.375rem 0.75rem;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  font-weight: 600;
  background: #0dcaf0;
  color: white;
}

.directions-card {
  flex: 1;
}

.scrollable {
  max-height: 300px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

.scrollable::-webkit-scrollbar {
  width: 6px;
}

.scrollable::-webkit-scrollbar-track {
  background: #f7fafc;
  border-radius: 3px;
}

.scrollable::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

.scrollable::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

.directions-list {
  padding: 0;
}

.direction-step {
  padding: 1rem 0;
  border-bottom: 1px solid #e9ecef;
  font-size: 0.875rem;
  line-height: 1.5;
}

.direction-step:last-child {
  border-bottom: none;
}

.direction-step strong {
  color: #667eea;
  font-weight: 600;
}

.loading-directions {
  text-align: center;
  padding: 2rem;
  color: #6c757d;
}

.loading-directions .fa-route {
  font-size: 2rem;
  margin-bottom: 1rem;
  color: #667eea;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 1rem;
}

.btn-primary-action,
.btn-secondary-action,
.btn-success-action,
.btn-info-action {
  padding: 1rem 1.5rem;
  border-radius: 0.75rem;
  border: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 1rem;
}

.btn-primary-action {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-primary-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
}

.btn-secondary-action {
  background: white;
  color: #198754;
  border: 2px solid #198754;
}

.btn-secondary-action:hover {
  background: #198754;
  color: white;
}

.btn-success-action {
  background: #198754;
  color: white;
}

.btn-success-action:hover {
  background: #157347;
}

.btn-info-action {
  background: #0dcaf0;
  color: white;
}

.btn-info-action:hover {
  background: #0aa2c0;
}

.btn-chat-action {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
}

.btn-chat-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(40, 167, 69, 0.5);
}

/* Chat Modal Styles */
.chat-modal {
  border: none;
  border-radius: 1rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  overflow: hidden;
  height: 500px;
  display: flex;
  flex-direction: column;
}

.chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 1rem 1.5rem;
}

.chat-header .chat-avatar {
  position: relative;
  width: 40px;
  height: 40px;
}

.chat-header .chat-avatar img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.3);
}

.chat-header .online-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 12px;
  height: 12px;
  background: #28a745;
  border: 2px solid white;
  border-radius: 50%;
}

.chat-header .btn-close {
  color: white;
  opacity: 0.8;
  font-size: 1.2rem;
  background: none;
  border: none;
  padding: 0.5rem;
}

.chat-header .btn-close:hover {
  opacity: 1;
}

.chat-body {
  height: 400px;
  background: #f8f9fa;
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.chat-message {
  display: flex;
  margin-bottom: 0.75rem;
  animation: fadeInUp 0.3s ease-out;
}

.chat-message.user {
  justify-content: flex-end;
}

.chat-message.provider {
  justify-content: flex-start;
}

.message-bubble {
  max-width: 70%;
  padding: 0.75rem 1rem;
  border-radius: 1rem;
  position: relative;
  word-wrap: break-word;
}

.message-bubble.user {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-bottom-right-radius: 0.25rem;
}

.message-bubble.provider {
  background: white;
  color: #333;
  border: 1px solid #e9ecef;
  border-bottom-left-radius: 0.25rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-meta {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 0.25rem;
}

.message-bubble.user .message-meta {
  text-align: right;
}

.message-bubble.provider .message-meta {
  text-align: left;
}

.chat-typing-indicator {
  padding: 0.5rem 1rem;
  background: white;
  border-top: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.typing-dots {
  display: flex;
  gap: 0.25rem;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: #6c757d;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

.typing-text {
  font-size: 0.875rem;
  color: #6c757d;
  font-style: italic;
}

.chat-footer {
  background: white;
  padding: 1rem 1.5rem;
  border-top: 1px solid #e9ecef;
}

.chat-input {
  border: 2px solid #e9ecef;
  border-radius: 2rem;
  padding: 0.75rem 1.25rem;
  font-size: 0.9rem;
  transition: all 0.2s ease;
}

.chat-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.chat-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-start;
}

.chat-actions .btn {
  border-radius: 1rem;
  font-size: 0.8rem;
  padding: 0.25rem 0.75rem;
}

/* Scrollbar styling for chat messages */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Message animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Animations */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.spin-animation {
  animation: spin 2s linear infinite;
}

/* Responsive Design */
@media (max-width: 992px) {
  .row {
    flex-direction: column;
  }
  
  .col-lg-8 {
    order: 2;
  }
  
  .info-sidebar {
    order: 1;
    height: auto;
    max-height: 400px;
  }
  
  .header-content {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .route-info {
    width: 100%;
    justify-content: space-around;
  }
}

@media (max-width: 768px) {
  .navigation-header {
    padding: 1rem;
  }
  
  .header-title h2 {
    font-size: 1.25rem;
  }
  
  .sidebar-content {
    padding: 1rem;
  }
  
  .btn-primary-action,
  .btn-secondary-action,
  .btn-success-action,
  .btn-info-action {
    padding: 0.875rem 1.25rem;
    font-size: 0.9rem;
  }
}
</style>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let map, directionsService, directionsRenderer;
let currentLocation = null;
let destination = null;
let bookingId = null;

// Chat functionality
let socket;
let chatMessages = [];
let isTyping = false;
let typingTimeout;

// Get booking ID from URL
const urlParams = new URLSearchParams(window.location.search);
bookingId = urlParams.get('booking_id');

// Fetch provider location from backend
async function fetchProviderLocation() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/provider/current-location', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (response.ok) {
      const locationData = await response.json();
      console.log('Fetched provider location from backend:', locationData);
      return {
        lat: locationData.lat,
        lng: locationData.lng
      };
    } else {
      console.log('Could not fetch provider location from backend');
      return null;
    }
  } catch (error) {
    console.error('Error fetching provider location:', error);
    return null;
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeNavigation();
});

async function initializeNavigation() {
  try {
    if (!bookingId) {
      throw new Error('No booking ID provided');
    }

    // Get booking data
    const response = await fetch(`/bookings/${bookingId}/navigation`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load booking data');
    }
    
    const bookingData = await response.json();
    
    // Populate customer info
    document.getElementById('customerNameDisplay').textContent = bookingData.user_name;
    document.getElementById('customerName').textContent = bookingData.user_name;
    
    const phoneLink = document.getElementById('customerPhoneDisplay');
    if (bookingData.user_phone) {
      phoneLink.href = `tel:${bookingData.user_phone}`;
      phoneLink.innerHTML = `<i class="fas fa-phone me-2"></i>${bookingData.user_phone}`;
    } else {
      phoneLink.style.display = 'none';
      document.getElementById('callCustomerBtn').style.display = 'none';
    }
    
    document.getElementById('serviceName').textContent = bookingData.service_name;
    document.getElementById('bookingPrice').textContent = `₹${bookingData.price}`;
    document.getElementById('bookingStatus').textContent = bookingData.status;
    
    if (bookingData.scheduled_time) {
      const scheduledDate = new Date(bookingData.scheduled_time);
      document.getElementById('scheduledTimeDisplay').textContent = scheduledDate.toLocaleString('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short'
      });
    }
    
    // Set destination
    destination = {
      lat: bookingData.destination.lat,
      lng: bookingData.destination.lon || bookingData.destination.lng
    };
    
    // Initialize map
    initializeMap();
    
    // Hide loading overlay
    document.getElementById('loadingOverlay').classList.add('d-none');
    
  } catch (error) {
    console.error('Error initializing navigation:', error);
    alert('Failed to load navigation data. Please try again.');
    document.getElementById('loadingOverlay').classList.add('d-none');
  }
}

function initializeMap() {
  // Load Google Maps
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAG0GnKSwNcd_HtC1x1xVdzf-aWtzTIGBs&libraries=directions&callback=initGoogleMap`;
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
  
  window.initGoogleMap = function() {
    // Create map
    map = new google.maps.Map(document.getElementById('map'), {
      center: destination,
      zoom: 15
    });
    
    // Initialize directions service
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      map: map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#4285F4',
        strokeWeight: 5
      }
    });
    
    // Get current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          console.log('Got geolocation:', position.coords);
          currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          console.log('Current location set to:', currentLocation);
          calculateRoute();
        },
        async error => {
          console.error('Geolocation error:', error);
          console.log('Geolocation failed, trying to fetch provider location from backend');
          
          // Try to fetch provider location from backend
          const providerLocation = await fetchProviderLocation();
          
          if (providerLocation) {
            console.log('Using provider location from backend:', providerLocation);
            currentLocation = providerLocation;
            calculateRoute();
          } else {
            // Fallback: Use default Delhi coordinates
            console.log('Could not fetch provider location, using default location');
            currentLocation = {
              lat: 28.6139,
              lng: 77.2090
            };
            console.log('Using fallback location:', currentLocation);
            
            setTimeout(() => {
              alert('⚠️ Could not access your location. Please enable location permissions or set your location in your profile for accurate navigation.');
            }, 500);
            
            calculateRoute();
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    } else {
      console.log('Geolocation not supported by browser');
      
      // Try to fetch provider location from backend
      fetchProviderLocation().then(providerLocation => {
        if (providerLocation) {
          console.log('Using provider location from backend:', providerLocation);
          currentLocation = providerLocation;
          calculateRoute();
        } else {
          currentLocation = { lat: 28.6139, lng: 77.2090 };
          setTimeout(() => {
            alert('⚠️ Geolocation not supported. Please set your location in your profile for accurate navigation.');
          }, 500);
          calculateRoute();
        }
      });
    }
    
    // Add destination marker
    new google.maps.Marker({
      position: destination,
      map: map,
      title: 'Customer Location',
      icon: {
        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
      }
    });
  };
}

function calculateRoute() {
  console.log('Calculating route...');
  console.log('Current location:', currentLocation);
  console.log('Destination:', destination);
  
  if (!currentLocation || !destination) {
    console.error('Missing location data - cannot calculate route');
    alert('Unable to calculate route: Missing location information');
    return;
  }
  
  const request = {
    origin: currentLocation,
    destination: destination,
    travelMode: google.maps.TravelMode.DRIVING,
    provideRouteAlternatives: false
  };
  
  console.log('Sending directions request:', request);
  
  directionsService.route(request, function(result, status) {
    console.log('Directions response status:', status);
    
    if (status === 'OK') {
      console.log('Route calculated successfully:', result);
      directionsRenderer.setDirections(result);
      
      // Get route data
      const route = result.routes[0];
      const leg = route.legs[0];
      
      // Update route info
      document.getElementById('routeDistance').textContent = leg.distance.text;
      document.getElementById('routeDuration').textContent = leg.duration.text;
      document.getElementById('routeInfo').classList.remove('d-none');
      
      // Display directions
      displayDirections(result);
      
    } else if (status === 'ZERO_RESULTS') {
      console.error('No route found between locations');
      alert('No route found between your location and the customer location. They may be in an unreachable area.');
      
      document.getElementById('routeDistance').textContent = 'N/A';
      document.getElementById('routeDuration').textContent = 'N/A';
      document.getElementById('directionsList').innerHTML = '<div class="alert alert-warning">No route found. Please use manual navigation.</div>';
      
    } else {
      console.error('Directions request failed:', status);
      
      let errorMessage = 'Failed to calculate route. ';
      if (status === 'REQUEST_DENIED') {
        errorMessage = 'Google Maps API request denied. Please check API configuration.';
      } else if (status === 'INVALID_REQUEST') {
        errorMessage = 'Invalid request. Please check your location settings.';
      } else {
        errorMessage = 'Unable to calculate route. Try using the "Start Navigation" button for direct Google Maps navigation.';
      }
      
      alert(errorMessage);
      
      document.getElementById('routeDistance').textContent = 'N/A';
      document.getElementById('routeDuration').textContent = 'N/A';
      document.getElementById('directionsList').innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Route calculation failed</strong>
          <p class="small mb-2">${errorMessage}</p>
          <button class="btn btn-sm btn-primary" onclick="document.getElementById('startNavigationBtn').click()">
            <i class="fas fa-route me-1"></i>Open in Google Maps
          </button>
        </div>
      `;
    }
  });
}

function displayDirections(result) {
  const directionsList = document.getElementById('directionsList');
  const route = result.routes[0].legs[0];
  
  let html = '<div class="direction-step"><strong>' + route.start_address + '</strong></div>';
  
  route.steps.forEach(step => {
    html += '<div class="direction-step">' + step.instructions + '</div>';
  });
  
  html += '<div class="direction-step"><strong>' + route.end_address + '</strong></div>';
  
  directionsList.innerHTML = html;
}

function startNavigation() {
  if (!currentLocation || !destination) {
    alert('Please wait for route calculation to complete.');
    return;
  }
  
  const url = `https://www.google.com/maps/dir/?api=1&origin=${currentLocation.lat},${currentLocation.lng}&destination=${destination.lat},${destination.lng}&travelmode=driving`;
  window.open(url, '_blank');
}

function callCustomer() {
  const phoneLink = document.getElementById('customerPhoneDisplay');
  if (phoneLink.href && phoneLink.href.startsWith('tel:')) {
    window.location.href = phoneLink.href;
  }
}

function markArrived() {
  if (confirm('Mark yourself as arrived at the customer location?')) {
    // Update booking status
    fetch(`/bookings/${bookingId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ status: 'Arrived' })
    }).then(response => {
      if (response.ok) {
        alert('Arrival marked successfully!');
        document.getElementById('startServiceBtn').classList.remove('d-none');
      }
    });
  }
}

function startService() {
  if (confirm('Start the service?')) {
    // Update booking status
    fetch(`/bookings/${bookingId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ status: 'In Progress' })
    }).then(response => {
      if (response.ok) {
        alert('Service started!');
        window.location.href = '/provider/dashboard';
      }
    });
  }
}

// Chat functionality
function openChatModal() {
  if (!bookingId) {
    alert('No booking ID available for chat');
    return;
  }
  
  // Initialize chat if not already done
  if (!socket) {
    initializeChat();
  }
  
  // Update chat header with customer info
  const customerName = document.getElementById('customerName').textContent;
  const serviceName = document.getElementById('serviceName').textContent;
  
  document.getElementById('chatCustomerName').textContent = customerName;
  document.getElementById('chatCustomerService').textContent = serviceName;
  document.getElementById('chatCustomerAvatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${customerName}&backgroundColor=b6e3f4`;
  
  // Show modal
  const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
  chatModal.show();
  
  // Load chat messages
  loadChatMessages();
}

function initializeChat() {
  socket = io();
  
  // Setup socket events
  socket.on('connect', function() {
    console.log('Provider connected to chat server');
    
    // Join booking room for chat
    if (bookingId) {
      socket.emit('join_booking_room', { booking_id: bookingId });
      console.log(`Provider joined booking room: ${bookingId}`);
    }
  });
  
  socket.on('disconnect', function() {
    console.log('Provider disconnected from chat server');
  });
  
  // Listen for incoming messages
  socket.on('new_message', (message) => {
    if (message.booking_id === bookingId) {
      addMessageToChat(message);
      chatMessages.push(message);
    }
  });
  
  // Listen for typing indicators
  socket.on('typing_start', (data) => {
    if (data.booking_id === bookingId) {
      document.getElementById('providerTypingIndicator').classList.remove('d-none');
    }
  });
  
  socket.on('typing_stop', (data) => {
    if (data.booking_id === bookingId) {
      document.getElementById('providerTypingIndicator').classList.add('d-none');
    }
  });
  
  // Setup chat event listeners
  setupChatEventListeners();
}

function setupChatEventListeners() {
  // Send message button
  document.getElementById('providerSendBtn').addEventListener('click', sendMessage);
  
  // Send message on Enter key
  document.getElementById('providerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Typing indicator
  document.getElementById('providerMessageInput').addEventListener('input', () => {
    if (!isTyping) {
      isTyping = true;
      socket.emit('typing_start', { 
        provider_id: getCurrentProviderId(), 
        booking_id: bookingId 
      });
    }
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      isTyping = false;
      socket.emit('typing_stop', { 
        provider_id: getCurrentProviderId(), 
        booking_id: bookingId 
      });
    }, 1000);
  });
  
  // Attach file
  document.getElementById('providerAttachBtn').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,application/pdf,.doc,.docx';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        sendFileMessage(file);
      }
    };
    input.click();
  });
  
  // Send location
  document.getElementById('providerLocationBtn').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const location = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          address: 'Current location'
        };
        sendLocationMessage(location);
      }, (error) => {
        alert('Unable to get your location');
      });
    } else {
      alert('Geolocation not supported');
    }
  });
}

async function loadChatMessages() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/chat/${bookingId}/messages`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      chatMessages = await response.json();
      renderChatMessages();
    }
  } catch (error) {
    console.error('Error loading chat messages:', error);
  }
}

function renderChatMessages() {
  const messagesContainer = document.getElementById('providerChatMessages');
  messagesContainer.innerHTML = '';
  
  chatMessages.forEach(message => {
    addMessageToChat(message, false);
  });
  
  scrollToBottom();
}

function addMessageToChat(message, animate = true) {
  const messagesContainer = document.getElementById('providerChatMessages');
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${message.sender_type}`;
  
  const timestamp = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  let messageContent = '';
  
  if (message.type === 'text') {
    messageContent = `
      <div class="message-bubble ${message.sender_type}">
        <div class="message-text">${escapeHtml(message.content)}</div>
        <div class="message-meta">
          ${timestamp}
          <span class="message-status ${message.status || 'sent'}"></span>
        </div>
      </div>
    `;
  } else if (message.type === 'file') {
    messageContent = `
      <div class="message-bubble ${message.sender_type}">
        <div class="message-file">
          <i class="fas fa-paperclip me-2"></i>
          <a href="${message.file_url}" target="_blank" class="text-decoration-none">
            ${message.file_name}
          </a>
        </div>
        <div class="message-meta">
          ${timestamp}
          <span class="message-status ${message.status || 'sent'}"></span>
        </div>
      </div>
    `;
  } else if (message.type === 'location') {
    messageContent = `
      <div class="message-bubble ${message.sender_type}">
        <div class="message-location">
          <i class="fas fa-map-marker-alt me-2"></i>
          <a href="https://maps.google.com/?q=${message.location.lat},${message.location.lon}" 
             target="_blank" class="text-decoration-none">
            ${message.location.address}
          </a>
        </div>
        <div class="message-meta">
          ${timestamp}
          <span class="message-status ${message.status || 'sent'}"></span>
        </div>
      </div>
    `;
  }
  
  messageDiv.innerHTML = messageContent;
  
  if (animate) {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
  }
  
  messagesContainer.appendChild(messageDiv);
  
  if (animate) {
    setTimeout(() => {
      messageDiv.style.transition = 'all 0.3s ease-out';
      messageDiv.style.opacity = '1';
      messageDiv.style.transform = 'translateY(0)';
    }, 100);
  }
  
  scrollToBottom();
}

function sendMessage() {
  const messageInput = document.getElementById('providerMessageInput');
  const message = messageInput.value.trim();
  
  if (!message || !bookingId) return;
  
  // Send to server
  fetch('/api/chat/send', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    },
    body: JSON.stringify({
      booking_id: bookingId,
      sender_type: 'provider',
      type: 'text',
      content: message
    })
  })
  .then(response => response.json())
  .then(messageData => {
    // Add message to chat
    addMessageToChat(messageData);
    chatMessages.push(messageData);
    
    // Clear input
    messageInput.value = '';
  })
  .catch(error => {
    console.error('Error sending message:', error);
    alert('Failed to send message');
  });
}

function sendFileMessage(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('provider_id', getCurrentProviderId());
  formData.append('booking_id', bookingId);
  
  const messageData = {
    type: 'file',
    file_name: file.name,
    file_url: '#',
    sender_type: 'provider',
    provider_id: getCurrentProviderId(),
    booking_id: bookingId,
    timestamp: new Date().toISOString()
  };
  
  addMessageToChat(messageData);
  chatMessages.push(messageData);
  
  // Upload file
  fetch('/api/chat/upload', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
    body: formData
  }).then(response => response.json())
    .then(data => {
      if (data.success) {
        messageData.file_url = data.file_url;
        socket.emit('chat_message', messageData);
      } else {
        alert('Failed to upload file');
      }
    })
    .catch(error => {
      console.error('File upload error:', error);
      alert('Failed to upload file');
    });
}

function sendLocationMessage(location) {
  const messageData = {
    type: 'location',
    location: location,
    sender_type: 'provider',
    provider_id: getCurrentProviderId(),
    booking_id: bookingId,
    timestamp: new Date().toISOString()
  };
  
  addMessageToChat(messageData);
  chatMessages.push(messageData);
  
  socket.emit('chat_message', messageData);
}

function scrollToBottom() {
  const messagesContainer = document.getElementById('providerChatMessages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getCurrentProviderId() {
  // This should return the current provider's ID from your auth system
  // For now, returning a placeholder
  return 'provider_id_placeholder';
}
</script>
{% endblock %}

