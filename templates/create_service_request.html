{% extends "base.html" %}

{% block title %}Create Service Request{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>Create Service Request
          </h4>
          <p class="mb-0 mt-2">Get quotes from multiple providers for your service needs</p>
        </div>
        <div class="card-body">
          <form id="serviceRequestForm" enctype="multipart/form-data">
            <div class="row g-3">
              <!-- Service Type -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Service Type *</label>
                <select class="form-select" name="service_type" id="serviceType" required>
                  <option value="">Select service type</option>
                  <option value="electrician">Electrician</option>
                  <option value="plumber">Plumber</option>
                  <option value="carpenter">Carpenter</option>
                  <option value="cleaner">Cleaner</option>
                  <option value="painter">Painter</option>
                  <option value="ac repair">AC Repair</option>
                  <option value="appliance repair">Appliance Repair</option>
                  <option value="gardening">Gardening</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <!-- Urgency -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Urgency *</label>
                <select class="form-select" name="urgency" id="urgency" required>
                  <option value="normal">Normal</option>
                  <option value="urgent">Urgent</option>
                  <option value="emergency">Emergency</option>
                  <option value="flexible">Flexible</option>
                </select>
              </div>

              <!-- Location -->
              <div class="col-12">
                <label class="form-label fw-semibold">Location *</label>
                <input type="text" class="form-control" name="location" id="location" 
                       placeholder="Enter your address or location" required>
                <div class="form-text">Be specific about your location for better provider matching</div>
              </div>

              <!-- Work Description -->
              <div class="col-12">
                <label class="form-label fw-semibold">Work Description *</label>
                <textarea class="form-control" name="work_description" id="workDescription" 
                          rows="4" placeholder="Describe the work you need done..." required></textarea>
                <div class="form-text">Provide detailed description for accurate quotes</div>
              </div>

              <!-- Preferred Date -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Preferred Date</label>
                <input type="date" class="form-control" name="preferred_date" id="preferredDate">
              </div>

              <!-- Preferred Time -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Preferred Time</label>
                <select class="form-select" name="preferred_time" id="preferredTime">
                  <option value="">Any time</option>
                  <option value="morning">Morning (9 AM - 12 PM)</option>
                  <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                  <option value="evening">Evening (5 PM - 8 PM)</option>
                </select>
              </div>

              <!-- Images -->
              <div class="col-12">
                <label class="form-label fw-semibold">Images (Optional)</label>
                <input type="file" class="form-control" name="images" id="images" 
                       multiple accept="image/*">
                <div class="form-text">Upload photos of the work area or problem</div>
              </div>

              <!-- Hidden coordinates -->
              <input type="hidden" name="lat" id="lat">
              <input type="hidden" name="lon" id="lon">

              <!-- Submit Button -->
              <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button type="button" class="btn btn-outline-secondary me-md-2" onclick="window.history.back()">
                    <i class="fas fa-arrow-left me-1"></i>Cancel
                  </button>
                  <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                    <i class="fas fa-paper-plane me-1"></i>Submit Request
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h6>Creating Service Request...</h6>
        <p class="text-muted small mb-0">Please wait while we process your request</p>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize form
document.addEventListener('DOMContentLoaded', function() {
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('preferredDate').value = tomorrow.toISOString().split('T')[0];
  
  // Get user's current location
  getCurrentLocation();
});

// Get current location
function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        document.getElementById('lat').value = position.coords.latitude;
        document.getElementById('lon').value = position.coords.longitude;
        
        // Reverse geocoding (simplified)
        reverseGeocode(position.coords.latitude, position.coords.longitude);
      },
      function(error) {
        console.error('Error getting location:', error);
        // Set default location (Delhi)
        document.getElementById('lat').value = '28.6139';
        document.getElementById('lon').value = '77.2090';
      }
    );
  } else {
    // Set default location
    document.getElementById('lat').value = '28.6139';
    document.getElementById('lon').value = '77.2090';
  }
}

// Simple reverse geocoding (in real app, use a geocoding service)
function reverseGeocode(lat, lon) {
  // For demo purposes, just set a generic address
  if (!document.getElementById('location').value) {
    document.getElementById('location').value = 'Delhi, India';
  }
}

// Form submission
document.getElementById('serviceRequestForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.innerHTML;
  
  try {
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
    
    // Get form data
    const formData = new FormData(this);
    
    // Submit request
    const response = await fetch('/api/service-requests', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Success - redirect to quotes page
      window.location.href = `/service-request/${result.request_id}/quotes`;
    } else {
      // Error
      alert('Error creating service request: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error submitting form:', error);
    alert('Error creating service request. Please try again.');
  } finally {
    // Reset button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    
    // Hide loading modal
    const loadingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (loadingModal) {
      loadingModal.hide();
    }
  }
});
</script>

<style>
.form-label {
  color: #333;
}

.form-control:focus, .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.card {
  border: none;
  border-radius: 1rem;
}

.card-header {
  border-radius: 1rem 1rem 0 0 !important;
}

.btn {
  border-radius: 0.5rem;
}

#images {
  border: 2px dashed #dee2e6;
  border-radius: 0.5rem;
  padding: 1rem;
}

#images:hover {
  border-color: #0d6efd;
  background-color: #f8f9fa;
}
</style>
{% endblock %}











