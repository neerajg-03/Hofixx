{% extends 'base.html' %}

{% block title %}User Dashboard - Hoofix (Updated){% endblock %}

{% block styles %}
<style>
/* User Dashboard Styles */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.profile-avatar {
    position: relative;
    display: inline-block;
}

.profile-avatar .avatar-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.profile-avatar:hover .avatar-overlay {
    opacity: 1;
}

/* Stat card styles matching profile page */
.stat-card {
    transition: all 0.3s ease;
}

.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon i {
    font-size: 1.5rem;
}

.dashboard-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: rotate(45deg);
}

.stat-card .stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
    position: relative;
    z-index: 1;
}

.stat-card .stat-number {
    font-size: 2rem;
    font-weight: bold;
    position: relative;
    z-index: 1;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.booking-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
}

.booking-card:hover {
    transform: translateX(5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-accepted { background: #d1ecf1; color: #0c5460; }
.status-in-progress { background: #d4edda; color: #155724; }
.status-completed { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }

.action-btn {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    margin: 2px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.btn-primary { background: #667eea; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-info { background: #17a2b8; color: white; }
.btn-danger { background: #dc3545; color: white; }

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.rating-stars {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin: 10px 0;
}

.rating-stars .star {
    font-size: 1.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
}

.rating-stars .star:hover,
.rating-stars .star.active {
    color: #ffc107;
}

.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    border: none;
}

.modal-body {
    padding: 30px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    padding: 15px 20px;
    border-radius: 10px;
    color: white;
    font-weight: 600;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    transform: translateX(400px);
    transition: transform 0.3s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.success { background: #28a745; }
.notification.error { background: #dc3545; }
.notification.warning { background: #ffc107; color: #212529; }
.notification.info { background: #17a2b8; }

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }
    
    .stat-card {
        margin-bottom: 15px;
    }
    
    .booking-card {
        padding: 15px;
    }
    
    .action-btn {
        padding: 6px 12px;
        font-size: 0.7rem;
    }
}

.wallet-badge {
  cursor: pointer;
}

.wallet-transactions-list {
  max-height: 260px;
  overflow-y: auto;
}

.wallet-transactions-list .transaction-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.wallet-transactions-list .transaction-item:last-child {
  border-bottom: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <!-- Dashboard Header -->
  <section class="py-4 bg-gradient-primary text-white">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-3">
            <div class="profile-avatar me-4">
              <img id="userAvatar" class="rounded-circle shadow-lg" 
                   src="https://api.dicebear.com/7.x/avataaars/svg?seed=User&backgroundColor=b6e3f4" 
                   alt="User Avatar" width="80" height="80">
            </div>
            <div>
              <h2 class="mb-1 fw-bold" id="userName">Welcome back, User! ✨</h2>
              <p class="mb-0 text-white-50" id="userEmail">user@example.com</p>
              <div class="mt-2">
                <span class="badge bg-light text-primary me-2" id="userRating">⭐ 5.0</span>
                <button class="badge bg-white bg-opacity-25 border-0 wallet-badge" id="walletCredits" type="button" onclick="openWalletModal()">₹0.00 Credits</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="d-flex gap-2 justify-content-lg-end">
            <button class="btn btn-light rounded-pill px-4 py-2" onclick="refreshDashboard()">
              <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <button class="btn btn-outline-light rounded-pill px-4 py-2" onclick="openWalletModal()">
              <i class="fas fa-wallet me-2"></i>Wallet
            </button>
            <button class="btn btn-outline-light rounded-pill px-4 py-2" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Content -->
  <section class="py-4 bg-white">
    <div class="container">

      <!-- Statistics Cards -->
      <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-calendar-check text-primary"></i>
            </div>
            <h3 class="fw-bold mb-1 text-primary" id="totalBookings">0</h3>
            <p class="text-muted mb-0 small">Total Bookings</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-clock text-warning"></i>
            </div>
            <h3 class="fw-bold mb-1 text-warning" id="activeBookings">0</h3>
            <p class="text-muted mb-0 small">Active Bookings</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-check-circle text-success"></i>
            </div>
            <h3 class="fw-bold mb-1 text-success" id="completedBookings">0</h3>
            <p class="text-muted mb-0 small">Completed</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-rupee-sign text-info"></i>
            </div>
            <h3 class="fw-bold mb-1 text-info" id="totalSpent">₹0</h3>
            <p class="text-muted mb-0 small">Total Spent</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2">
                <a href="/services" class="btn btn-primary rounded-pill px-4 py-2">
                  <i class="fas fa-plus me-2"></i>Book New Service
                </a>
                <a href="/booking-map" class="btn btn-info rounded-pill px-4 py-2">
                  <i class="fas fa-map-marker-alt me-2"></i>Find Nearby Providers
                </a>
                <a href="/profile" class="btn btn-success rounded-pill px-4 py-2">
                  <i class="fas fa-user me-2"></i>Update Profile
                </a>
                <button class="btn btn-warning rounded-pill px-4 py-2" onclick="refreshDashboard()">
                  <i class="fas fa-sync-alt me-2"></i>Refresh Dashboard
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bookings Section -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="fw-bold mb-0">Your Bookings</h5>
                <div class="btn-group btn-group-sm" role="group">
                  <input type="radio" class="btn-check" name="bookingFilter" id="filterAllBookings" autocomplete="off" checked>
                  <label class="btn btn-outline-primary" for="filterAllBookings">All</label>
                  
                  <input type="radio" class="btn-check" name="bookingFilter" id="filterActiveBookings" autocomplete="off">
                  <label class="btn btn-outline-primary" for="filterActiveBookings">Active</label>

                  <input type="radio" class="btn-check" name="bookingFilter" id="filterCompletedBookings" autocomplete="off">
                  <label class="btn btn-outline-primary" for="filterCompletedBookings">Completed</label>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
                    
                    <!-- Loading State -->
                    <div id="bookingsLoading" class="text-center py-5">
                        <div class="loading-spinner"></div>
                        <p class="mt-3 text-muted">Loading your bookings...</p>
                    </div>
                    
                    <!-- Bookings List -->
                    <div id="bookingsList" style="display: none;">
                        <!-- Bookings will be populated here -->
                    </div>
                    
              <!-- Empty State -->
              <div id="emptyState" class="text-center py-5 d-none">
                <div class="mb-3">
                  <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-muted">No bookings found</h6>
                <p class="text-muted small">Your service requests will appear here</p>
                <a href="/services" class="btn btn-primary rounded-pill">
                  <i class="fas fa-plus me-2"></i>Book Your First Service
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback Section -->
      <div class="row mt-4">
          <div class="col-12">
              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">
                          <i class="fas fa-star me-2"></i>Share Your Experience
                      </h5>
                  </div>
                  <div class="card-body">
                      <p class="text-muted mb-4">Help us improve by sharing your feedback about our services</p>
                      
                      <form id="userFeedbackForm">
                          <div class="row">
                              <div class="col-md-6 mb-3">
                                  <label for="userFeedbackTitle" class="form-label">Review Title *</label>
                                  <input type="text" class="form-control" id="userFeedbackTitle" placeholder="e.g., Excellent service!" required>
                              </div>
                              <div class="col-md-6 mb-3">
                                  <label for="userFeedbackRating" class="form-label">Rating *</label>
                                  <div class="rating-input">
                                      <div class="star-rating" id="userFeedbackRating">
                                          <input type="radio" name="userRating" value="5" id="userStar5" required>
                                          <label for="userStar5" class="star">★</label>
                                          <input type="radio" name="userRating" value="4" id="userStar4">
                                          <label for="userStar4" class="star">★</label>
                                          <input type="radio" name="userRating" value="3" id="userStar3">
                                          <label for="userStar3" class="star">★</label>
                                          <input type="radio" name="userRating" value="2" id="userStar2">
                                          <label for="userStar2" class="star">★</label>
                                          <input type="radio" name="userRating" value="1" id="userStar1">
                                          <label for="userStar1" class="star">★</label>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          <div class="mb-3">
                              <label for="userFeedbackMessage" class="form-label">Your Experience *</label>
                              <textarea class="form-control" id="userFeedbackMessage" rows="3" 
                                        placeholder="Tell us about your experience..." required></textarea>
                          </div>
                          
                          <button type="submit" class="btn btn-primary">
                              <i class="fas fa-paper-plane me-2"></i>Submit Feedback
                          </button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
    </div>
  </section>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Rate Your Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h6 id="ratingServiceName">Service Name</h6>
                    <p class="text-muted">How was your experience?</p>
                </div>
                <div class="rating-stars" id="ratingStars">
                    <i class="far fa-star star" data-rating="1"></i>
                    <i class="far fa-star star" data-rating="2"></i>
                    <i class="far fa-star star" data-rating="3"></i>
                    <i class="far fa-star star" data-rating="4"></i>
                    <i class="far fa-star star" data-rating="5"></i>
                </div>
                <div class="form-floating mt-4">
                    <textarea class="form-control" placeholder="Leave a review..." id="reviewText" style="height: 100px"></textarea>
                    <label for="reviewText">Review (Optional)</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitRating" disabled>Submit Rating</button>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Modal -->
<div class="modal fade" id="walletModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0 pb-0">
        <div>
          <h5 class="modal-title fw-bold">My Wallet</h5>
          <p class="text-muted mb-0 small">Add funds, track bonuses, and share your referral code.</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="border rounded-4 p-3 bg-light h-100">
              <h6 class="fw-semibold text-muted">Current Balance</h6>
              <h2 class="fw-bold text-primary mb-3" id="walletBalanceValue">₹0.00</h2>
              <div class="mb-3">
                <label class="form-label fw-semibold small">Referral Code</label>
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" id="referralCodeValue" readonly>
                  <button class="btn btn-outline-primary" type="button" id="copyReferralCode">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
                <small class="text-muted" id="referralStatusText"></small>
              </div>
              <div class="alert alert-info small" id="walletInfoMessage" role="alert">
                Earn bonus credits by sharing your referral code with friends.
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="border rounded-4 p-3 mb-4">
              <h6 class="fw-semibold mb-3">Add Funds</h6>
              <form id="walletTopupForm" class="row g-2 align-items-end">
                <div class="col-md-6">
                  <label class="form-label small fw-semibold">Amount (₹)</label>
                  <input type="number" class="form-control" id="walletTopupAmount" min="1" step="0.01" placeholder="Enter amount" required>
                </div>
                <div class="col-md-6 d-grid d-md-flex gap-2">
                  <button type="submit" class="btn btn-primary flex-grow-1">
                    <i class="fas fa-university me-2"></i>Add Funds
                  </button>
                </div>
              </form>
              <small class="text-muted d-block mt-2">Funds are added instantly. Integration with secure bank/UPI providers can be configured here.</small>
            </div>
            <div class="border rounded-4 p-3 mb-4">
              <h6 class="fw-semibold mb-3">Redeem Referral Bonus</h6>
              <form id="walletReferralForm" class="row g-2 align-items-end">
                <div class="col-md-8">
                  <label class="form-label small fw-semibold">Friend's Referral Code</label>
                  <input type="text" class="form-control" id="referralCodeInput" placeholder="Enter referral code">
                </div>
                <div class="col-md-4 d-grid">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-gift me-2"></i>Redeem Bonus
                  </button>
                </div>
              </form>
            </div>
            <div class="border rounded-4 p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold mb-0">Recent Transactions</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshWalletTransactions">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div id="walletTransactionsList" class="wallet-transactions-list"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Make Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h6 id="paymentServiceName">Service Name</h6>
                    <p class="text-muted">Amount to pay</p>
                    <h3 class="text-primary" id="paymentAmount">₹0</h3>
                </div>
                <div class="alert alert-success d-none" id="walletPaymentInfo">
                    <i class="fas fa-wallet me-2"></i>
                    Wallet balance available: <strong id="walletBalanceForPayment">₹0.00</strong>. You can pay using your wallet.
                </div>
                <div class="alert alert-warning d-none" id="walletInsufficientInfo">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Wallet balance is insufficient. Please add funds or use Razorpay to complete the payment.
                </div>
                <div class="alert alert-info" id="razorpayInfoAlert">
                    <i class="fas fa-info-circle me-2"></i>
                    You will be redirected to Razorpay for secure payment processing.
                </div>
            </div>
            <div class="modal-footer flex-column flex-md-row gap-2">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success w-100 d-none" id="payWithWalletBtn">
                    <i class="fas fa-wallet me-2"></i>Pay with Wallet
                </button>
                <button type="button" class="btn btn-primary w-100" id="proceedPayment">
                    <i class="fas fa-credit-card me-2"></i>Pay with Razorpay
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Details Modal -->
<div class="modal fade" id="completionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Service Completion Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="completionContent">
                    <!-- Completion details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/user_dashboard_new.js') }}"></script>

<style>
/* Star Rating Styles for User Dashboard */
.rating-input {
  display: flex;
  justify-content: center;
  margin: 0.5rem 0;
}

.star-rating {
  display: flex;
  flex-direction: row-reverse;
  gap: 0.25rem;
}

.star-rating input[type="radio"] {
  display: none;
}

.star-rating label {
  font-size: 1.5rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.2s;
}

.star-rating input[type="radio"]:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: #ffc107;
}
</style>
{% endblock %}

