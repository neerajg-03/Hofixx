{% extends 'base.html' %}

{% block title %}Order Summary - Hofix{% endblock %}

{% block styles %}
<style>
  .order-summary-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 3rem 0;
    color: white;
  }
  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
  }
  .status-pending { background: #ffc107; color: #000; }
  .status-confirmed { background: #17a2b8; color: #fff; }
  .status-preparing { background: #007bff; color: #fff; }
  .status-ready { background: #28a745; color: #fff; }
  .status-assigned { background: #6f42c1; color: #fff; }
  .status-out_for_delivery { background: #fd7e14; color: #fff; }
  .status-delivered { background: #28a745; color: #fff; }
  .status-cancelled { background: #dc3545; color: #fff; }
  
  .timeline {
    position: relative;
    padding-left: 2rem;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e5e5;
  }
  .timeline-item {
    position: relative;
    padding-bottom: 2rem;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -1.75rem;
    top: 0.25rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: #e5e5e5;
    border: 3px solid white;
    box-shadow: 0 0 0 2px #e5e5e5;
  }
  .timeline-item.active::before {
    background: #28a745;
    box-shadow: 0 0 0 2px #28a745;
  }
  .timeline-item.completed::before {
    background: #28a745;
    box-shadow: 0 0 0 2px #28a745;
  }
  
  .delivery-partner-card {
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 1.5rem;
    background: #f8f9fa;
  }
  .order-item-card {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
  }
  .order-item-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #0d6efd;
  }
</style>
{% endblock %}

{% block content %}
<!-- Order Summary Hero -->
<section class="order-summary-hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <div class="d-flex align-items-center mb-3">
          <i class="fas fa-check-circle fa-3x me-3"></i>
          <div>
            <h1 class="display-5 fw-bold mb-2">Order Placed Successfully!</h1>
            <p class="lead mb-0">Thank you for your order. We'll keep you updated on its progress.</p>
          </div>
        </div>
      </div>
      <div class="col-lg-4 text-lg-end">
        <div class="mb-2">
          <small class="text-white-50 d-block mb-1">Order ID</small>
          <h4 class="fw-bold mb-0" id="orderId">Loading...</h4>
        </div>
        <div>
          <small class="text-white-50 d-block mb-1">Order Date</small>
          <h6 class="mb-0" id="orderDate">Loading...</h6>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Order Summary Content -->
<section class="py-5 bg-light">
  <div class="container">
    <div class="row g-4">
      <!-- Left Column: Order Details -->
      <div class="col-lg-8">
        <!-- Order Status -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3 class="fw-bold mb-0">Order Status</h3>
              <span class="status-badge" id="orderStatusBadge">Pending</span>
            </div>
            
            <!-- Timeline -->
            <div class="timeline" id="orderTimeline">
              <!-- Timeline items will be dynamically loaded -->
            </div>
          </div>
        </div>
        
        <!-- Order Items -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
          <div class="card-header bg-white border-0 pb-0">
            <h4 class="fw-bold mb-3">Order Items</h4>
          </div>
          <div class="card-body p-4">
            <div id="orderItemsList">
              <!-- Order items will be dynamically loaded -->
            </div>
          </div>
        </div>
        
        <!-- Delivery Address -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
          <div class="card-header bg-white border-0 pb-0">
            <h4 class="fw-bold mb-3">
              <i class="fas fa-map-marker-alt text-primary me-2"></i>Delivery Address
            </h4>
          </div>
          <div class="card-body p-4">
            <div id="deliveryAddress">
              <!-- Delivery address will be dynamically loaded -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column: Order Summary & Tracking -->
      <div class="col-lg-4">
        <!-- Order Summary -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
          <div class="card-header bg-white border-0 pb-0">
            <h5 class="fw-bold mb-3">Order Summary</h5>
          </div>
          <div class="card-body p-4">
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Subtotal</span>
              <span class="fw-semibold" id="orderSubtotal">₹0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Delivery Charge</span>
              <span class="fw-semibold" id="orderDeliveryCharge">₹0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Payment Method</span>
              <span class="fw-semibold" id="paymentMethod">--</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-3">
              <span class="fw-bold">Total</span>
              <span class="fw-bold text-primary fs-5" id="orderTotal">₹0.00</span>
            </div>
          </div>
        </div>
        
        <!-- Delivery Partner Info -->
        <div class="card border-0 shadow-sm rounded-4 mb-4" id="deliveryPartnerCard" style="display: none;">
          <div class="card-header bg-white border-0 pb-0">
            <h5 class="fw-bold mb-3">
              <i class="fas fa-motorcycle text-primary me-2"></i>Delivery Partner
            </h5>
          </div>
          <div class="card-body p-4">
            <div class="delivery-partner-card">
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                  <i class="fas fa-user"></i>
                </div>
                <div>
                  <h6 class="fw-bold mb-0" id="deliveryPartnerName">Loading...</h6>
                  <small class="text-muted" id="deliveryPartnerPhone">--</small>
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm w-100" id="callDeliveryPartnerBtn" onclick="callDeliveryPartner()">
                  <i class="fas fa-phone me-2"></i>Call Delivery Partner
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tracking Map -->
        <div class="card border-0 shadow-sm rounded-4 mb-4" id="trackingMapCard" style="display: none;">
          <div class="card-header bg-white border-0 pb-0">
            <h5 class="fw-bold mb-3">
              <i class="fas fa-map-marked-alt text-primary me-2"></i>Track Order
            </h5>
          </div>
          <div class="card-body p-0">
            <div id="trackingMap" style="height: 300px; border-radius: 0 0 12px 12px;"></div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="window.location.href='/orders'">
            <i class="fas fa-list me-2"></i>View All Orders
          </button>
          <button class="btn btn-outline-secondary" onclick="window.location.href='/shop'">
            <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  let orderData = null;
  let deliveryPartnerPhone = null;
  let map = null;
  let marker = null;

  // Get order ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order_id');

  if (!orderId) {
    document.body.innerHTML = '<div class="container py-5"><div class="alert alert-danger">Order ID not found in URL.</div></div>';
  } else {
    // Load order data
    loadOrderSummary(orderId);
  }

  async function loadOrderSummary(orderId) {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      const response = await fetch(`/api/orders/${orderId}/summary`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        if (response.status === 404) {
          document.body.innerHTML = '<div class="container py-5"><div class="alert alert-danger">Order not found.</div></div>';
          return;
        }
        throw new Error('Failed to load order details');
      }

      orderData = await response.json();
      renderOrderSummary(orderData);
    } catch (error) {
      console.error('Error loading order summary:', error);
      showNotification('Failed to load order details', 'error');
    }
  }

  function renderOrderSummary(data) {
    // Order ID and Date
    document.getElementById('orderId').textContent = `#${data.order_id || 'N/A'}`;
    const orderDate = data.created_at ? new Date(data.created_at) : new Date();
    document.getElementById('orderDate').textContent = orderDate.toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    // Order Status
    const status = data.status || 'pending';
    const statusBadge = document.getElementById('orderStatusBadge');
    statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
    statusBadge.className = `status-badge status-${status}`;

    // Timeline
    renderTimeline(data);

    // Order Items
    renderOrderItems(data);

    // Delivery Address
    renderDeliveryAddress(data);

    // Order Summary
    const subtotal = parseFloat(data.items_total || 0);
    const deliveryCharge = parseFloat(data.delivery_charge || 0);
    const total = subtotal + deliveryCharge;
    
    document.getElementById('orderSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('orderDeliveryCharge').textContent = `₹${deliveryCharge.toFixed(2)}`;
    document.getElementById('orderTotal').textContent = `₹${total.toFixed(2)}`;
    document.getElementById('paymentMethod').textContent = data.payment_method || 'Not specified';

    // Delivery Partner
    if (data.delivery_partner) {
      document.getElementById('deliveryPartnerCard').style.display = 'block';
      document.getElementById('deliveryPartnerName').textContent = data.delivery_partner.name || 'N/A';
      document.getElementById('deliveryPartnerPhone').textContent = data.delivery_partner.phone || 'N/A';
      deliveryPartnerPhone = data.delivery_partner.phone;
    }

    // Tracking Map
    if (data.delivery_lat && data.delivery_lon) {
      document.getElementById('trackingMapCard').style.display = 'block';
      initTrackingMap(data.delivery_lat, data.delivery_lon, data.shop);
    }
  }

  function renderTimeline(data) {
    const status = data.status || 'pending';
    const timeline = document.getElementById('orderTimeline');
    
    const statuses = [
      { key: 'pending', label: 'Order Placed', icon: 'fa-shopping-cart' },
      { key: 'confirmed', label: 'Order Confirmed', icon: 'fa-check-circle' },
      { key: 'preparing', label: 'Preparing Order', icon: 'fa-box' },
      { key: 'ready', label: 'Ready for Pickup', icon: 'fa-check-double' },
      { key: 'assigned', label: 'Assigned to Delivery Partner', icon: 'fa-user-check' },
      { key: 'out_for_delivery', label: 'Out for Delivery', icon: 'fa-motorcycle' },
      { key: 'delivered', label: 'Delivered', icon: 'fa-check-circle' }
    ];

    const statusIndex = statuses.findIndex(s => s.key === status);
    const cancelled = status === 'cancelled';

    timeline.innerHTML = statuses.map((s, index) => {
      let itemClass = '';
      if (cancelled && s.key === 'pending') {
        itemClass = 'active';
      } else if (statusIndex >= index && !cancelled) {
        itemClass = index < statusIndex ? 'completed' : 'active';
      }

      return `
        <div class="timeline-item ${itemClass}">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <i class="fas ${s.icon} me-2 text-primary"></i>
              <span class="fw-semibold">${s.label}</span>
            </div>
            ${index === statusIndex && !cancelled ? '<span class="badge bg-primary">Current</span>' : ''}
          </div>
          ${index === statusIndex && data[s.key + '_at'] ? 
            `<small class="text-muted">${new Date(data[s.key + '_at']).toLocaleString('en-IN')}</small>` : ''}
        </div>
      `;
    }).join('');

    if (cancelled) {
      timeline.innerHTML += `
        <div class="timeline-item active">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <i class="fas fa-times-circle me-2 text-danger"></i>
              <span class="fw-semibold text-danger">Order Cancelled</span>
            </div>
            <span class="badge bg-danger">Cancelled</span>
          </div>
        </div>
      `;
    }
  }

  function renderOrderItems(data) {
    const container = document.getElementById('orderItemsList');
    const items = data.items || [];
    
    if (items.length === 0) {
      container.innerHTML = '<p class="text-muted">No items found.</p>';
      return;
    }

    container.innerHTML = items.map(item => `
      <div class="order-item-card">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="fw-bold mb-1">${item.product_name || 'Product'}</h6>
            <p class="text-muted small mb-2">Quantity: ${item.quantity || 1}</p>
            ${item.product_description ? `<p class="small text-muted mb-0">${item.product_description}</p>` : ''}
          </div>
          <div class="text-end ms-3">
            <h6 class="fw-bold text-primary mb-0">₹${parseFloat(item.total_price || item.price || 0).toFixed(2)}</h6>
            ${item.price ? `<small class="text-muted">₹${parseFloat(item.price).toFixed(2)} each</small>` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderDeliveryAddress(data) {
    const container = document.getElementById('deliveryAddress');
    container.innerHTML = `
      <p class="fw-semibold mb-2">${data.delivery_address || 'Address not specified'}</p>
      <p class="text-muted small mb-2">
        <i class="fas fa-phone me-2"></i>${data.contact_phone || 'N/A'}
      </p>
      ${data.delivery_lat && data.delivery_lon ? `
        <p class="text-muted small mb-0">
          <i class="fas fa-map-marker-alt me-2"></i>
          Coordinates: ${parseFloat(data.delivery_lat).toFixed(6)}, ${parseFloat(data.delivery_lon).toFixed(6)}
        </p>
      ` : ''}
    `;
  }

  function initTrackingMap(lat, lon, shopData) {
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
      // Load Google Maps API
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDummyKey&callback=initMapCallback`;
      script.async = true;
      script.defer = true;
      window.initMapCallback = function() {
        createMap(lat, lon, shopData);
      };
      document.head.appendChild(script);
    } else {
      createMap(lat, lon, shopData);
    }
  }

  function createMap(lat, lon, shopData) {
    const mapContainer = document.getElementById('trackingMap');
    if (!mapContainer) return;

    map = new google.maps.Map(mapContainer, {
      center: { lat: parseFloat(lat), lng: parseFloat(lon) },
      zoom: 15,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true
    });

    // Delivery location marker
    marker = new google.maps.Marker({
      position: { lat: parseFloat(lat), lng: parseFloat(lon) },
      map: map,
      title: 'Delivery Location',
      icon: {
        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
      }
    });

    // Shop location marker if available
    if (shopData && shopData.location_lat && shopData.location_lon) {
      const shopMarker = new google.maps.Marker({
        position: { 
          lat: parseFloat(shopData.location_lat), 
          lng: parseFloat(shopData.location_lon) 
        },
        map: map,
        title: shopData.name || 'Shop',
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        }
      });
    }
  }

  function callDeliveryPartner() {
    if (deliveryPartnerPhone) {
      window.location.href = `tel:${deliveryPartnerPhone}`;
    } else {
      showNotification('Phone number not available', 'error');
    }
  }

  function showNotification(message, type = 'info') {
    // Simple notification - can be enhanced with a toast library
    const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alert.style.zIndex = '9999';
    alert.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  // Auto-refresh order status every 30 seconds
  if (orderId) {
    setInterval(() => {
      loadOrderSummary(orderId);
    }, 30000);
  }
</script>
{% endblock %}

