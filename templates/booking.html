{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto px-3">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-2xl font-semibold mb-0">Create Booking</h2>
      <div class="text-gray-500 text-sm">Choose a service and when you need it</div>
    </div>
    <button id="geoBtn" type="button" class="px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">Use my location</button>
  </div>

  <!-- Selected Service Summary -->
  <div id="serviceSummary" class="hidden bg-white rounded-xl shadow overflow-hidden mb-4">
    <div class="flex flex-col md:flex-row">
      <img id="sumImg" class="w-full md:w-56 h-40 object-cover" src="" alt="service">
      <div class="p-4 flex-1">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="sumName" class="text-lg font-semibold"></div>
            <div id="sumCat" class="text-sm text-gray-500"></div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">From</div>
            <div id="sumPrice" class="text-xl font-bold"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form id="bookingForm" class="bg-white rounded-xl shadow p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="form-label block text-sm font-medium text-gray-700">Service</label>
      <select name="service_id" id="serviceSelect" class="w-full px-3 py-2 border rounded"></select>
    </div>
    <div>
      <label class="form-label block text-sm font-medium text-gray-700">Provider (optional)</label>
      <input name="provider_id" class="w-full px-3 py-2 border rounded" placeholder="Paste provider ID (optional)" />
      <div class="text-xs text-gray-500 mt-1">Or pick from the <a class="underline" href="/nearby">Nearby</a> map first.</div>
    </div>
    <div>
      <label class="form-label block text-sm font-medium text-gray-700">Date/Time</label>
      <input name="scheduled_time" type="datetime-local" class="w-full px-3 py-2 border rounded" />
    </div>
    <div>
      <label class="form-label block text-sm font-medium text-gray-700">Price</label>
      <input name="price" id="priceInput" type="number" step="0.01" class="w-full px-3 py-2 border rounded" />
      <div id="estPrice" class="text-sm text-gray-500 mt-1"></div>
    </div>

    <!-- Map Picker -->
    <div class="md:col-span-2">
      <label class="form-label block text-sm font-medium text-gray-700">Location</label>
      <div id="map" style="height: 300px; border-radius: 12px; overflow: hidden;" class="mb-2"></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input name="location_lat" id="lat" class="w-full px-3 py-2 border rounded" placeholder="Latitude" />
        <input name="location_lon" id="lon" class="w-full px-3 py-2 border rounded" placeholder="Longitude" />
      </div>
    </div>

    <div class="md:col-span-2">
      <label class="form-label block text-sm font-medium text-gray-700">Notes</label>
      <textarea name="notes" class="w-full px-3 py-2 border rounded" placeholder="Any special instructions..."></textarea>
    </div>

    <div class="md:col-span-2 flex items-center gap-3">
      <button id="submitBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" type="submit">Confirm Booking</button>
      <div id="bookingMsg" class="text-sm"></div>
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
(async function(){
  const res = await fetch('/api/services');
  const services = await res.json();
  const sel = document.getElementById('serviceSelect');
  const params = new URLSearchParams(location.search);
  const pre = params.get('service_id');
  let selected = null;
  services.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id; o.textContent = `${s.name} (${s.category}) Â· from $${s.base_price}`;
    if (!selected) selected = s;
    if (pre && pre === s.id) { o.selected = true; selected = s; }
    sel.appendChild(o);
  });
  updateSummary(selected);
  // Set base price as default price
  document.getElementById('priceInput').value = selected ? Number(selected.base_price).toFixed(2) : '';
})();

// Start automatic location tracking
function startLocationTracking() {
  // Get initial location
  getCurrentLocation();
  
  // Update location every 5 seconds for booking page
  setInterval(() => {
    getCurrentLocation();
  }, 5000);
}

// Get current location automatically
function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        
        if (!window._map) {
          initMap(lat, lon);
        } else {
          window._marker.setLatLng([lat, lon]);
          window._map.setView([lat, lon], 13);
        }
        
        console.log(`Location updated: ${lat}, ${lon}`);
      },
      error => {
        console.log('Location access denied or error:', error);
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 5000
      }
    );
  }
}

// Start location tracking when page loads
document.addEventListener('DOMContentLoaded', () => {
  startLocationTracking();
});

// Manual location button
const geoBtn = document.getElementById('geoBtn');
geoBtn.addEventListener('click', () => {
  getCurrentLocation();
});

const form = document.getElementById('bookingForm');
const estPrice = document.getElementById('estPrice');
document.getElementById('serviceSelect').addEventListener('change', (e) => {
  const opt = e.target.selectedOptions[0];
  const text = opt ? opt.textContent : '';
  const m = text.match(/\$(\d+(?:\.\d+)?)/);
  if (m) estPrice.textContent = `Estimated from $${m[1]}`;
  const selId = opt?.value;
  // update summary
  fetch('/api/services').then(r=>r.json()).then(list => {
    const svc = list.find(x => x.id === selId);
    updateSummary(svc || null);
    if (svc) document.getElementById('priceInput').value = Number(svc.base_price).toFixed(2);
  });
});
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());
  // Keep IDs as strings (MongoDB ObjectId)
  data.service_id = data.service_id || null;
  data.provider_id = data.provider_id || null;
  data.price = data.price ? Number(data.price) : null;
  data.location_lat = data.location_lat ? Number(data.location_lat) : null;
  data.location_lon = data.location_lon ? Number(data.location_lon) : null;
  const token = localStorage.getItem('token') || '';
  if (!token) {
    document.getElementById('bookingMsg').textContent = 'Please login to create a booking';
    return;
  }
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = 'Booking...';
  const res = await fetch('/bookings/create', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data)});
  const out = await res.json();
  if (res.ok) {
    const lat = encodeURIComponent(data.location_lat || '');
    const lon = encodeURIComponent(data.location_lon || '');
    window.location.href = `/nearby?booking_id=${out.id}&lat=${lat}&lon=${lon}`;
  } else {
    const msg = document.getElementById('bookingMsg');
    msg.textContent = out.message || 'Failed';
    msg.className = 'text-red-600';
    btn.disabled = false; btn.textContent = 'Confirm Booking';
  }
});

// Map Picker (Google Maps)
let map, marker;

function initMap(lat=28.6139, lon=77.2090){
  console.log('Initializing map with coordinates:', lat, lon);
  
  // Load Google Maps API if not already loaded
  if (typeof google === 'undefined') {
    console.log('Google Maps API not loaded, loading now...');
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAG0GnKSwNcd_HtC1x1xVdzf-aWtzTIGBs&callback=initGoogleMap`;
    script.async = true;
    script.defer = true;
    script.onerror = function() {
      console.error('Failed to load Google Maps API - script error');
      showMapError('Failed to load Google Maps API script');
    };
    document.head.appendChild(script);
    window.initGoogleMap = () => {
      console.log('Google Maps API loaded successfully');
      try {
        createMap(lat, lon);
      } catch (error) {
        console.error('Error creating map:', error);
        showMapError('Error creating map: ' + error.message);
      }
    };
  } else {
    console.log('Google Maps API already loaded');
    try {
      createMap(lat, lon);
    } catch (error) {
      console.error('Error creating map:', error);
      showMapError('Error creating map: ' + error.message);
    }
  }
}

function showMapError(message = 'Map Loading Error') {
  const mapDiv = document.getElementById('map');
  mapDiv.innerHTML = `
    <div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">
      <div class="text-center">
        <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">${message}</h5>
        <p class="text-muted small">Please check the browser console for technical details</p>
        <button class="btn btn-primary btn-sm" onclick="initMap()">Retry</button>
      </div>
    </div>
  `;
}

function createMap(lat, lon) {
  console.log('Creating Google Map...');
  
  // Check if map container exists
  const mapElement = document.getElementById('map');
  if (!mapElement) {
    throw new Error('Map container element not found');
  }
  
  // Check if Google Maps is loaded
  if (typeof google === 'undefined' || !google.maps) {
    throw new Error('Google Maps API not loaded');
  }
  
  const mapOptions = {
    center: { lat: lat, lng: lon },
    zoom: 13,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  
  console.log('Initializing map with options:', mapOptions);
  window._map = new google.maps.Map(mapElement, mapOptions);
  console.log('Map created successfully');
  
  window._marker = new google.maps.Marker({
    position: { lat: lat, lng: lon },
    map: window._map,
    draggable: true,
    title: 'Service Location'
  });
  
  window._marker.addListener('dragend', () => {
    const position = window._marker.getPosition();
    document.getElementById('lat').value = position.lat();
    document.getElementById('lon').value = position.lng();
  });
  
  console.log('Map initialization completed');
}

window.addEventListener('load', () => {
  const lat = parseFloat(document.getElementById('lat').value) || 28.6139;
  const lon = parseFloat(document.getElementById('lon').value) || 77.2090;
  initMap(lat, lon);
});

// Helpers
function updateSummary(svc){
  const box = document.getElementById('serviceSummary');
  if (!svc){ box.classList.add('hidden'); return; }
  document.getElementById('sumName').textContent = svc.name;
  document.getElementById('sumCat').textContent = svc.category || '';
  document.getElementById('sumPrice').textContent = `$${Number(svc.base_price).toFixed(2)}`;
  document.getElementById('sumImg').src = svc.image_url || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop';
  box.classList.remove('hidden');
}
</script>
{% endblock %}
