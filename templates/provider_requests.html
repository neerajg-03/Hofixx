{% extends "base.html" %}

{% block title %}Service Requests - Provider Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- Notifications Sidebar -->
    <div class="col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Notifications</h6>
          <span class="badge bg-primary" id="notificationCount">0</span>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
          <div id="notificationsList">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Service Requests List -->
    <div class="col-lg-9">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Available Service Requests</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="loadServiceRequests()">
              <i class="fas fa-refresh me-1"></i>Refresh
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="serviceRequestsList">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading service requests...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Submission Modal -->
<div class="modal fade" id="quoteModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submit Quote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="requestDetailsForQuote"></div>
        
        <form id="quoteForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Your Quote (â‚¹)</label>
              <input type="number" class="form-control" id="quotePrice" min="1" step="0.01" required>
              <div class="form-text">Enter your total price for this service</div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Estimated Duration</label>
              <select class="form-select" id="estimatedDuration">
                <option value="">Select duration</option>
                <option value="1-2 hours">1-2 hours</option>
                <option value="2-4 hours">2-4 hours</option>
                <option value="4-6 hours">4-6 hours</option>
                <option value="1 day">1 day</option>
                <option value="2-3 days">2-3 days</option>
                <option value="1 week">1 week</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Additional Notes</label>
              <textarea class="form-control" id="quoteNotes" rows="3" placeholder="Add any additional details about your service, materials needed, etc."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitQuoteBtn">Submit Quote</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentRequestId = null;
let socket = null;
let refreshInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  initializeSocket();
  loadNotifications();
  loadServiceRequests();
  
  // Set up auto-refresh every 15 seconds for real-time updates
  refreshInterval = setInterval(() => {
    loadNotifications();
    loadServiceRequests();
  }, 15000);
});

// Initialize WebSocket connection for real-time updates
function initializeSocket() {
  try {
    socket = io();
    
    socket.on('connect', function() {
      console.log('Connected to server for real-time updates');
      // Join provider room for notifications
      const token = localStorage.getItem('token');
      if (token) {
        socket.emit('join_provider_room', { token: token });
      }
    });
    
    socket.on('disconnect', function() {
      console.log('Disconnected from server');
    });
    
    // Listen for new service requests
    socket.on('new_service_request', function(data) {
      console.log('New service request received:', data);
      showNewRequestNotification(data);
      loadServiceRequests(); // Refresh the list
    });
    
    // Listen for quote updates
    socket.on('quote_selected', function(data) {
      console.log('Quote selected:', data);
      loadServiceRequests(); // Refresh the list
    });
    
    // Listen for request cancellations
    socket.on('request_cancelled', function(data) {
      console.log('Request cancelled:', data);
      loadServiceRequests(); // Refresh the list
    });
    
    socket.on('connect_error', function(error) {
      console.error('Socket connection error:', error);
    });
    
  } catch (error) {
    console.error('Error initializing socket:', error);
  }
}

// Show notification for new service request
function showNewRequestNotification(requestData) {
  // Create a toast notification
  const toast = document.createElement('div');
  toast.className = 'toast align-items-center text-white bg-primary border-0 position-fixed';
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 1055; min-width: 350px;';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <div class="d-flex align-items-center">
          <i class="fas fa-bell me-2"></i>
          <div>
            <div class="fw-bold">New Service Request!</div>
            <div class="small">${requestData.service_category} â€¢ ${requestData.distance ? requestData.distance.toFixed(1) + 'km' : 'Nearby'}</div>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast, {
    autohide: true,
    delay: 7000 // Longer delay to give user time to read
  });
  bsToast.show();
  
  // Remove toast element after hiding
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

// Load notifications
async function loadNotifications() {
  try {
    const response = await fetch('/api/provider/notifications', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      displayNotifications(data.notifications);
      updateNotificationCount(data.notifications.length);
    } else {
      console.error('Failed to load notifications');
    }
  } catch (error) {
    console.error('Error loading notifications:', error);
  }
}

// Display notifications
function displayNotifications(notifications) {
  const notificationsDiv = document.getElementById('notificationsList');
  
  if (notifications.length === 0) {
    notificationsDiv.innerHTML = `
      <div class="text-center text-muted">
        <i class="fas fa-bell-slash fa-2x mb-2"></i>
        <p class="small">No notifications</p>
      </div>
    `;
    return;
  }
  
  notificationsDiv.innerHTML = notifications.map(notif => `
    <div class="notification-item border-bottom pb-2 mb-2 ${!notif.is_read ? 'bg-light' : ''}" 
         onclick="openNotificationRequest('${notif.service_request_id}')" 
         style="cursor: pointer; transition: background-color 0.2s ease;"
         title="Click to view and submit quote">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h6 class="mb-1 small fw-bold">${notif.title}</h6>
          <p class="mb-1 small text-muted">${notif.message}</p>
          <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            ${new Date(notif.created_at).toLocaleString()}
          </small>
          <div class="mt-1">
            <small class="text-primary">
              <i class="fas fa-mouse-pointer me-1"></i>Click to submit quote
            </small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          ${!notif.is_read ? '<span class="badge bg-primary">New</span>' : ''}
          <i class="fas fa-quote-left text-primary"></i>
        </div>
      </div>
    </div>
  `).join('');
}

// Update notification count
function updateNotificationCount(count) {
  document.getElementById('notificationCount').textContent = count;
}

// Load service requests
async function loadServiceRequests() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      showError('Please login to view service requests');
      return;
    }
    
    console.log('Loading service requests...');
    const response = await fetch('/api/provider/service-requests', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Response data:', data);
    
    if (response.ok) {
      displayServiceRequests(data.service_requests || []);
    } else {
      if (response.status === 401) {
        showError('Session expired. Please login again.');
        localStorage.removeItem('token');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      } else {
        showError('Failed to load service requests: ' + (data.error || 'Unknown error'));
      }
    }
  } catch (error) {
    console.error('Error loading service requests:', error);
    showError('Error loading service requests: ' + error.message);
  }
}

// Display service requests
function displayServiceRequests(requests) {
  const requestsDiv = document.getElementById('serviceRequestsList');
  
  if (requests.length === 0) {
    requestsDiv.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No service requests found</h5>
        <p class="text-muted">There are currently no service requests within your area.</p>
        <button class="btn btn-primary" onclick="loadServiceRequests()">
          <i class="fas fa-refresh me-1"></i>Refresh
        </button>
      </div>
    `;
    return;
  }
  
  requestsDiv.innerHTML = requests.map(req => {
    const urgencyColors = {
      'emergency': 'danger',
      'urgent': 'warning',
      'normal': 'primary',
      'flexible': 'secondary'
    };
    
    const urgencyIcons = {
      'emergency': 'ðŸš¨',
      'urgent': 'âš¡',
      'normal': 'ðŸ“‹',
      'flexible': 'ðŸ“…'
    };
    
    const statusBadge = req.has_quoted ? 
      (req.quote_status === 'selected' ? 
        '<span class="badge bg-success">Selected</span>' : 
        '<span class="badge bg-warning">Quoted</span>') : 
      '<span class="badge bg-primary">Available</span>';
    
    return `
      <div class="request-card border rounded p-3 mb-3 hover-lift">
        <div class="row">
          <div class="col-md-8">
            <div class="d-flex align-items-start mb-2">
              <div class="me-3">
                <span class="badge bg-${urgencyColors[req.urgency]}">
                  ${urgencyIcons[req.urgency]} ${req.urgency.toUpperCase()}
                </span>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">${req.title}</h6>
                <p class="mb-2 small text-muted">${req.service_category} â€¢ ${req.distance}km away</p>
              </div>
            </div>
            
            <div class="mb-2">
              <p class="mb-1 small">${req.description}</p>
              <p class="mb-0 small text-muted">
                <i class="fas fa-map-marker-alt me-1"></i>
                ${req.location}
              </p>
            </div>
            
            ${req.preferred_date ? `
            <div class="mb-2">
              <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>
                ${new Date(req.preferred_date).toLocaleDateString()}
                ${req.preferred_time_slot ? ` - ${req.preferred_time_slot}` : ''}
              </small>
            </div>
            ` : ''}
            
            <div class="small text-muted">
              <i class="fas fa-clock me-1"></i>
              Posted ${new Date(req.created_at).toLocaleString()}
              ${req.quote_deadline ? ` â€¢ Deadline: ${new Date(req.quote_deadline).toLocaleString()}` : ''}
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="text-end">
              <div class="mb-2">${statusBadge}</div>
              
              ${req.images && req.images.length > 0 ? `
              <div class="mb-2">
                <small class="text-muted">Images:</small>
                <div class="d-flex gap-1 justify-content-end">
                  ${req.images.slice(0, 3).map(img => `
                    <img src="${img}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: cover;" alt="Request image">
                  `).join('')}
                  ${req.images.length > 3 ? `<span class="small text-muted">+${req.images.length - 3}</span>` : ''}
                </div>
              </div>
              ` : ''}
              
              <div class="d-grid gap-2">
                ${!req.has_quoted ? `
                <button class="btn btn-primary btn-sm" onclick="openQuoteModal('${req.id}')">
                  <i class="fas fa-quote-left me-1"></i>Submit Quote
                </button>
                ` : `
                <button class="btn btn-outline-secondary btn-sm" disabled>
                  <i class="fas fa-check me-1"></i>Already Quoted
                </button>
                `}
                <button class="btn btn-outline-info btn-sm" onclick="viewRequestDetails('${req.id}')">
                  <i class="fas fa-eye me-1"></i>View Details
                </button>
                ${req.has_quoted ? `
                <button class="btn btn-outline-danger btn-sm" onclick="cancelQuote('${req.id}')">
                  <i class="fas fa-times me-1"></i>Cancel Quote
                </button>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Open quote modal
async function openQuoteModal(requestId) {
  currentRequestId = requestId;
  
  try {
    const response = await fetch(`/api/service-requests/${requestId}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      displayRequestDetailsForQuote(data.service_request);
      const modal = new bootstrap.Modal(document.getElementById('quoteModal'));
      modal.show();
    } else {
      alert('Failed to load request details');
    }
  } catch (error) {
    console.error('Error loading request details:', error);
    alert('Error loading request details');
  }
}

// Display request details for quote
function displayRequestDetailsForQuote(request) {
  const detailsDiv = document.getElementById('requestDetailsForQuote');
  
  detailsDiv.innerHTML = `
    <div class="border rounded p-3 mb-3">
      <h6 class="fw-bold mb-2">${request.title}</h6>
      <p class="small mb-2">${request.description}</p>
      <div class="row g-2">
        <div class="col-6">
          <small class="text-muted">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${request.location}
          </small>
        </div>
        <div class="col-6">
          <small class="text-muted">
            <i class="fas fa-tag me-1"></i>
            ${request.service_category}
          </small>
        </div>
      </div>
    </div>
  `;
}

// Submit quote
document.getElementById('submitQuoteBtn').addEventListener('click', async function() {
  if (!currentRequestId) return;
  
  const price = document.getElementById('quotePrice').value;
  const estimatedDuration = document.getElementById('estimatedDuration').value;
  const quoteNotes = document.getElementById('quoteNotes').value;
  
  if (!price || price <= 0) {
    alert('Please enter a valid price');
    return;
  }
  
  try {
    this.disabled = true;
    this.textContent = 'Submitting...';
    
    console.log('Submitting quote for request:', currentRequestId);
    console.log('Quote data:', {
      price: parseFloat(price),
      estimated_duration: estimatedDuration,
      quote_notes: quoteNotes
    });
    
    const response = await fetch(`/api/service-requests/${currentRequestId}/quote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({
        price: parseFloat(price),
        estimated_duration: estimatedDuration,
        quote_notes: quoteNotes
      })
    });
    
    console.log('Quote submission response status:', response.status);
    const result = await response.json();
    console.log('Quote submission result:', result);
    
    if (response.ok) {
      alert('Quote submitted successfully!');
      bootstrap.Modal.getInstance(document.getElementById('quoteModal')).hide();
      loadServiceRequests(); // Refresh the list
    } else {
      if (response.status === 401) {
        alert('Session expired. Please login again.');
        localStorage.removeItem('token');
        window.location.href = '/login';
      } else {
        alert('Error submitting quote: ' + (result.error || 'Unknown error'));
      }
    }
  } catch (error) {
    console.error('Error submitting quote:', error);
    alert('Error submitting quote. Please try again.');
  } finally {
    this.disabled = false;
    this.textContent = 'Submit Quote';
  }
});

// View request details
async function viewRequestDetails(requestId) {
  try {
    console.log('Loading request details for:', requestId);
    const response = await fetch(`/api/service-requests/${requestId}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Response data:', data);
    
    if (response.ok) {
      // Create a modal to show request details
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Service Request Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-12">
                  <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-${data.service_request.urgency === 'emergency' ? 'danger' : data.service_request.urgency === 'urgent' ? 'warning' : 'primary'} me-2">
                      ${data.service_request.urgency.toUpperCase()}
                    </span>
                    <span class="badge bg-secondary">${data.service_request.service_category}</span>
                  </div>
                  <h6 class="fw-bold">${data.service_request.title}</h6>
                  <p class="text-muted">${data.service_request.description}</p>
                </div>
                <div class="col-md-6">
                  <strong>Service Category:</strong>
                  <p>${data.service_request.service_category}</p>
                </div>
                <div class="col-md-6">
                  <strong>Urgency:</strong>
                  <p><span class="badge bg-${data.service_request.urgency === 'emergency' ? 'danger' : data.service_request.urgency === 'urgent' ? 'warning' : 'primary'}">${data.service_request.urgency}</span></p>
                </div>
                <div class="col-md-6">
                  <strong>Location:</strong>
                  <p><i class="fas fa-map-marker-alt me-1"></i>${data.service_request.location}</p>
                </div>
                <div class="col-md-6">
                  <strong>Posted:</strong>
                  <p>${new Date(data.service_request.created_at).toLocaleString()}</p>
                </div>
                ${data.service_request.preferred_date ? `
                <div class="col-md-6">
                  <strong>Preferred Date:</strong>
                  <p>${new Date(data.service_request.preferred_date).toLocaleDateString()}</p>
                </div>
                ` : ''}
                ${data.service_request.preferred_time_slot ? `
                <div class="col-md-6">
                  <strong>Preferred Time:</strong>
                  <p>${data.service_request.preferred_time_slot}</p>
                </div>
                ` : ''}
                ${data.service_request.images && data.service_request.images.length > 0 ? `
                <div class="col-12">
                  <strong>Images:</strong>
                  <div class="row g-2 mt-2">
                    ${data.service_request.images.map(img => `
                      <div class="col-md-4">
                        <img src="${img}" class="img-fluid rounded" alt="Request image">
                      </div>
                    `).join('')}
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="openQuoteModal('${requestId}')">
                <i class="fas fa-quote-left me-1"></i>Submit Quote
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      // Remove modal after hiding
      modal.addEventListener('hidden.bs.modal', () => modal.remove());
    } else {
      if (response.status === 401) {
        alert('Session expired. Please login again.');
        localStorage.removeItem('token');
        window.location.href = '/login';
      } else {
        alert('Failed to load request details: ' + (data.error || 'Unknown error'));
      }
    }
  } catch (error) {
    console.error('Error loading request details:', error);
    alert('Error loading request details: ' + error.message);
  }
}

// Open service request from notification
function openNotificationRequest(requestId) {
  console.log('Opening notification request:', requestId);
  
  // First, check if the request exists in the current list
  const requestCards = document.querySelectorAll('.request-card');
  let foundRequest = null;
  
  requestCards.forEach(card => {
    if (card.innerHTML.includes(`'${requestId}'`)) {
      foundRequest = card;
    }
  });
  
  if (foundRequest) {
    console.log('Request found in current list');
    // Scroll to the request and highlight it
    foundRequest.scrollIntoView({ behavior: 'smooth', block: 'center' });
    foundRequest.style.backgroundColor = '#fff3cd';
    foundRequest.style.borderColor = '#ffc107';
    
    // Check if the request allows quoting (not already quoted)
    const quoteButton = foundRequest.querySelector('button[onclick*="openQuoteModal"]');
    const viewDetailsButton = foundRequest.querySelector('button[onclick*="viewRequestDetails"]');
    
    console.log('Quote button found:', !!quoteButton);
    console.log('View details button found:', !!viewDetailsButton);
    
    if (quoteButton) {
      // If quote button exists, automatically open the quote modal
      console.log('Opening quote modal for request:', requestId);
      setTimeout(() => {
        openQuoteModal(requestId);
      }, 500); // Small delay to let the scroll animation complete
    } else if (viewDetailsButton) {
      // If already quoted, open the details modal instead
      console.log('Opening details modal for request:', requestId);
      setTimeout(() => {
        viewRequestDetails(requestId);
      }, 500);
    }
    
    // Remove highlight after 3 seconds
    setTimeout(() => {
      foundRequest.style.backgroundColor = '';
      foundRequest.style.borderColor = '';
    }, 3000);
  } else {
    // If request not found in current list, refresh and try again
    console.log('Request not found in current list, refreshing...');
    loadServiceRequests();
    setTimeout(() => {
      openNotificationRequest(requestId);
    }, 1000);
  }
}

// Cancel quote
async function cancelQuote(requestId) {
  if (!confirm('Are you sure you want to cancel your quote for this service request?')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/service-requests/${requestId}/cancel-quote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    const result = await response.json();
    
    if (response.ok) {
      alert('Quote cancelled successfully!');
      loadServiceRequests(); // Refresh the list
    } else {
      alert('Error cancelling quote: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error cancelling quote:', error);
    alert('Error cancelling quote. Please try again.');
  }
}


// Show error
function showError(message) {
  document.getElementById('serviceRequestsList').innerHTML = `
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle me-2"></i>
      ${message}
    </div>
  `;
}
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
.request-card {
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.request-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.hover-lift:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.notification-item {
  transition: background-color 0.2s ease-in-out;
  border-radius: 0.375rem;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.notification-item:hover {
  background-color: #e3f2fd !important;
  transform: translateX(2px);
}
</style>
{% endblock %}