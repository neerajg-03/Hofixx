{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Tracking Header -->
  <section class="py-4 bg-gradient-primary text-white">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-2">
            <a href="/dashboard/user/new" class="btn btn-outline-light btn-sm me-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            <h2 class="mb-0 fw-bold">Track Your Provider</h2>
          </div>
          <p class="text-white-50 mb-0">Real-time location tracking and ETA</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="tracking-status-card p-3 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0 fw-bold text-white" id="providerName">Provider Name</h6>
              <span class="badge bg-success" id="providerStatus">On the way</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-white-50 small">ETA:</span>
              <span class="fw-bold text-white" id="etaDisplay">15 mins</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tracking Map -->
  <section class="py-4 bg-light">
    <div class="container">
      <div class="row g-4">
        <!-- Map Section -->
        <div class="col-lg-8">
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="fw-bold mb-0">Live Tracking</h5>
                <div class="d-flex gap-2">
                  <button id="centerMapBtn" class="btn btn-outline-primary btn-sm rounded-pill">
                    <i class="fas fa-crosshairs me-1"></i>Center Map
                  </button>
                  <button id="refreshLocationBtn" class="btn btn-primary btn-sm rounded-pill">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="trackingMap" style="height: 400px; border-radius: 0.75rem; overflow: hidden;"></div>
            </div>
          </div>
        </div>

        <!-- Tracking Details -->
        <div class="col-lg-4">
          <div class="card shadow-sm rounded-4 border-0 mb-4">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Tracking Details</h5>
            </div>
            <div class="card-body">
              <div class="tracking-info">
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Provider</div>
                    <div class="text-muted small" id="providerNameDetail">Loading...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-route text-info"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Distance</div>
                    <div class="text-muted small" id="distanceDetail">Calculating...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-clock text-warning"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Estimated Arrival</div>
                    <div class="text-muted small" id="etaDetail">Calculating...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-map-marker-alt text-success"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Current Location</div>
                    <div class="text-muted small" id="currentLocation">Loading...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contact Provider -->
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Contact Provider</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary rounded-pill" id="callProviderBtn">
                  <i class="fas fa-phone me-2"></i>Call Provider
                </button>
                <button class="btn btn-outline-success rounded-pill" id="messageProviderBtn">
                  <i class="fas fa-message me-2"></i>Send Message
                </button>
                <button class="btn btn-outline-warning rounded-pill" id="cancelBookingBtn">
                  <i class="fas fa-times me-2"></i>Cancel Booking
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Booking Details -->
  <section class="py-4 bg-white">
    <div class="container">
      <div class="card shadow-sm rounded-4 border-0">
        <div class="card-header bg-white border-0 pb-0">
          <h5 class="fw-bold mb-3">Booking Details</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Service</div>
                <div class="fw-bold" id="serviceName">Electrician</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Booking ID</div>
                <div class="fw-bold" id="bookingId">#12345</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Scheduled Time</div>
                <div class="fw-bold" id="scheduledTime">Today, 2:00 PM</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Price</div>
                <div class="fw-bold text-success" id="bookingPrice">‚Çπ500</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content chat-modal">
      <div class="modal-header chat-header">
        <div class="d-flex align-items-center">
          <div class="chat-avatar me-3">
            <img id="chatProviderAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Provider&backgroundColor=c7a2ff" 
                 alt="Provider" class="rounded-circle" width="40" height="40">
            <div class="online-indicator"></div>
          </div>
          <div>
            <h5 class="modal-title mb-0" id="chatProviderName">Provider Name</h5>
            <small class="text-muted" id="chatProviderStatus">Online</small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body chat-body p-0">
        <div class="chat-messages" id="chatMessages">
          <!-- Messages will be loaded here -->
        </div>
        <div class="chat-typing-indicator d-none" id="typingIndicator">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="typing-text">Provider is typing...</span>
        </div>
      </div>
      <div class="modal-footer chat-footer">
        <div class="input-group">
          <input type="text" class="form-control chat-input" id="messageInput" 
                 placeholder="Type your message..." maxlength="500">
          <button class="btn btn-primary" type="button" id="sendMessageBtn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <div class="chat-actions mt-2">
          <button class="btn btn-outline-secondary btn-sm" id="attachFileBtn">
            <i class="fas fa-paperclip me-1"></i>Attach
          </button>
          <button class="btn btn-outline-info btn-sm" id="sendLocationBtn">
            <i class="fas fa-map-marker-alt me-1"></i>Location
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- Google Maps API will be loaded dynamically -->
<script>
(function() {
  'use strict';
  
  // Global variables
  let trackingMap;
  let providerMarker;
  let userMarker;
  let routePolyline;
  let trackingInterval;
  let socket;
  let currentUserLocation = null;
  let currentProviderLocation = null;
  let routeWaypoints = [];
  
  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const providerId = urlParams.get('provider_id');
  const bookingId = urlParams.get('booking_id');
  
  // Initialize tracking
  document.addEventListener('DOMContentLoaded', async function() {
    if (!providerId) {
      showError('Provider ID not provided');
      return;
    }
    
    await initializeTracking();
    setupSocketConnection();
    startTracking();
    setupEventListeners();
  });
  
  // Initialize tracking map
  async function initializeTracking() {
    // Load Google Maps API if not already loaded
    if (typeof google === 'undefined') {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAG0GnKSwNcd_HtC1x1xVdzf-aWtzTIGBs&callback=initGoogleTrackingMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
      window.initGoogleTrackingMap = () => {
        createGoogleTrackingMap();
      };
    } else {
      createGoogleTrackingMap();
    }
  }

  function createGoogleTrackingMap() {
    // Initialize map
    const mapOptions = {
      center: { lat: 28.6139, lng: 77.2090 },
      zoom: 13,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    
    trackingMap = new google.maps.Map(document.getElementById('trackingMap'), mapOptions);
    
    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        currentUserLocation = { lat: userLat, lon: userLon };
        
        userMarker = new google.maps.Marker({
          position: { lat: userLat, lng: userLon },
          map: trackingMap,
          title: 'Your Location',
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                <circle cx="15" cy="15" r="12" fill="#0d6efd" stroke="#fff" stroke-width="2"/>
                <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-family="Arial">üè†</text>
              </svg>
            `),
            scaledSize: new google.maps.Size(30, 30)
          }
        });
        
        const userInfoWindow = new google.maps.InfoWindow({
          content: `
          <div class="location-popup">
            <h6 class="mb-1 fw-bold">Your Location</h6>
            <div class="text-muted small">${getAddressFromCoords(userLat, userLon)}</div>
          </div>
          `
        });
        
        userMarker.addListener('click', () => {
          userInfoWindow.open(trackingMap, userMarker);
        });
        
        // Load provider location and route
        loadProviderLocation(userLat, userLon);
        loadProviderRoute(userLat, userLon);
      }, error => {
        console.error('Geolocation error:', error);
        // Use default location
        currentUserLocation = { lat: 28.6139, lon: 77.2090 };
        loadProviderLocation(28.6139, 77.2090);
        loadProviderRoute(28.6139, 77.2090);
      });
    } else {
      // Use default location
      currentUserLocation = { lat: 28.6139, lon: 77.2090 };
      loadProviderLocation(28.6139, 77.2090);
      loadProviderRoute(28.6139, 77.2090);
    }
  }
  
  // Load provider location and details
  async function loadProviderLocation(userLat, userLon) {
    try {
      const token = localStorage.getItem('token');
      console.log('Token from localStorage:', token);
      const url = `/providers/${providerId}/location-data?user_lat=${userLat}&user_lon=${userLon}${bookingId ? `&booking_id=${bookingId}` : ''}`;
      console.log('Making request to:', url);
      
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(url, {
        headers: headers
      });
      
      if (response.ok) {
        const trackingData = await response.json();
        console.log('Tracking data received:', trackingData);
        
        currentProviderLocation = trackingData.location;
        updateTrackingDisplay(trackingData);
        updateMapMarkers(trackingData);
        updateBookingDetails(trackingData.booking);
      } else {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        showError(errorData.error || 'Failed to load provider location');
      }
    } catch (error) {
      console.error('Error loading provider location:', error);
      showError('Failed to load provider location');
    }
  }
  
  // Load provider route
  async function loadProviderRoute(userLat, userLon) {
    try {
      const token = localStorage.getItem('token');
      const url = `/providers/${providerId}/route?user_lat=${userLat}&user_lon=${userLon}`;
      
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(url, {
        headers: headers
      });
      
      if (response.ok) {
        const routeData = await response.json();
        routeWaypoints = routeData.waypoints;
        drawRoute(routeData);
        updateRouteDetails(routeData);
      } else {
        console.warn('Failed to load route data');
      }
    } catch (error) {
      console.error('Error loading route:', error);
    }
  }
  
  // Draw route on map
  function drawRoute(routeData) {
    // Remove existing route
    if (routePolyline) {
      routePolyline.setMap(null);
    }
    
    // Create route points
    const routePoints = routeData.waypoints.map(point => ({
      lat: point.lat,
      lng: point.lon
    }));
    
    // Draw route polyline
    routePolyline = new google.maps.Polyline({
      path: routePoints,
      geodesic: true,
      strokeColor: '#667eea',
      strokeOpacity: 0.8,
      strokeWeight: 4
    });
    
    routePolyline.setMap(trackingMap);
    
    // Add waypoint markers
    routeData.waypoints.forEach((point, index) => {
      let iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
        <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="10" r="8" fill="#667eea" stroke="#fff" stroke-width="2"/>
          <text x="10" y="14" text-anchor="middle" fill="white" font-size="10" font-family="Arial">‚óè</text>
        </svg>
      `);
      
      if (point.status === 'start') {
        iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#28a745" stroke="#fff" stroke-width="2"/>
            <text x="10" y="14" text-anchor="middle" fill="white" font-size="10" font-family="Arial">‚ñ∂</text>
          </svg>
        `);
      } else if (point.status === 'destination') {
        iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#dc3545" stroke="#fff" stroke-width="2"/>
            <text x="10" y="14" text-anchor="middle" fill="white" font-size="10" font-family="Arial">üèÅ</text>
          </svg>
        `);
      }
      
      const waypointMarker = new google.maps.Marker({
        position: { lat: point.lat, lng: point.lon },
        map: trackingMap,
        title: point.status.charAt(0).toUpperCase() + point.status.slice(1),
        icon: {
          url: iconUrl,
          scaledSize: new google.maps.Size(20, 20)
        }
      });
      
      const waypointInfoWindow = new google.maps.InfoWindow({
        content: `
        <div class="waypoint-popup">
          <h6 class="mb-1 fw-bold">${point.status.charAt(0).toUpperCase() + point.status.slice(1)}</h6>
          <div class="text-muted small">${new Date(point.timestamp).toLocaleTimeString()}</div>
        </div>
        `
      });
      
      waypointMarker.addListener('click', () => {
        waypointInfoWindow.open(trackingMap, waypointMarker);
      });
    });
    
    // Fit map to show entire route
    if (routePoints.length > 0) {
      const bounds = new google.maps.LatLngBounds();
      routePoints.forEach(point => {
        bounds.extend(new google.maps.LatLng(point.lat, point.lng));
      });
      trackingMap.fitBounds(bounds);
    }
  }
  
  // Update route details
  function updateRouteDetails(routeData) {
    const routeSummary = routeData.route_summary;
    const traffic = routeData.traffic_conditions;
    
    // Update distance and duration
    document.getElementById('distanceDetail').textContent = routeSummary.distance;
    document.getElementById('etaDetail').textContent = routeSummary.duration;
    
    // Add traffic information
    const trafficInfo = document.createElement('div');
    trafficInfo.className = 'traffic-info mt-2 p-2 rounded';
    trafficInfo.style.cssText = `
      background: ${getTrafficColor(traffic.level)};
      color: white;
      font-size: 0.8rem;
    `;
    trafficInfo.innerHTML = `
      <i class="fas fa-car me-1"></i>
      Traffic: ${traffic.level} (${traffic.delay_minutes} min delay)
    `;
    
    const distanceContainer = document.getElementById('distanceDetail').parentElement;
    if (!distanceContainer.querySelector('.traffic-info')) {
      distanceContainer.appendChild(trafficInfo);
    }
  }
  
  // Get traffic color
  function getTrafficColor(level) {
    const colors = {
      'Light': '#28a745',
      'Moderate': '#ffc107',
      'Heavy': '#fd7e14',
      'Severe': '#dc3545'
    };
    return colors[level] || '#6c757d';
  }
  
  // Update booking details
  function updateBookingDetails(booking) {
    if (booking) {
      document.getElementById('serviceName').textContent = booking.service_name || 'Service';
      document.getElementById('bookingId').textContent = `#${booking.id.slice(-6)}`;
      document.getElementById('scheduledTime').textContent = 
        booking.scheduled_time ? new Date(booking.scheduled_time).toLocaleString() : 'Not scheduled';
      document.getElementById('bookingPrice').textContent = `‚Çπ${booking.price || 0}`;
    }
  }
  
  // Get address from coordinates (simplified)
  function getAddressFromCoords(lat, lon) {
    // In a real app, you'd use a geocoding service
    return `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  }
  
  // Update tracking display
  function updateTrackingDisplay(data) {
    console.log('Updating tracking display with data:', data);
    
    // Update provider name
    const providerName = data.provider?.name || 'Provider';
    document.getElementById('providerName').textContent = providerName;
    document.getElementById('providerNameDetail').textContent = providerName;
    
    // Update distance and ETA
    const distance = data.distance?.km;
    const eta = data.distance?.eta_minutes;
    
    if (distance !== null && distance !== undefined) {
      document.getElementById('distanceDetail').textContent = `${distance} km`;
    } else {
      document.getElementById('distanceDetail').textContent = 'Calculating...';
    }
    
    if (eta !== null && eta !== undefined) {
      document.getElementById('etaDetail').textContent = `${eta} minutes`;
      document.getElementById('etaDisplay').textContent = `${eta} mins`;
    } else {
      document.getElementById('etaDetail').textContent = 'Calculating...';
      document.getElementById('etaDisplay').textContent = 'Calculating...';
    }
    
    // Update location
    const location = data.location?.address || 'Location available';
    document.getElementById('currentLocation').textContent = location;
    
    // Update status
    const status = data.status || 'on_the_way';
    document.getElementById('providerStatus').textContent = status.replace('_', ' ').toUpperCase();
  }
  
  // Update map markers
  function updateMapMarkers(data) {
    console.log('Updating map markers with data:', data);
    
    // Remove existing provider marker
    if (providerMarker) {
      providerMarker.setMap(null);
    }
    
    // Add provider marker
    providerMarker = new google.maps.Marker({
      position: { lat: data.location.lat, lng: data.location.lon },
      map: trackingMap,
      title: data.provider?.name || 'Provider',
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
            <circle cx="15" cy="15" r="12" fill="#28a745" stroke="#fff" stroke-width="2"/>
            <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-family="Arial">üöö</text>
          </svg>
        `),
        scaledSize: new google.maps.Size(30, 30)
      }
    });
    
    const providerInfoWindow = new google.maps.InfoWindow({
      content: `
        <div class="provider-popup">
          <h6 class="mb-1 fw-bold">${data.provider?.name || 'Provider'}</h6>
          <div class="text-muted small">Distance: ${data.distance?.km || 'Unknown'} km</div>
          <div class="text-muted small">ETA: ${data.distance?.eta_minutes || 'Unknown'} minutes</div>
        </div>
      `
    });
    
    providerMarker.addListener('click', () => {
      providerInfoWindow.open(trackingMap, providerMarker);
    });
    
    // Fit map to show both markers
    if (userMarker && providerMarker) {
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(userMarker.getPosition());
      bounds.extend(providerMarker.getPosition());
      trackingMap.fitBounds(bounds);
    }
  }
  
  // Setup Socket.IO connection
  function setupSocketConnection() {
    socket = io();
    
    socket.on('connect', function() {
      console.log('Connected to tracking server');
      showNotification('Connected to real-time tracking', 'success');
      
      // Join user room for chat messages
      const token = getAuthToken();
      if (token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          const claims = payload?.sub && typeof payload.sub === 'object' ? payload.sub : (payload?.claims || payload);
          const userId = claims?.id || claims?.user_id || claims?.sub;
          if (userId) {
            socket.emit('join_user_room', { user_id: userId });
            console.log(`User ${userId} joined socket room for chat`);
          }
        } catch (error) {
          console.error('Error parsing token for WebSocket room:', error);
        }
      }
    });
    
    socket.on('disconnect', function() {
      console.log('Disconnected from tracking server');
      showNotification('Disconnected from real-time tracking', 'warning');
    });
    
    // Listen for new chat messages
    socket.on('new_message', (data) => {
      console.log('Received new message:', data);
      if (data.booking_id === bookingId) {
        // Add message to chat if modal is open
        if (document.getElementById('chatModal') && !document.getElementById('chatModal').classList.contains('d-none')) {
          addMessageToChat({
            id: Date.now(),
            sender_type: data.sender_type,
            sender_name: data.sender_name,
            content: data.message,
            timestamp: data.timestamp,
            type: 'text'
          });
        }
      }
    });

    // Listen for provider location updates
    socket.on('provider_location_update', (data) => {
      if (data.provider_id === providerId) {
        console.log('Received provider location update:', data);
        
        // Update provider location
        currentProviderLocation = {
          lat: data.lat,
          lon: data.lon,
          address: data.address || 'Current location'
        };
        
        // Update map markers
        updateMapMarkers({
          provider_name: data.name,
          location: currentProviderLocation,
          distance_km: 'Calculating...',
          eta_minutes: 'Calculating...',
          status: 'On the way'
        });
        
        // Reload tracking data for updated ETA and distance
        if (currentUserLocation) {
          loadProviderLocation(currentUserLocation.lat, currentUserLocation.lon);
        }
        
        // Show notification
        showNotification(`${data.name} location updated`, 'info');
      }
    });
    
    // Listen for booking status updates
    socket.on('booking_status', (data) => {
      if (data.id === bookingId) {
        console.log('Received booking status update:', data);
        showNotification(`Booking status: ${data.status}`, 'info');
        
        // Update booking details if needed
        if (data.service_name) {
          document.getElementById('serviceName').textContent = data.service_name;
        }
      }
    });
  }
  
  // Start tracking
  function startTracking() {
    // Update location every 5 seconds for real-time tracking
    trackingInterval = setInterval(() => {
      if (currentUserLocation) {
        loadProviderLocation(currentUserLocation.lat, currentUserLocation.lon);
      }
    }, 5000);
    
    // Also listen for real-time location updates via Socket.IO
    setupRealtimeLocationUpdates();
  }
  
  // Setup real-time location updates via Socket.IO
  function setupRealtimeLocationUpdates() {
    if (socket) {
      // Listen for provider location updates
      socket.on('provider_location_update', (data) => {
        if (data.provider_id === providerId) {
          console.log('Real-time provider location update:', data);
          
          // Update provider location immediately
          currentProviderLocation = {
            lat: data.lat,
            lon: data.lon
          };
          
          // Update map marker
          if (providerMarker) {
            providerMarker.setPosition({ lat: data.lat, lng: data.lon });
          } else {
            // Create new marker if it doesn't exist
            providerMarker = new google.maps.Marker({
              position: { lat: data.lat, lng: data.lon },
              map: trackingMap,
              title: 'Provider Location',
              icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="15" cy="15" r="12" fill="#28a745" stroke="#fff" stroke-width="2"/>
                    <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-family="Arial">üöö</text>
                  </svg>
                `),
                scaledSize: new google.maps.Size(30, 30)
              }
            });
            
            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div class="location-popup">
                  <h6 class="mb-1 fw-bold">Provider Location</h6>
                  <div class="text-muted small">Updated: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                </div>
              `
            });
            
            providerMarker.addListener('click', () => {
              infoWindow.open(trackingMap, providerMarker);
            });
          }
          
          // Update tracking details
          if (currentUserLocation) {
            const distance = calculateDistance(
              currentUserLocation.lat, currentUserLocation.lon,
              data.lat, data.lon
            );
            const eta = Math.max(5, Math.round((distance / 30) * 60)); // 30 km/h average
            
            updateTrackingDisplay({
              location: { lat: data.lat, lon: data.lon },
              distance_km: distance,
              eta_minutes: eta,
              last_updated: data.timestamp
            });
          }
          
          // Show real-time update notification
          showRealtimeUpdateNotification();
        }
      });
    }
  }
  
  // Calculate distance between two coordinates using Haversine formula
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distance in kilometers
  }

  // Show real-time update notification
  function showRealtimeUpdateNotification() {
    const notification = document.createElement('div');
    notification.className = 'position-fixed top-0 end-0 m-3 alert alert-info alert-dismissible fade show';
    notification.style.zIndex = '9999';
    notification.style.fontSize = '0.8rem';
    notification.innerHTML = `
      <i class="fas fa-sync-alt me-2"></i>
      Provider location updated
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 2 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 2000);
  }
  
  // Show notification
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
  
  // Get notification icon
  function getNotificationIcon(type) {
    const icons = {
      'success': 'check-circle',
      'error': 'exclamation-triangle',
      'warning': 'exclamation-triangle',
      'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
  }
  
  // Setup event listeners
  function setupEventListeners() {
    // Center map button
    document.getElementById('centerMapBtn').addEventListener('click', () => {
      if (userMarker && providerMarker) {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(userMarker.getPosition());
        bounds.extend(providerMarker.getPosition());
        trackingMap.fitBounds(bounds);
      }
    });
    
    // Refresh location button
    document.getElementById('refreshLocationBtn').addEventListener('click', () => {
      if (currentUserLocation) {
        loadProviderLocation(currentUserLocation.lat, currentUserLocation.lon);
        loadProviderRoute(currentUserLocation.lat, currentUserLocation.lon);
        showNotification('Location refreshed', 'info');
      }
    });
    
    // Contact buttons
    document.getElementById('callProviderBtn').addEventListener('click', () => {
      // Get provider phone number and initiate call
      if (currentProviderLocation && currentProviderLocation.phone) {
        window.open(`tel:${currentProviderLocation.phone}`, '_self');
      } else {
        showNotification('Provider phone number not available', 'warning');
      }
    });
    
    document.getElementById('messageProviderBtn').addEventListener('click', () => {
      openChatModal();
    });
    
    document.getElementById('cancelBookingBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel this booking?')) {
        cancelBooking();
      }
    });
  }
  
  // Show error message
  function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    `;
    document.body.appendChild(alertDiv);
  }
  
  // Chat functionality
  let chatMessages = [];
  let isTyping = false;
  let typingTimeout;
  
  // Open chat modal
  function openChatModal() {
    const modal = new bootstrap.Modal(document.getElementById('chatModal'));
    modal.show();
    
    // Update chat header with provider info
    document.getElementById('chatProviderName').textContent = document.getElementById('providerName').textContent;
    
    // Load chat history
    loadChatHistory();
    
    // Setup chat event listeners
    setupChatEventListeners();
  }
  
  // Setup chat event listeners
  function setupChatEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendMessageBtn');
    const attachBtn = document.getElementById('attachFileBtn');
    const locationBtn = document.getElementById('sendLocationBtn');
    
    // Send message on button click
    sendBtn.addEventListener('click', sendMessage);
    
    // Send message on Enter key
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Typing indicator
    messageInput.addEventListener('input', () => {
      if (!isTyping) {
        isTyping = true;
        socket.emit('typing_start', { provider_id: providerId, booking_id: bookingId });
      }
      
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        isTyping = false;
        socket.emit('typing_stop', { provider_id: providerId, booking_id: bookingId });
      }, 1000);
    });
    
    // Attach file
    attachBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,application/pdf,.doc,.docx';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          sendFileMessage(file);
        }
      };
      input.click();
    });
    
    // Send location
    locationBtn.addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const location = {
            lat: position.coords.latitude,
            lon: position.coords.longitude,
            address: 'Current location'
          };
          sendLocationMessage(location);
        }, (error) => {
          showNotification('Unable to get your location', 'error');
        });
      } else {
        showNotification('Geolocation not supported', 'error');
      }
    });
  }
  
  // Get auth token
  function getAuthToken() {
    return localStorage.getItem('token');
  }
  
  // Load chat history
  async function loadChatHistory() {
    try {
      const token = getAuthToken();
      const response = await fetch(`/api/chat/${bookingId}/messages`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const messages = await response.json();
        chatMessages = messages;
        renderChatMessages();
      } else {
        // If no chat history, show empty state
        showEmptyChatState();
      }
    } catch (error) {
      console.error('Error loading chat history:', error);
      showEmptyChatState();
    }
  }
  
  // Render chat messages
  function renderChatMessages() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    if (chatMessages.length === 0) {
      showEmptyChatState();
      return;
    }
    
    chatMessages.forEach(message => {
      addMessageToChat(message, false);
    });
    
    scrollToBottom();
  }
  
  // Show empty chat state
  function showEmptyChatState() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
      <div class="chat-empty-state">
        <i class="fas fa-comments"></i>
        <h6>Start a conversation</h6>
        <p class="small">Send a message to your provider to get started</p>
      </div>
    `;
  }
  
  // Add message to chat
  function addMessageToChat(message, animate = true) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // Remove empty state if it exists
    const emptyState = messagesContainer.querySelector('.chat-empty-state');
    if (emptyState) {
      emptyState.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${message.sender_type}`;
    
    const isUser = message.sender_type === 'user';
    const senderName = isUser ? 'You' : message.sender_name || 'Provider';
    const timestamp = new Date(message.timestamp).toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    let messageContent = '';
    
    if (message.type === 'text') {
      messageContent = `
        <div class="message-bubble ${message.sender_type}">
          <div class="message-text">${escapeHtml(message.content)}</div>
          <div class="message-meta">
            ${timestamp}
            <span class="message-status ${message.status || 'sent'}"></span>
          </div>
        </div>
      `;
    } else if (message.type === 'file') {
      messageContent = `
        <div class="message-bubble ${message.sender_type}">
          <div class="message-file">
            <i class="fas fa-paperclip me-2"></i>
            <a href="${message.file_url}" target="_blank" class="text-decoration-none">
              ${message.file_name}
            </a>
          </div>
          <div class="message-meta">
            ${timestamp}
            <span class="message-status ${message.status || 'sent'}"></span>
          </div>
        </div>
      `;
    } else if (message.type === 'location') {
      messageContent = `
        <div class="message-bubble ${message.sender_type}">
          <div class="message-location">
            <i class="fas fa-map-marker-alt me-2"></i>
            <a href="https://maps.google.com/?q=${message.location.lat},${message.location.lon}" 
               target="_blank" class="text-decoration-none">
              ${message.location.address}
            </a>
          </div>
          <div class="message-meta">
            ${timestamp}
            <span class="message-status ${message.status || 'sent'}"></span>
          </div>
        </div>
      `;
    }
    
    messageDiv.innerHTML = messageContent;
    
    if (animate) {
      messageDiv.style.opacity = '0';
      messageDiv.style.transform = 'translateY(20px)';
    }
    
    messagesContainer.appendChild(messageDiv);
    
    if (animate) {
      setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease-out';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
      }, 100);
    }
    
    scrollToBottom();
  }
  
  // Send text message
  function sendMessage() {
    console.log('sendMessage function called');
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    console.log('Message to send:', message);
    console.log('Booking ID:', bookingId);
    
    if (!message) {
      console.log('No message to send');
      return;
    }
    
    if (!bookingId) {
      console.error('No booking ID available');
      showNotification('Error: No booking ID found', 'error');
      return;
    }
    
    // Send to server
    console.log('Sending message to /api/chat/send');
    fetch('/api/chat/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAuthToken()}`
      },
      body: JSON.stringify({
        booking_id: bookingId,
        sender_type: 'user',
        type: 'text',
        content: message
      })
    })
    .then(response => {
      console.log('Response status:', response.status);
      return response.json();
    })
    .then(messageData => {
      console.log('Message data received:', messageData);
      // Add message to chat
      addMessageToChat(messageData);
      chatMessages.push(messageData);
      
      // Clear input
      messageInput.value = '';
      showNotification('Message sent successfully!', 'success');
    })
    .catch(error => {
      console.error('Error sending message:', error);
      showNotification('Failed to send message', 'error');
    });
  }
  
  // Send file message
  function sendFileMessage(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('provider_id', providerId);
    formData.append('booking_id', bookingId);
    
    const messageData = {
      type: 'file',
      file_name: file.name,
      file_url: '#', // Will be updated when server responds
      sender_type: 'user',
      provider_id: providerId,
      booking_id: bookingId,
      timestamp: new Date().toISOString()
    };
    
    // Add to local chat immediately
    addMessageToChat(messageData);
    chatMessages.push(messageData);
    
    // Upload file
    fetch('/api/chat/upload', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
      body: formData
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
          messageData.file_url = data.file_url;
          socket.emit('chat_message', messageData);
        } else {
          showNotification('Failed to upload file', 'error');
        }
      })
      .catch(error => {
        console.error('File upload error:', error);
        showNotification('Failed to upload file', 'error');
      });
  }
  
  // Send location message
  function sendLocationMessage(location) {
    const messageData = {
      type: 'location',
      location: location,
      sender_type: 'user',
      provider_id: providerId,
      booking_id: bookingId,
      timestamp: new Date().toISOString()
    };
    
    // Add to local chat immediately
    addMessageToChat(messageData);
    chatMessages.push(messageData);
    
    // Send to server
    socket.emit('chat_message', messageData);
  }
  
  // Scroll to bottom of chat
  function scrollToBottom() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // Show message status
  function showMessageStatus(message, type) {
    const statusDiv = document.createElement('div');
    statusDiv.className = `alert alert-${type} alert-sm position-absolute`;
    statusDiv.style.cssText = 'top: 10px; right: 10px; z-index: 1000; font-size: 0.8rem;';
    statusDiv.textContent = message;
    
    document.getElementById('chatModal').appendChild(statusDiv);
    
    setTimeout(() => {
      statusDiv.remove();
    }, 2000);
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Setup chat socket events
  function setupChatSocketEvents() {
    // Listen for incoming messages
    socket.on('chat_message', (message) => {
      if (message.booking_id === bookingId) {
        addMessageToChat(message);
        chatMessages.push(message);
        
        // Show notification if chat is not focused
        if (document.hidden) {
          showNotification(`New message from ${message.sender_name}`, 'info');
        }
      }
    });
    
    // Listen for typing indicators
    socket.on('typing_start', (data) => {
      if (data.provider_id === providerId && data.booking_id === bookingId) {
        document.getElementById('typingIndicator').classList.remove('d-none');
      }
    });
    
    socket.on('typing_stop', (data) => {
      if (data.provider_id === providerId && data.booking_id === bookingId) {
        document.getElementById('typingIndicator').classList.add('d-none');
      }
    });
    
    // Listen for message status updates
    socket.on('message_status', (data) => {
      if (data.booking_id === bookingId) {
        // Update message status in chat
        const messageElements = document.querySelectorAll('.chat-message');
        messageElements.forEach(element => {
          const statusElement = element.querySelector('.message-status');
          if (statusElement && data.message_id) {
            statusElement.className = `message-status ${data.status}`;
          }
        });
      }
    });
  }
  
  // Initialize chat socket events
  setupChatSocketEvents();

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (trackingInterval) {
      clearInterval(trackingInterval);
    }
    if (socket) {
      socket.disconnect();
    }
  });
  
  
  
  
  
  // Cancel booking
  async function cancelBooking() {
    if (!bookingId) {
      showNotification('No booking to cancel', 'warning');
      return;
    }
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/bookings/${bookingId}/cancel`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        showNotification('Booking cancelled successfully', 'success');
        // Redirect to dashboard after a delay
        setTimeout(() => {
          window.location.href = '/dashboard/user/new';
        }, 2000);
      } else {
        showNotification('Failed to cancel booking', 'error');
      }
    } catch (error) {
      console.error('Error cancelling booking:', error);
      showNotification('Failed to cancel booking', 'error');
    }
  }
  
})();
</script>

<style>
.user-location-marker {
  width: 30px;
  height: 30px;
  background: #0d6efd;
  border: 3px solid white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.provider-location-marker {
  width: 30px;
  height: 30px;
  background: #198754;
  border: 3px solid white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.tracking-status-card {
  backdrop-filter: blur(10px);
}

.info-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.booking-detail-item {
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
  text-align: center;
}

.provider-popup {
  min-width: 150px;
}

.location-popup {
  min-width: 150px;
}

.waypoint-popup {
  min-width: 120px;
}

.waypoint-marker {
  width: 20px;
  height: 20px;
  background: #667eea;
  border: 2px solid white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.route-start .waypoint-marker {
  background: #28a745;
}

.route-destination .waypoint-marker {
  background: #dc3545;
}

.route-waypoint .waypoint-marker {
  background: #6c757d;
}

.traffic-info {
  border-radius: 0.5rem;
  font-weight: 500;
}

.tracking-status-card {
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.tracking-status-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.info-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.info-icon:hover {
  transform: scale(1.1);
}

.booking-detail-item {
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.booking-detail-item:hover {
  background: #e9ecef;
  transform: translateY(-2px);
}

/* Real-time pulse animation for provider marker */
@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.7;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.provider-location-marker {
  animation: pulse 2s infinite;
}

/* Route line animation */
.route-line {
  stroke-dasharray: 10, 10;
  animation: dash 1s linear infinite;
}

@keyframes dash {
  to {
    stroke-dashoffset: -20;
  }
}

/* Chat Modal Styles */
.chat-modal {
  border: none;
  border-radius: 1rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  overflow: hidden;
}

.chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 1rem 1.5rem;
}

.chat-avatar {
  position: relative;
}

.online-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 12px;
  height: 12px;
  background: #28a745;
  border: 2px solid white;
  border-radius: 50%;
}

.chat-body {
  height: 400px;
  background: #f8f9fa;
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.chat-message {
  display: flex;
  margin-bottom: 0.75rem;
  animation: fadeInUp 0.3s ease-out;
}

.chat-message.user {
  justify-content: flex-end;
}

.chat-message.provider {
  justify-content: flex-start;
}

.message-bubble {
  max-width: 70%;
  padding: 0.75rem 1rem;
  border-radius: 1rem;
  position: relative;
  word-wrap: break-word;
}

.message-bubble.user {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-bottom-right-radius: 0.25rem;
}

.message-bubble.provider {
  background: white;
  color: #333;
  border: 1px solid #e9ecef;
  border-bottom-left-radius: 0.25rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-meta {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 0.25rem;
}

.message-bubble.user .message-meta {
  text-align: right;
}

.message-bubble.provider .message-meta {
  text-align: left;
}

.chat-typing-indicator {
  padding: 0.5rem 1rem;
  background: white;
  border-top: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.typing-dots {
  display: flex;
  gap: 0.25rem;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: #6c757d;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

.typing-text {
  font-size: 0.875rem;
  color: #6c757d;
  font-style: italic;
}

.chat-footer {
  background: white;
  border: none;
  padding: 1rem 1.5rem;
  border-top: 1px solid #e9ecef;
}

.chat-input {
  border: 1px solid #e9ecef;
  border-radius: 2rem;
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
}

.chat-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.chat-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-start;
}

.chat-actions .btn {
  border-radius: 1rem;
  font-size: 0.8rem;
  padding: 0.25rem 0.75rem;
}

/* Message animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Scrollbar styling for chat messages */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Empty state */
.chat-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #6c757d;
  text-align: center;
  padding: 2rem;
}

.chat-empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

/* Message status indicators */
.message-status {
  font-size: 0.7rem;
  margin-left: 0.5rem;
  opacity: 0.7;
}

.message-status.sent {
  color: #6c757d;
}

.message-status.delivered {
  color: #28a745;
}

.message-status.read {
  color: #007bff;
}

/* Responsive design */
@media (max-width: 768px) {
  .chat-modal .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100% - 1rem);
  }
  
  .chat-body {
    height: 350px;
  }
  
  .message-bubble {
    max-width: 85%;
  }
  
  .chat-actions {
    flex-wrap: wrap;
  }
}
</style>
{% endblock %}

