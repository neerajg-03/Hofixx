{% extends "base.html" %}

{% block title %}Service Request Quotes{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- Service Request Details -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Service Request Details</h5>
        </div>
        <div class="card-body">
          <div id="requestDetails">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Quotes List -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Provider Quotes</h5>
          <div>
            <span class="badge bg-primary" id="quoteCount">0 quotes</span>
            <span class="badge bg-warning" id="timeRemaining">24h remaining</span>
          </div>
        </div>
        <div class="card-body">
          <div id="quotesList">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading quotes...</span>
              </div>
              <p class="mt-3 text-muted">Loading quotes from providers...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Selection Modal -->
<div class="modal fade" id="selectQuoteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Quote Selection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          You are about to select this quote. This will notify the provider and create a booking.
        </div>
        <div id="selectedQuoteDetails"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmQuoteSelection">Select This Quote</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentRequestId = null;
let selectedQuoteId = null;
let socket = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Get request ID from URL
  const pathParts = window.location.pathname.split('/');
  console.log('URL path parts:', pathParts);
  
  // Handle both /service-request/{id}/quotes and /service-request/{id}/quotes/
  if (pathParts[pathParts.length - 1] === 'quotes' || pathParts[pathParts.length - 1] === '') {
    currentRequestId = pathParts[pathParts.length - 2];
  } else {
    currentRequestId = pathParts[pathParts.length - 1];
  }
  
  console.log('Extracted request ID:', currentRequestId);
  
  if (currentRequestId && currentRequestId !== 'quotes') {
    initializeSocket();
    loadServiceRequestDetails();
    loadQuotes();
    startQuoteRefresh();
  } else {
    showError('Invalid request ID: ' + currentRequestId);
  }
});

// Initialize WebSocket connection for real-time updates
function initializeSocket() {
  try {
    socket = io();
    
    socket.on('connect', function() {
      console.log('Connected to server for real-time updates');
      // Join user room for notifications
      const token = localStorage.getItem('token');
      if (token) {
        socket.emit('join_user_room', { token: token });
      }
    });
    
    socket.on('disconnect', function() {
      console.log('Disconnected from server');
    });
    
    // Listen for new quotes
    socket.on('new_quote_received', function(data) {
      console.log('New quote received:', data);
      if (data.request_id === currentRequestId) {
        loadQuotes(); // Refresh the quotes list
        showNewQuoteNotification(data);
      }
    });
    
    // Listen for request cancellations
    socket.on('request_cancelled', function(data) {
      console.log('Request cancelled:', data);
      if (data.request_id === currentRequestId) {
        alert('This service request has been cancelled.');
        window.location.href = '/dashboard/user';
      }
    });
    
    socket.on('connect_error', function(error) {
      console.error('Socket connection error:', error);
    });
    
  } catch (error) {
    console.error('Error initializing socket:', error);
  }
}

// Show notification for new quote
function showNewQuoteNotification(quoteData) {
  // Create a toast notification
  const toast = document.createElement('div');
  toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 1055;';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <i class="fas fa-quote-left me-2"></i>
        New quote received from ${quoteData.provider_name}!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast, {
    autohide: true,
    delay: 5000
  });
  bsToast.show();
  
  // Remove toast element after hiding
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

// Load service request details
async function loadServiceRequestDetails() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      showError('Please login to view service request details');
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
      return;
    }
    
    console.log('Loading service request details for ID:', currentRequestId);
    const response = await fetch(`/api/service-requests/${currentRequestId}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Response data:', data);
    
    if (response.ok) {
      displayRequestDetails(data.service_request);
      updateTimeRemaining(data.service_request.quote_deadline);
    } else {
      if (response.status === 401) {
        showError('Session expired. Please login again.');
        localStorage.removeItem('token');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      } else {
        showError('Failed to load service request details: ' + (data.error || 'Unknown error'));
      }
    }
  } catch (error) {
    console.error('Error loading service request details:', error);
    showError('Error loading service request details: ' + error.message);
  }
}

// Display service request details
function displayRequestDetails(request) {
  const detailsDiv = document.getElementById('requestDetails');
  
  const urgencyColors = {
    'emergency': 'danger',
    'urgent': 'warning',
    'normal': 'primary',
    'flexible': 'secondary'
  };
  
  const urgencyIcons = {
    'emergency': 'ðŸš¨',
    'urgent': 'âš¡',
    'normal': 'ðŸ“‹',
    'flexible': 'ðŸ“…'
  };
  
  detailsDiv.innerHTML = `
    <div class="mb-3">
      <span class="badge bg-${urgencyColors[request.urgency]} mb-2">
        ${urgencyIcons[request.urgency]} ${request.urgency.toUpperCase()}
      </span>
      <h6 class="fw-bold">${request.title}</h6>
      <p class="text-muted small">${request.service_category}</p>
    </div>
    
    <div class="mb-3">
      <h6 class="fw-semibold">Description:</h6>
      <p class="small">${request.description}</p>
    </div>
    
    <div class="mb-3">
      <h6 class="fw-semibold">Location:</h6>
      <p class="small text-muted">
        <i class="fas fa-map-marker-alt me-1"></i>
        ${request.location}
      </p>
    </div>
    
    ${request.preferred_date ? `
    <div class="mb-3">
      <h6 class="fw-semibold">Preferred Time:</h6>
      <p class="small text-muted">
        <i class="fas fa-calendar me-1"></i>
        ${new Date(request.preferred_date).toLocaleDateString()}
        ${request.preferred_time_slot ? ` - ${request.preferred_time_slot}` : ''}
      </p>
    </div>
    ` : ''}
    
    ${request.images && request.images.length > 0 ? `
    <div class="mb-3">
      <h6 class="fw-semibold">Images:</h6>
      <div class="row g-2">
        ${request.images.map(img => `
          <div class="col-6">
            <img src="${img}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;" alt="Work image">
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}
    
    <div class="mb-3">
      <h6 class="fw-semibold">Status:</h6>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-${request.status === 'open' ? 'success' : 'secondary'}">
          ${request.status.replace('_', ' ').toUpperCase()}
        </span>
        ${request.status === 'open' || request.status === 'quotes_received' ? `
        <button class="btn btn-outline-danger btn-sm" onclick="cancelRequest('${request.id}')">
          <i class="fas fa-times me-1"></i>Cancel Request
        </button>
        ` : ''}
      </div>
    </div>
    
    <div class="mb-3">
      <h6 class="fw-semibold">Created:</h6>
      <p class="small text-muted">
        <i class="fas fa-clock me-1"></i>
        ${new Date(request.created_at).toLocaleString()}
      </p>
    </div>
  `;
}

// Load quotes
async function loadQuotes() {
  try {
    const response = await fetch(`/api/service-requests/${currentRequestId}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      displayQuotes(data.quotes);
      updateQuoteCount(data.quotes.length);
    } else {
      showError('Failed to load quotes');
    }
  } catch (error) {
    console.error('Error loading quotes:', error);
    showError('Error loading quotes');
  }
}

// Display quotes
function displayQuotes(quotes) {
  const quotesDiv = document.getElementById('quotesList');
  
  if (quotes.length === 0) {
    quotesDiv.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-quote-left fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No quotes yet</h5>
        <p class="text-muted">Providers are reviewing your request. Quotes will appear here as they come in.</p>
        <div class="mt-3">
          <button class="btn btn-outline-primary" onclick="loadQuotes()">
            <i class="fas fa-refresh me-2"></i>Refresh
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  quotesDiv.innerHTML = quotes.map(quote => `
    <div class="quote-card border rounded p-3 mb-3 hover-lift">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center mb-2">
            <div class="me-3">
              <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div>
              <h6 class="mb-0 fw-bold">${quote.provider_name}</h6>
              <div class="rating">
                <i class="fas fa-star text-warning"></i>
                <span class="ms-1">${quote.provider_rating || 'N/A'}</span>
              </div>
            </div>
          </div>
          
          <div class="mb-2">
            <p class="mb-1 small">${quote.quote_notes || 'No additional notes provided.'}</p>
            ${quote.estimated_duration ? `<p class="mb-0 small text-muted"><i class="fas fa-clock me-1"></i>${quote.estimated_duration}</p>` : ''}
          </div>
          
          <div class="small text-muted">
            <i class="fas fa-calendar me-1"></i>
            Submitted ${new Date(quote.submitted_at).toLocaleString()}
          </div>
        </div>
        
        <div class="col-md-4 text-end">
          <div class="mb-2">
            <h4 class="text-primary mb-0">â‚¹${quote.price}</h4>
            <small class="text-muted">Total cost</small>
          </div>
          
          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-sm" onclick="selectQuote('${quote.id}', ${quote.price}, '${quote.provider_name}')">
              <i class="fas fa-check me-1"></i>Select Quote
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="viewQuoteDetails('${quote.id}')">
              <i class="fas fa-eye me-1"></i>View Details
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// Select quote
function selectQuote(quoteId, price, providerName) {
  selectedQuoteId = quoteId;
  
  document.getElementById('selectedQuoteDetails').innerHTML = `
    <div class="border rounded p-3">
      <h6 class="fw-bold">${providerName}</h6>
      <p class="mb-2">Price: <strong class="text-primary">â‚¹${price}</strong></p>
      <p class="small text-muted">This will create a booking with the selected provider.</p>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('selectQuoteModal'));
  modal.show();
}

// Confirm quote selection
document.getElementById('confirmQuoteSelection').addEventListener('click', async function() {
  if (!selectedQuoteId) return;
  
  try {
    this.disabled = true;
    this.textContent = 'Processing...';
    
    const response = await fetch(`/api/service-requests/${currentRequestId}/select-quote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({
        quote_id: selectedQuoteId
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Success - show success message and redirect to dashboard
      const modal = bootstrap.Modal.getInstance(document.getElementById('selectQuoteModal'));
      if (modal) {
        modal.hide();
      }
      
      // Show success notification
      const successToast = document.createElement('div');
      successToast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
      successToast.style.cssText = 'top: 20px; right: 20px; z-index: 1055;';
      successToast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-check-circle me-2"></i>
            Quote selected successfully! Redirecting to dashboard...
          </div>
        </div>
      `;
      document.body.appendChild(successToast);
      const bsToast = new bootstrap.Toast(successToast, { autohide: true, delay: 3000 });
      bsToast.show();
      
      // Redirect to user dashboard after short delay
      setTimeout(() => {
        window.location.href = '/dashboard/user';
      }, 1500);
    } else {
      alert('Error selecting quote: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error selecting quote:', error);
    alert('Error selecting quote. Please try again.');
  } finally {
    this.disabled = false;
    this.textContent = 'Select This Quote';
  }
});

// Update quote count
function updateQuoteCount(count) {
  document.getElementById('quoteCount').textContent = `${count} quote${count !== 1 ? 's' : ''}`;
}

// Update time remaining
function updateTimeRemaining(deadline) {
  if (!deadline) return;
  
  const deadlineDate = new Date(deadline);
  const now = new Date();
  const diff = deadlineDate - now;
  
  if (diff <= 0) {
    document.getElementById('timeRemaining').textContent = 'Expired';
    document.getElementById('timeRemaining').className = 'badge bg-danger';
    return;
  }
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  
  if (hours > 0) {
    document.getElementById('timeRemaining').textContent = `${hours}h ${minutes}m remaining`;
  } else {
    document.getElementById('timeRemaining').textContent = `${minutes}m remaining`;
  }
  
  if (hours < 2) {
    document.getElementById('timeRemaining').className = 'badge bg-warning';
  }
}

// Start quote refresh
function startQuoteRefresh() {
  // Refresh quotes every 30 seconds
  setInterval(loadQuotes, 30000);
  
  // Update time remaining every minute
  setInterval(() => {
    loadServiceRequestDetails();
  }, 60000);
}

// Cancel service request
async function cancelRequest(requestId) {
  if (!confirm('Are you sure you want to cancel this service request? This will notify all providers who have quoted.')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/service-requests/${requestId}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
      }
    });
    
    const result = await response.json();
    
    if (response.ok) {
      alert('Service request cancelled successfully!');
      // Redirect back to dashboard or reload the page
      window.location.href = '/dashboard/user';
    } else {
      alert('Error cancelling request: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error cancelling request:', error);
    alert('Error cancelling request. Please try again.');
  }
}

// Show error
function showError(message) {
  document.getElementById('quotesList').innerHTML = `
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle me-2"></i>
      ${message}
    </div>
  `;
}
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
.quote-card {
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.quote-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.hover-lift:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}


