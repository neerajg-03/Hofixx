{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <!-- Verification Status Alert -->
  <div id="verificationAlertSection" class="alert alert-warning d-none mb-4">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Verification Required:</strong> 
        <span id="verificationStatusText">Please complete your verification to start receiving orders.</span>
      </div>
      <a href="/verification/shopkeeper" class="btn btn-warning btn-sm">
        <i class="fas fa-store me-2"></i>Complete Verification
      </a>
    </div>
  </div>

  <!-- Verification Pending Alert -->
  <div id="verificationPendingSection" class="alert alert-info d-none mb-4">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <i class="fas fa-clock me-2"></i>
        <strong>Verification Pending:</strong> Your verification request is under review. You will be notified once it's approved.
      </div>
      <a href="/verification/shopkeeper" class="btn btn-info btn-sm">
        <i class="fas fa-eye me-2"></i>View Status
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Shop Dashboard</h2>
    </div>
  </div>

  <!-- Shop Registration/Info Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-store me-2"></i>Shop Information
          </h5>
        </div>
        <div class="card-body" id="shopInfoCard">
          <!-- Shop info will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Products Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-box me-2"></i>Products
          </h5>
          <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus me-1"></i>Add Product
          </button>
        </div>
        <div class="card-body">
          <div id="productsList">
            <!-- Products will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-shopping-bag me-2"></i>Orders
          </h5>
        </div>
        <div class="card-body">
          <div id="ordersList">
            <!-- Orders will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Shop Registration Modal -->
<div class="modal fade" id="registerShopModal" tabindex="-1" aria-labelledby="registerShopModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registerShopModalLabel">Register Your Shop</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="registerShopForm">
          <div class="mb-3">
            <label class="form-label">Shop Name *</label>
            <input type="text" class="form-control" id="shopName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="shopDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Categories * (Select multiple)</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="hardware" id="catHardware">
              <label class="form-check-label" for="catHardware">Hardware</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="electricals" id="catElectricals">
              <label class="form-check-label" for="catElectricals">Electricals</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="plumbing" id="catPlumbing">
              <label class="form-check-label" for="catPlumbing">Plumbing</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="paint" id="catPaint">
              <label class="form-check-label" for="catPaint">Paint & Supplies</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="tools" id="catTools">
              <label class="form-check-label" for="catTools">Tools</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="categories" value="general" id="catGeneral">
              <label class="form-check-label" for="catGeneral">General Store</label>
            </div>
            <small class="text-muted">Select at least one category</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea class="form-control" id="shopAddress" rows="2" required></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Latitude *</label>
              <input type="number" class="form-control" id="shopLat" step="any" required>
              <small class="text-muted">Get from map or use current location</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Longitude *</label>
              <input type="number" class="form-control" id="shopLon" step="any" required>
            </div>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
              <i class="fas fa-map-marker-alt me-1"></i>Use Current Location
            </button>
          </div>
          <div class="mb-3">
            <label class="form-label">Contact Phone *</label>
            <input type="tel" class="form-control" id="shopPhone" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Contact Email</label>
            <input type="email" class="form-control" id="shopEmail">
          </div>
          <div class="mb-3">
            <label class="form-label">Shop Image</label>
            <input type="file" class="form-control" id="shopImage" accept="image/*">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="registerShop()">Register Shop</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Shop Modal -->
<div class="modal fade" id="editShopModal" tabindex="-1" aria-labelledby="editShopModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editShopModalLabel">Edit Shop Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editShopForm">
          <div class="mb-3">
            <label class="form-label">Shop Name *</label>
            <input type="text" class="form-control" id="editShopName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="editShopDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Categories * (Select multiple)</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="hardware" id="editCatHardware">
              <label class="form-check-label" for="editCatHardware">Hardware</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="electricals" id="editCatElectricals">
              <label class="form-check-label" for="editCatElectricals">Electricals</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="plumbing" id="editCatPlumbing">
              <label class="form-check-label" for="editCatPlumbing">Plumbing</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="paint" id="editCatPaint">
              <label class="form-check-label" for="editCatPaint">Paint & Supplies</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="tools" id="editCatTools">
              <label class="form-check-label" for="editCatTools">Tools</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="editCategories" value="general" id="editCatGeneral">
              <label class="form-check-label" for="editCatGeneral">General Store</label>
            </div>
            <small class="text-muted">Select at least one category</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea class="form-control" id="editShopAddress" rows="2" required></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Latitude *</label>
              <input type="number" class="form-control" id="editShopLat" step="any" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Longitude *</label>
              <input type="number" class="form-control" id="editShopLon" step="any" required>
            </div>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocationForEdit()">
              <i class="fas fa-map-marker-alt me-1"></i>Use Current Location
            </button>
          </div>
          <div class="mb-3">
            <label class="form-label">Contact Phone *</label>
            <input type="tel" class="form-control" id="editShopPhone" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Contact Email</label>
            <input type="email" class="form-control" id="editShopEmail">
          </div>
          <div class="mb-3">
            <label class="form-label">Shop Image</label>
            <input type="file" class="form-control" id="editShopImage" accept="image/*">
            <small class="text-muted">Leave empty to keep current image</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateShop()">Update Shop</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addProductForm">
          <div class="mb-3">
            <label class="form-label">Product Name *</label>
            <input type="text" class="form-control" id="productName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="productDescription" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Category *</label>
            <select class="form-select" id="productCategory" required>
              <option value="">Select category</option>
              <option value="wires">Wires & Cables</option>
              <option value="pipes">Pipes & Fittings</option>
              <option value="tools">Tools</option>
              <option value="paint">Paint & Supplies</option>
              <option value="hardware">Hardware</option>
              <option value="electricals">Electrical Components</option>
              <option value="plumbing">Plumbing Components</option>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Price (₹) *</label>
              <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Stock Quantity *</label>
              <input type="number" class="form-control" id="productStock" min="0" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Product Image</label>
            <input type="file" class="form-control" id="productImage" accept="image/*">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addProduct()">Add Product</button>
      </div>
    </div>
  </div>
</div>

<script>
// Get token from localStorage or cookie
function getAuthToken() {
  // Try localStorage first (primary storage)
  const localToken = localStorage.getItem('token');
  if (localToken) return localToken;
  
  // Fallback to cookie
  const cookieToken = getCookie('access_token_cookie');
  if (cookieToken) return cookieToken;
  
  return null;
}

// Load shop info
function loadShopInfo() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }

  fetch('/api/shop/my-shop', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.message === 'No shop found') {
      // Show registration modal
      document.getElementById('shopInfoCard').innerHTML = `
        <p class="text-muted">You haven't registered a shop yet.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerShopModal">
          Register Your Shop
        </button>
      `;
      return;
    }

    // Display shop info
    document.getElementById('shopInfoCard').innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <h5>${data.name}</h5>
          <p class="text-muted">${data.description || 'No description'}</p>
          <p><i class="fas fa-tag me-2"></i>Categories: ${Array.isArray(data.category) ? data.category.join(', ') : data.category}</p>
          <p><i class="fas fa-map-marker-alt me-2"></i>${data.address}</p>
          <p><i class="fas fa-phone me-2"></i>${data.contact_phone}</p>
          ${data.contact_email ? `<p><i class="fas fa-envelope me-2"></i>${data.contact_email}</p>` : ''}
          <p>
            <span class="badge ${data.is_verified ? 'bg-success' : 'bg-warning'} me-2">
              ${data.is_verified ? 'Verified' : 'Pending Verification'}
            </span>
            <span class="badge bg-info">
              <i class="fas fa-star me-1"></i>${data.rating.toFixed(1)}
            </span>
          </p>
          ${!data.is_verified ? `
            <div class="alert alert-warning mt-3">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Note:</strong> Your shop is pending admin verification. It will appear in search results once verified.
            </div>
          ` : ''}
        </div>
        <div class="col-md-4 text-end">
          ${data.image_url ? `<img src="${data.image_url}" class="img-fluid rounded mb-3" style="max-height: 200px;">` : ''}
          <button class="btn btn-outline-primary" onclick="editShop()">Edit Shop</button>
        </div>
      </div>
    `;

    loadProducts();
    loadOrders();
  })
  .catch(error => {
    console.error('Load shop error:', error);
  });
}

// Get current location
function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        document.getElementById('shopLat').value = position.coords.latitude;
        document.getElementById('shopLon').value = position.coords.longitude;
      },
      (error) => {
        alert('Unable to get location. Please enter manually.');
      }
    );
  }
}

// Register shop
function registerShop() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  // Get selected categories
  const selectedCategories = Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value);
  if (selectedCategories.length === 0) {
    alert('Please select at least one category');
    return;
  }
  
  const formData = new FormData();
  formData.append('name', document.getElementById('shopName').value);
  formData.append('description', document.getElementById('shopDescription').value);
  // Append each selected category
  selectedCategories.forEach(cat => {
    formData.append('categories[]', cat);
  });
  formData.append('address', document.getElementById('shopAddress').value);
  formData.append('location_lat', document.getElementById('shopLat').value);
  formData.append('location_lon', document.getElementById('shopLon').value);
  formData.append('contact_phone', document.getElementById('shopPhone').value);
  formData.append('contact_email', document.getElementById('shopEmail').value);
  
  const imageFile = document.getElementById('shopImage').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }

  fetch('/api/shop/register', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      alert('Shop registered successfully!');
      bootstrap.Modal.getInstance(document.getElementById('registerShopModal')).hide();
      loadShopInfo();
    } else {
      alert(data.message || 'Failed to register shop');
    }
  })
  .catch(error => {
    console.error('Register shop error:', error);
    alert('Failed to register shop');
  });
}

// Load products
function loadProducts() {
  const token = getAuthToken();
  if (!token) return;
  
  fetch('/api/shop/products', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.length === 0) {
      document.getElementById('productsList').innerHTML = '<p class="text-muted">No products added yet.</p>';
      return;
    }

    const productsHtml = `
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Category</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(product => `
              <tr>
                <td>
                  ${product.image_url ? 
                    `<img src="${product.image_url}" style="width: 50px; height: 50px; object-fit: cover;" class="rounded">` : 
                    '<i class="fas fa-box text-muted"></i>'
                  }
                </td>
                <td>${product.name}</td>
                <td><span class="badge bg-secondary">${product.category}</span></td>
                <td>₹${product.price}</td>
                <td>${product.stock_quantity}</td>
                <td>
                  <span class="badge ${product.is_available ? 'bg-success' : 'bg-danger'}">
                    ${product.is_available ? 'Available' : 'Out of Stock'}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById('productsList').innerHTML = productsHtml;
  })
  .catch(error => {
    console.error('Load products error:', error);
  });
}

// Add product
function addProduct() {
  const token = getAuthToken();
  if (!token) return;
  
  const formData = new FormData();
  formData.append('name', document.getElementById('productName').value);
  formData.append('description', document.getElementById('productDescription').value);
  formData.append('category', document.getElementById('productCategory').value);
  formData.append('price', document.getElementById('productPrice').value);
  formData.append('stock_quantity', document.getElementById('productStock').value);
  
  const imageFile = document.getElementById('productImage').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }

  fetch('/api/shop/products', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      alert('Product added successfully!');
      bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
      document.getElementById('addProductForm').reset();
      loadProducts();
    } else {
      alert(data.message || 'Failed to add product');
    }
  })
  .catch(error => {
    console.error('Add product error:', error);
    alert('Failed to add product');
  });
}

// Edit product
function editProduct(productId) {
  // Load product details and show edit modal
  // Implementation similar to add product
  alert('Edit product functionality - to be implemented');
}

// Delete product
function deleteProduct(productId) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  const token = getAuthToken();
  if (!token) return;

  fetch(`/api/shop/products/${productId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      alert('Product deleted successfully!');
      loadProducts();
    }
  })
  .catch(error => {
    console.error('Delete product error:', error);
    alert('Failed to delete product');
  });
}

// Load orders
function loadOrders() {
  const token = getAuthToken();
  if (!token) return;
  
  fetch('/api/shop/orders', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.length === 0) {
      document.getElementById('ordersList').innerHTML = '<p class="text-muted">No orders yet.</p>';
      return;
    }

    const ordersHtml = data.map(order => `
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="mb-1">Order #${order.id.substring(0, 8)}</h6>
              <p class="text-muted small mb-0">
                Customer: ${order.user_name}<br>
                Phone: ${order.contact_phone}<br>
                Delivery: ${order.delivery_address}
              </p>
            </div>
            <div class="text-end">
              <span class="badge ${getStatusBadgeClass(order.status)} mb-2">${order.status}</span><br>
              <span class="badge ${order.payment_status === 'paid' ? 'bg-success' : 'bg-warning'}">
                ${order.payment_status}
              </span>
            </div>
          </div>
          <div class="mb-3">
            <strong>Items:</strong>
            <ul class="list-unstyled mt-2">
              ${order.items.map(item => `
                <li>${item.product_name} x ${item.quantity} = ₹${item.total_price}</li>
              `).join('')}
            </ul>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <strong>Total: ₹${order.total_amount}</strong>
            <div>
              <select class="form-select form-select-sm d-inline-block" style="width: auto;" 
                      onchange="updateOrderStatus('${order.id}', this.value)">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    
    document.getElementById('ordersList').innerHTML = ordersHtml;
  })
  .catch(error => {
    console.error('Load orders error:', error);
  });
}

function getStatusBadgeClass(status) {
  const statusClasses = {
    'pending': 'bg-secondary',
    'confirmed': 'bg-info',
    'preparing': 'bg-warning',
    'ready': 'bg-success',
    'assigned': 'bg-primary',
    'out_for_delivery': 'bg-primary',
    'delivered': 'bg-success',
    'cancelled': 'bg-danger'
  };
  return statusClasses[status] || 'bg-secondary';
}

// Update order status
function updateOrderStatus(orderId, newStatus) {
  const token = getAuthToken();
  if (!token) return;
  
  fetch(`/api/shop/orders/${orderId}/status`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ status: newStatus })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      alert('Order status updated!');
      loadOrders();
    }
  })
  .catch(error => {
    console.error('Update order status error:', error);
    alert('Failed to update order status');
  });
}

// Edit shop - load shop data into edit modal
function editShop() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  fetch('/api/shop/my-shop', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.message === 'No shop found') {
      alert('Shop not found');
      return;
    }
    
    // Populate edit form
    document.getElementById('editShopName').value = data.name || '';
    document.getElementById('editShopDescription').value = data.description || '';
    document.getElementById('editShopAddress').value = data.address || '';
    document.getElementById('editShopLat').value = data.location_lat || '';
    document.getElementById('editShopLon').value = data.location_lon || '';
    document.getElementById('editShopPhone').value = data.contact_phone || '';
    document.getElementById('editShopEmail').value = data.contact_email || '';
    
    // Clear all checkboxes first
    document.querySelectorAll('input[name="editCategories"]').forEach(cb => cb.checked = false);
    
    // Check categories that exist in shop data
    const categories = Array.isArray(data.category) ? data.category : [data.category].filter(Boolean);
    categories.forEach(cat => {
      // Map category values to checkbox IDs
      const categoryMap = {
        'hardware': 'editCatHardware',
        'electricals': 'editCatElectricals',
        'plumbing': 'editCatPlumbing',
        'paint': 'editCatPaint',
        'tools': 'editCatTools',
        'general': 'editCatGeneral'
      };
      const checkboxId = categoryMap[cat];
      if (checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
          checkbox.checked = true;
        }
      }
    });
    
    // Show edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editShopModal'));
    editModal.show();
  })
  .catch(error => {
    console.error('Error loading shop for edit:', error);
    alert('Failed to load shop information');
  });
}

// Get current location for edit form
function getCurrentLocationForEdit() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        document.getElementById('editShopLat').value = position.coords.latitude;
        document.getElementById('editShopLon').value = position.coords.longitude;
      },
      (error) => {
        alert('Unable to get location. Please enter manually.');
      }
    );
  }
}

// Update shop
function updateShop() {
  const token = getAuthToken();
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  // Get selected categories
  const selectedCategories = Array.from(document.querySelectorAll('input[name="editCategories"]:checked')).map(cb => cb.value);
  if (selectedCategories.length === 0) {
    alert('Please select at least one category');
    return;
  }
  
  const formData = new FormData();
  formData.append('name', document.getElementById('editShopName').value);
  formData.append('description', document.getElementById('editShopDescription').value);
  // Append each selected category
  selectedCategories.forEach(cat => {
    formData.append('categories[]', cat);
  });
  formData.append('address', document.getElementById('editShopAddress').value);
  formData.append('location_lat', document.getElementById('editShopLat').value);
  formData.append('location_lon', document.getElementById('editShopLon').value);
  formData.append('contact_phone', document.getElementById('editShopPhone').value);
  formData.append('contact_email', document.getElementById('editShopEmail').value);
  
  const imageFile = document.getElementById('editShopImage').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  fetch('/api/shop/update', {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      alert('Shop updated successfully!');
      bootstrap.Modal.getInstance(document.getElementById('editShopModal')).hide();
      loadShopInfo();
    } else {
      alert(data.message || 'Failed to update shop');
    }
  })
  .catch(error => {
    console.error('Update shop error:', error);
    alert('Failed to update shop');
  });
}

// Helper function
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

// Load on page load
// Check verification status
async function checkVerificationStatus() {
  const token = getAuthToken();
  if (!token) return;
  
  try {
    const res = await fetch('/api/verification/shopkeeper/status', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (res.ok) {
      const data = await res.json();
      // Check if verification_status exists and is not null/undefined
      let status = data.verification_status;
      if (!status || status === null || status === 'not_started') {
        status = 'not_started';
      }
      
      if (status === 'not_started' || status === 'rejected') {
        document.getElementById('verificationAlertSection').classList.remove('d-none');
        document.getElementById('verificationPendingSection').classList.add('d-none');
        if (status === 'rejected' && data.admin_remarks) {
          document.getElementById('verificationStatusText').textContent = 
            `Your verification was rejected. ${data.admin_remarks}. Please update and resubmit.`;
        } else {
          document.getElementById('verificationStatusText').textContent = 
            'Please complete your verification to start receiving orders.';
        }
      } else if (status === 'pending') {
        document.getElementById('verificationPendingSection').classList.remove('d-none');
        document.getElementById('verificationAlertSection').classList.add('d-none');
      } else if (status === 'verified') {
        // Hide both alerts, verification is complete
        document.getElementById('verificationAlertSection').classList.add('d-none');
        document.getElementById('verificationPendingSection').classList.add('d-none');
      }
    } else if (res.status === 404) {
      // No verification started yet
      document.getElementById('verificationAlertSection').classList.remove('d-none');
      document.getElementById('verificationPendingSection').classList.add('d-none');
      document.getElementById('verificationStatusText').textContent = 
        'Please complete your verification to start receiving orders.';
    }
  } catch (error) {
    console.log('Error checking verification status:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  checkVerificationStatus();
  loadShopInfo();
});
</script>
{% endblock %}

